<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Heart Horror: Undertale Edition</title>
<style>
body{margin:0;background:black;overflow:hidden;font-family:'Courier New',monospace;color:white;}
canvas{display:block;margin:auto;background:#111;}
#ui{position:absolute;top:10px;left:10px;width:100%;color:white;font-size:16px;}
.bar-container{background:#333;border:1px solid #fff;width:200px;height:20px;margin-bottom:5px;}
.bar{height:100%;background:red;width:100%;}
#burstBar{background:cyan;width:0%;transition:width 0.2s;}
#messages{position:absolute;bottom:10px;left:10px;width:90%;font-size:18px;color:lime;white-space:pre-line;}
#keybindsMenu{position:absolute;top:50px;left:10px;background:#222;padding:10px;display:none;border:1px solid #fff;}
#keybindsMenu input{width:40px;}
button{margin-top:5px;}
</style>
</head>
<body>
<canvas id="gameCanvas" width="800" height="600"></canvas>

<div id="ui">
  <div>HP: <span id="hpText">100</span></div>
  <div class="bar-container"><div id="hpBar" class="bar"></div></div>
  <div>Burst: <span id="burstText">Ready</span></div>
  <div class="bar-container"><div id="burstBar"></div></div>
  <div>Night: <span id="nightText">1</span></div>
  <button id="keybindButton">Change Keybinds</button>
</div>

<div id="keybindsMenu">
  <div>Move Up: <input id="keyUp" maxlength="1"></div>
  <div>Move Down: <input id="keyDown" maxlength="1"></div>
  <div>Move Left: <input id="keyLeft" maxlength="1"></div>
  <div>Move Right: <input id="keyRight" maxlength="1"></div>
  <div>Burst: <input id="keyBurst" maxlength="1"></div>
  <button id="saveKeys">Save</button>
  <button id="closeKeys">Close</button>
</div>

<div id="messages">Welcome to Heart Horror: Undertale Edition...</div>

<script>
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
let width=canvas.width,height=canvas.height;

// --- Player ---
let player={x:width/2,y:height-100,size:20,hp:100,speed:4,burstReady:true,burstTimer:0};
let burstActive=false,BURST_DURATION=180,BURST_COOLDOWN=300;

// --- Key Management ---
let keys={};
let keybinds = JSON.parse(localStorage.getItem('keybinds'))||{up:'W',down:'S',left:'A',right:'D',burst:'Q'};
document.getElementById('keyUp').value=keybinds.up;
document.getElementById('keyDown').value=keybinds.down;
document.getElementById('keyLeft').value=keybinds.left;
document.getElementById('keyRight').value=keybinds.right;
document.getElementById('keyBurst').value=keybinds.burst;

document.addEventListener('keydown',e=>keys[e.key.toUpperCase()]=true);
document.addEventListener('keyup',e=>keys[e.key.toUpperCase()]=false);

document.getElementById('keybindButton').addEventListener('click',()=>{document.getElementById('keybindsMenu').style.display='block';});
document.getElementById('closeKeys').addEventListener('click',()=>{document.getElementById('keybindsMenu').style.display='none';});
document.getElementById('saveKeys').addEventListener('click',()=>{
  keybinds.up=document.getElementById('keyUp').value.toUpperCase();
  keybinds.down=document.getElementById('keyDown').value.toUpperCase();
  keybinds.left=document.getElementById('keyLeft').value.toUpperCase();
  keybinds.right=document.getElementById('keyRight').value.toUpperCase();
  keybinds.burst=document.getElementById('keyBurst').value.toUpperCase();
  localStorage.setItem('keybinds',JSON.stringify(keybinds));
  document.getElementById('keybindsMenu').style.display='none';
});

// --- Night & Messages ---
let night=1;
let messages=[];
function addMessage(msg){messages.push(msg);if(messages.length>5)messages.shift();}

// --- Attack Box ---
let attackBox={x:width/2-100,y:height-200,width:200,height:150};

// --- Enemies/Bosses ---
let enemies=[];
let bosses=[
  {name:"Shadow Phantom",color:"purple",size:20,speed:1.5,pattern:"down",hp:20},
  {name:"Bone Horror",color:"white",size:25,speed:2,pattern:"zigzag",hp:25},
  {name:"Creeper Face",color:"green",size:30,speed:1.2,pattern:"circle",hp:30},
  {name:"Night Terror",color:"red",size:35,speed:2.5,pattern:"fast",hp:35},
  {name:"Ghost Howler",color:"blue",size:28,speed:1.8,pattern:"zigzag",hp:28},
  {name:"Fright Maw",color:"orange",size:32,speed:2,pattern:"circle",hp:32},
  {name:"Specter King",color:"gold",size:40,speed:2,pattern:"circle",hp:40},
  {name:"The Wailer",color:"magenta",size:25,speed:3,pattern:"zigzag",hp:30},
  {name:"Darkwing",color:"darkblue",size:30,speed:2.2,pattern:"fast",hp:35},
  {name:"Soul Leech",color:"pink",size:28,speed:2,pattern:"zigzag",hp:32},
  {name:"Hollow Shade",color:"grey",size:35,speed:2.5,pattern:"circle",hp:38},
  {name:"Frightshade",color:"violet",size:25,speed:2.5,pattern:"down",hp:30},
  {name:"Nightmare Eye",color:"lightblue",size:32,speed:3,pattern:"fast",hp:40},
  {name:"Bone Fiend",color:"white",size:28,speed:2.5,pattern:"zigzag",hp:35},
  {name:"Spirit Reaper",color:"cyan",size:30,speed:2.8,pattern:"circle",hp:38},
  {name:"Void Howler",color:"black",size:35,speed:3,pattern:"fast",hp:40},
  {name:"Phantom Knight",color:"silver",size:32,speed:2.5,pattern:"zigzag",hp:42},
  {name:"Eclipse",color:"darkred",size:40,speed:2.8,pattern:"circle",hp:45},
  {name:"Soul Eater",color:"darkgreen",size:38,speed:3,pattern:"fast",hp:48},
  {name:"Radiant Horror",color:"gold",size:50,speed:2.5,pattern:"radiance",hp:100} // final boss
];

function spawnEnemies(n){
  enemies=[];
  for(let i=0;i<n;i++){
    let boss=bosses[(night+i-1)%bosses.length];
    enemies.push({
      x:Math.random()*(width-40)+20,
      y:-Math.random()*300,
      size:boss.size,
      speed:boss.speed,
      color:boss.color,
      pattern:boss.pattern,
      name:boss.name,
      hp:boss.hp
    });
  }
}
spawnEnemies(1);

// --- Bullets ---
let bullets=[];
function spawnBullet(x,y,angle,speed,color){bullets.push({x,y,angle,speed,color});}

// --- Update ---
function update(){
  // Movement
  if(keys[keybinds.up])player.y-=player.speed;
  if(keys[keybinds.down])player.y+=player.speed;
  if(keys[keybinds.left])player.x-=player.speed;
  if(keys[keybinds.right])player.x+=player.speed;
  player.x=Math.max(attackBox.x,Math.min(attackBox.x+attackBox.width,player.x));
  player.y=Math.max(attackBox.y,Math.min(attackBox.y+attackBox.height,player.y));

  // Burst
  if(keys[keybinds.burst] && player.burstReady){
    burstActive=true;
    player.burstReady=false;
    player.burstTimer=BURST_DURATION;
    bullets=[];
    addMessage("Burst activated! All attacks cleared!");
  }
  if(burstActive){
    player.burstTimer--;
    if(player.burstTimer<=0) burstActive=false;
  } else if(!player.burstReady){
    player.burstTimer++;
    if(player.burstTimer>=BURST_COOLDOWN){player.burstReady=true;player.burstTimer=BURST_COOLDOWN;}
  }

  // Enemy behavior
  enemies.forEach(e=>{
    if(e.pattern=="down") e.y+=e.speed;
    else if(e.pattern=="zigzag"){e.y+=e.speed;e.x+=Math.sin(e.y/20)*3;}
    else if(e.pattern=="circle"){e.x+=Math.sin(e.y/30)*4;e.y+=e.speed;}
    else if(e.pattern=="fast") e.y+=e.speed*1.5;
    else if(e.pattern=="radiance"){
      // Radiance style bullets
      for(let i=0;i<6;i++){
        spawnBullet(e.x,e.y,i*Math.PI/3+performance.now()/500,3,'gold');
      }
      e.y+=e.speed*0.2;
    }

    // Collision with attack box
    bullets.forEach((b,j)=>{
      if(b.x>attackBox.x && b.x<attackBox.x+attackBox.width && b.y>attackBox.y && b.y<attackBox.y+attackBox.height && !burstActive){
        player.hp-=0.5;
        bullets.splice(j,1);
        addMessage("Hit by attack!");
      }
      b.x+=Math.cos(b.angle)*b.speed;
      b.y+=Math.sin(b.angle)*b.speed;
    });
  });

  // Remove off-screen bullets
  bullets=bullets.filter(b=>b.x>0 && b.x<width && b.y>0 && b.y<height);

  // Night progression
  if(enemies.length===0){night++;spawnEnemies(1);addMessage("Night "+night+" begins...");}

  // UI updates
  document.getElementById('hpText').innerText=Math.floor(player.hp);
  document.getElementById('hpBar').style.width=(player.hp/100*100)+'%';
  document.getElementById('burstText').innerText=player.burstReady?'Ready':'Charging';
  document.getElementById('burstBar').style.width=(burstActive?100:player.burstTimer/BURST_COOLDOWN*100)+'%';
  document.getElementById('nightText').innerText=night;

  if(player.hp<=0){addMessage("You have been consumed...");alert("Game Over on Night "+night);window.location.reload();}
}

// --- Render ---
function render(){
  ctx.clearRect(0,0,width,height);
  // Attack box
  ctx.strokeStyle='white';
  ctx.lineWidth=2;
  ctx.strokeRect(attackBox.x,attackBox.y,attackBox.width,attackBox.height);

  // Player heart
  ctx.fillStyle='red';
  ctx.beginPath();
  ctx.arc(player.x,player.y,player.size,0,Math.PI*2);
  ctx.fill();

  if(burstActive){
    ctx.strokeStyle='cyan';ctx.lineWidth=4;
    ctx.beginPath();
    ctx.arc(player.x,player.y,player.size+10,0,Math.PI*2);
    ctx.stroke();
  }

  // Bullets
  bullets.forEach(b=>{
    ctx.fillStyle=b.color;
    ctx.beginPath();
    ctx.arc(b.x,b.y,6,0,Math.PI*2);
    ctx.fill();
  });

  // Enemies
  enemies.forEach(e=>{
    ctx.fillStyle=e.color;
    ctx.beginPath();
    ctx.arc(e.x,e.y,e.size,0,Math.PI*2);
    ctx.fill();
  });

  document.getElementById('messages').innerText=messages.join('\n');
}

// --- Loop ---
function loop(){update();render();requestAnimationFrame(loop);}
loop();
</script>
</body>
</html>

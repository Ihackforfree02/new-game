<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Pixel Heart Boss Rush</title>
<style>
  body { margin:0; background:black; color:white; font-family: monospace; overflow:hidden; }
  canvas { display:block; margin:0 auto; background:#111; image-rendering: pixelated; }
  #colorPicker { position:absolute; top:10px; left:50%; transform:translateX(-50%); z-index:10; }
</style>
</head>
<body>
<select id="colorPicker">
  <option value="#ff0000">Red</option>
  <option value="#00ff00">Green</option>
  <option value="#0000ff">Blue</option>
  <option value="#ffff00">Yellow</option>
  <option value="#ff00ff">Magenta</option>
</select>
<canvas id="gameCanvas" width="800" height="600"></canvas>

<script>
const canvas = document.getElementById("gameCanvas");
const ctx = canvas.getContext("2d");

// ---------------------- Player ----------------------
let player = {
    x: canvas.width/2 - 10,
    y: canvas.height - 60,
    width: 20,
    height: 20,
    color: "#ff0000",
    hp: 100,
    maxHp: 100,
    speed: 5,
    burst: 100,
    burstActive: false
};

// ---------------------- Input ----------------------
let keys = {};
document.addEventListener("keydown", (e) => { keys[e.key.toLowerCase()] = true; });
document.addEventListener("keyup", (e) => { keys[e.key.toLowerCase()] = false; });
document.getElementById("colorPicker").addEventListener("change", (e)=>{ player.color=e.target.value; });

// ---------------------- Bullets ----------------------
let playerBullets = [];
let bossBullets = [];

// ---------------------- Bosses ----------------------
let currentBoss = 0;
let inBattle = false;
let dialogue = "";

class Boss {
    constructor(name, color, maxHp, attacks, spriteDrawFunc) {
        this.name = name;
        this.color = color;
        this.hp = maxHp;
        this.maxHp = maxHp;
        this.attacks = attacks;
        this.spriteDraw = spriteDrawFunc;
        this.attackCooldown = 0;
        this.phase = 0;
    }
}

let bosses = [
    new Boss("Spikey","#ff00ff",50, ["spread","homing"], function(ctx,x,y){ctx.fillStyle=this.color; ctx.fillRect(x,y,40,40);}),
    new Boss("Glowtail","#00ffff",60, ["zigzag","stopMove"], function(ctx,x,y){ctx.fillStyle=this.color; ctx.beginPath(); ctx.arc(x+20,y+20,20,0,Math.PI*2); ctx.fill();}),
    new Boss("Lumin","#ffff00",70, ["spiral","homing"], function(ctx,x,y){ctx.fillStyle=this.color; ctx.fillRect(x+10,y,20,40); ctx.fillRect(x,y+10,40,20);}),
    new Boss("Shadow","#222222",80, ["stopMove","spread"], function(ctx,x,y){ctx.fillStyle=this.color; ctx.fillRect(x,y,40,40); ctx.fillStyle="#555"; ctx.fillRect(x+5,y+5,30,30);}),
    new Boss("Radiance","#ffffff",150, ["spiral","homing","spread"], function(ctx,x,y){ctx.fillStyle=this.color; for(let i=0;i<8;i++){ ctx.beginPath(); ctx.moveTo(x+20,y+20); ctx.lineTo(x+20+30*Math.cos(i*Math.PI/4),y+20+30*Math.sin(i*Math.PI/4)); ctx.strokeStyle=this.color; ctx.stroke();}})
];

let boss = bosses[currentBoss];
let bossX = canvas.width/2 - 20;
let bossY = 100;

// ---------------------- Player Shooting ----------------------
function shoot() {
    playerBullets.push({x:player.x+player.width/2-5, y:player.y, width:10, height:10, speed:7});
}

// ---------------------- Player Burst ----------------------
function activateBurst() {
    if(player.burst>=100 && !player.burstActive){
        player.burstActive=true;
        setTimeout(()=>{player.burstActive=false; player.burst=0;},3000);
    }
}

// ---------------------- Boss Attacks ----------------------
function bossAttack(){
    if(boss.attackCooldown<=0){
        let attackType = boss.attacks[Math.floor(Math.random()*boss.attacks.length)];
        switch(attackType){
            case "spread":
                for(let i=-2;i<=2;i++){ bossBullets.push({x:bossX+20,y:bossY+40,width:10,height:10,vx:i*2,vy:3,color:boss.color}); }
                break;
            case "homing":
                let angle = Math.atan2(player.y-bossY,player.x-bossX);
                bossBullets.push({x:bossX+20,y:bossY+20,width:10,height:10,vx:4*Math.cos(angle),vy:4*Math.sin(angle),color:boss.color});
                break;
            case "spiral":
                for(let i=0;i<8;i++){
                    bossBullets.push({x:bossX+20,y:bossY+20,width:10,height:10,vx:3*Math.cos(i*Math.PI/4 + Date.now()/500),vy:3*Math.sin(i*Math.PI/4 + Date.now()/500),color:boss.color});
                }
                break;
            case "stopMove":
                // Stop bullets briefly
                bossBullets.forEach(b=>{b.vx=0;b.vy=0;});
                setTimeout(()=>{bossBullets.forEach(b=>{b.vx=(Math.random()*4-2); b.vy=3;});},2000);
                break;
        }
        boss.attackCooldown=60;
    } else boss.attackCooldown--;
}

// ---------------------- Update ----------------------
function update(){
    // Player movement
    if(keys["arrowleft"] && player.x>0) player.x-=player.speed;
    if(keys["arrowright"] && player.x+player.width<canvas.width) player.x+=player.speed;
    if(keys["arrowup"] && player.y>0) player.y-=player.speed;
    if(keys["arrowdown"] && player.y+player.height<canvas.height) player.y+=player.speed;
    if(keys[" "]) shoot();
    if(keys["q"]) activateBurst();

    // Update bullets
    playerBullets.forEach((b,i)=> { b.y-=b.speed; if(b.y<0) playerBullets.splice(i,1); });

    bossAttack();

    bossBullets.forEach((b,i)=>{
        if(!player.burstActive){
            b.x+=b.vx; b.y+=b.vy;
            if(b.x<0 || b.x>canvas.width || b.y<0 || b.y>canvas.height) bossBullets.splice(i,1);
            if(b.x<player.x+player.width && b.x+b.width>player.x && b.y<player.y+player.height && b.y+b.height>player.y){
                player.hp-=1;
                bossBullets.splice(i,1);
            }
        }
    });

    // Check collision with boss
    playerBullets.forEach((b,i)=>{
        if(b.x<bossX+40 && b.x+10>bossX && b.y<bossY+40 && b.y+10>bossY){
            boss.hp-=1;
            playerBullets.splice(i,1);
        }
    });

    // Burst charge
    if(player.burst<100 && !player.burstActive) player.burst+=0.5;

    // Boss defeated
    if(boss.hp<=0){
        currentBoss++;
        if(currentBoss>=bosses.length){ dialogue="YOU WIN!"; inBattle=false; return;}
        boss=bosses[currentBoss];
        boss.hp=boss.maxHp;
        bossX=canvas.width/2-20;
        bossY=100;
    }
}

// ---------------------- Draw ----------------------
function draw(){
    ctx.clearRect(0,0,canvas.width,canvas.height);
    // Player
    ctx.fillStyle=player.color;
    ctx.fillRect(player.x,player.y,player.width,player.height);

    // Player bullets
    playerBullets.forEach(b=>{ctx.fillStyle="#fff";ctx.fillRect(b.x,b.y,b.width,b.height);});
    // Boss bullets
    bossBullets.forEach(b=>{ctx.fillStyle=b.color;ctx.fillRect(b.x,b.y,b.width,b.height);});

    // Player HP
    ctx.fillStyle="red";
    ctx.fillRect(20,20,200,20);
    ctx.fillStyle="green";
    ctx.fillRect(20,20,200*(player.hp/player.maxHp),20);
    ctx.strokeStyle="white"; ctx.strokeRect(20,20,200,20);

    // Burst bar
    ctx.fillStyle="yellow";
    ctx.fillRect(20,50,200*(player.burst/100),10);
    ctx.strokeStyle="white"; ctx.strokeRect(20,50,200,10);

    // Boss HP
    ctx.fillStyle="red";
    ctx.fillRect(canvas.width-220,20,200,20);
    ctx.fillStyle="cyan";
    ctx.fillRect(canvas.width-220,20,200*(boss.hp/boss.maxHp),20);
    ctx.strokeStyle="white"; ctx.strokeRect(canvas.width-220,20,200,20);
    ctx.fillStyle="white";
    ctx.fillText(boss.name, canvas.width-220,15);

    // Boss sprite
    boss.spriteDraw(ctx,bossX,bossY);

    // Dialogue
    ctx.fillStyle="white";
    ctx.fillText(dialogue,20,canvas.height-30);
}

// ---------------------- Game Loop ----------------------
function loop(){
    update();
    draw();
    if(player.hp>0 && currentBoss<bosses.length) requestAnimationFrame(loop);
    else if(player.hp<=0) { ctx.fillStyle="white"; ctx.fillText("GAME OVER", canvas.width/2-50, canvas.height/2);}
}
loop();
</script>
</body>
</html>

<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover, user-scalable=no"/>
<title>Undertale Gold — Stable 960x720 (10 bosses, unique ACT, mercy after 6, admin boss)</title>
<style>
:root{
  --fg:#ffd166; --hp:#ff5e6b; --emerald:#7affb7;
  --ui:#0b0b0b; --line:#262626;
  --bub-bg:#0b0b0b; --bub-border:#ffd166; --bub-fg:#ffd166;
}
html,body{height:100%;margin:0;background:#000;color:var(--fg);font-family:ui-monospace,monospace;image-rendering:pixelated;overflow:hidden;touch-action:manipulation}
*{box-sizing:border-box}
#stage{position:fixed;left:50%;top:50%;transform-origin:top left;will-change:transform}
#wrap{position:relative;width:960px;height:720px}
canvas{display:block;width:960px;height:720px;background:#070606;border:4px solid #0a0a0f}

/* HUD */
#bossHUD{position:absolute;left:20px;top:18px;display:flex;flex-direction:column;gap:6px;z-index:3}
#bossName{font-size:14px;letter-spacing:.5px}
#bossHP{height:10px;width:440px;background:#141414;border:1px solid #383838;position:relative}
#bossHPFill{position:absolute;left:0;top:0;bottom:0;background:var(--hp);width:100%}
#bossHPVal{font-size:12px;margin-top:2px}
#playerHUD{position:absolute;right:20px;top:18px;display:flex;flex-direction:column;gap:6px;align-items:flex-end;z-index:3}
#playerNameLabel{font-size:14px;color:#9be7c0;letter-spacing:.5px}
#pHP{height:10px;width:260px;background:#141414;border:1px solid #383838;position:relative}
#pHPFill{position:absolute;left:0;top:0;bottom:0;background:var(--emerald);width:100%}
#pHPVal{font-size:12px;margin-top:2px}

/* Arena (canvas draws the box) */
#box{position:absolute;left:240px;top:420px;width:480px;height:180px;border:3px solid transparent;display:none;z-index:1}

/* Dialogue */
#bubble{position:absolute;left:50%;bottom:148px;transform:translateX(-50%);max-width:905px;min-height:124px;display:block;z-index:4}
.bub{background:var(--bub-bg);border:2px solid var(--bub-border);padding:16px 20px;color:var(--bub-fg)}
#bubbleText{white-space:pre-line;line-height:1.6;font-size:16px}
#submenuHint{font-size:12px;opacity:.85;margin-top:6px}

/* Bottom UI */
#uiBar{position:absolute;left:50%;bottom:8px;transform:translateX(-50%);width:920px;height:116px;background:var(--ui);border:2px solid var(--line);display:flex;align-items:center;justify-content:space-between;padding:0 18px;z-index:3;transition:opacity .16s ease, transform .16s ease}
#uiBar.hidden{opacity:0;pointer-events:none;transform:translate(-50%,6px)}
.uiMenu{display:flex;gap:36px;flex-wrap:wrap}
.uiBtn{display:flex;align-items:center;gap:10px;cursor:pointer}
.uiKey{width:20px;height:20px;border:2px solid #fff;display:flex;align-items:center;justify-content:center;font-weight:700}
.uiLabel{font-size:20px;letter-spacing:1px}
#uiCenter{font-size:14px}

/* Tips + toast */
#tips{position:absolute;left:50%;top:84px;transform:translateX(-50%);font-size:12px;color:#c8c8c8;opacity:.85}
#toast{position:absolute;left:50%;top:120px;transform:translateX(-50%);background:#111;border:1px solid #fff;color:#ffd166;padding:6px 10px;font-size:12px;opacity:0;transition:opacity .25s;z-index:5}
#toast.show{opacity:1}

/* Admin overlay (lightweight) */
#admin{position:absolute;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.65);z-index:8}
#adminPanel{background:#0e0e0e;border:2px solid #fff;padding:14px 16px;width:900px;color:#ffd166;max-width:95%}
.adRow{display:flex;flex-wrap:wrap;gap:10px;margin:8px 0}
.adBtn{padding:6px 10px;border:1px solid #fff;background:transparent;color:#ffd166;cursor:pointer}
.adSelect,.adInput{background:#111;color:#ffd166;border:1px solid #333;padding:6px 8px}
#preview{width:180px;height:180px;border:1px solid #333;background:#0b0b0b}

@media (max-width:480px){
  #bossName,#bossHPVal,#playerNameLabel,#pHPVal,#tips{font-size:12px}
  #bubbleText{font-size:14px}
  .uiLabel{font-size:18px}
}
</style>
</head>
<body>
<div id="stage"><div id="wrap">
  <div id="bossHUD">
    <div id="bossName">Solar Fang</div>
    <div id="bossHP"><div id="bossHPFill"></div></div>
    <div id="bossHPVal">000/000</div>
  </div>
  <div id="playerHUD">
    <div id="playerNameLabel">Traveler</div>
    <div id="pHP"><div id="pHPFill"></div></div>
    <div id="pHPVal">50/50</div>
  </div>

  <canvas id="cv" width="960" height="720" tabindex="0"></canvas>
  <div id="box"></div>

  <div id="bubble"><div class="bub">
    <div id="bubbleText"></div>
    <div id="submenuHint" style="display:none">Choose: 1-4 • Back: X/Backspace/Esc • Confirm: Z/Enter/Space</div>
  </div></div>

  <div id="uiBar">
    <div class="uiMenu" id="uiMenu">
      <div class="uiBtn" data-act="FIGHT"><div class="uiKey">Z</div><div class="uiLabel">FIGHT</div></div>
      <div class="uiBtn" data-act="ACT"><div class="uiKey">A</div><div class="uiLabel">ACT</div></div>
      <div class="uiBtn" data-act="ITEM"><div class="uiKey">I</div><div class="uiLabel">ITEM</div></div>
      <div class="uiBtn" data-act="MERCY"><div class="uiKey">M</div><div class="uiLabel">MERCY</div></div>
    </div>
    <div id="uiCenter">Your turn.</div>
  </div>

  <div id="tips">Move: Arrow/WASD — Confirm: Z/Enter/Space — Back: X/Backspace/Esc — Type “67” three times for Admin</div>
  <div id="toast">Admin opened</div>

  <div id="admin">
    <div id="adminPanel">
      <div class="adRow">
        <select id="adBoss" class="adSelect"></select>
        <button id="adClose" class="adBtn">Close</button>
        <button id="adEndAtk" class="adBtn">End attack</button>
        <button id="adAutoWin" class="adBtn">Auto win</button>
        <button id="adAutoSpare" class="adBtn">Auto spare</button>
        <button id="adReset" class="adBtn">Reset save</button>
      </div>
      <canvas id="preview" width="180" height="180"></canvas>
    </div>
  </div>
</div></div>

<script>
"use strict";

/* Centering/scaling (stable) */
(function initScale(){
  if(window.__scaled) return; window.__scaled=true;
  const stage=document.getElementById('stage'); let need=false;
  function apply(){
    const sw=960, sh=720;
    const vv=window.visualViewport;
    const vw=vv?vv.width:innerWidth, vh=vv?vv.height:innerHeight;
    const s=Math.min(vw/sw, vh/sh) || 1;
    stage.style.transform=`translate(-50%, -50%) scale(${Math.max(0.2, s)})`;
    need=false;
  }
  const sched=()=>{ if(!need){ need=true; requestAnimationFrame(apply); } };
  addEventListener('resize',sched,{passive:true});
  addEventListener('orientationchange',sched,{passive:true});
  if(window.visualViewport){
    visualViewport.addEventListener('resize',sched,{passive:true});
    visualViewport.addEventListener('scroll',sched,{passive:true});
  }
  apply();
})();

/* Keep focus like unblocked */
(function harden(){
  const cv=document.getElementById('cv');
  addEventListener('contextmenu',e=>e.preventDefault());
  addEventListener('mousedown',()=>cv.focus());
  addEventListener('touchstart',()=>cv.focus(),{passive:true});
  addEventListener('keydown',e=>{
    if(['ArrowUp','ArrowDown','ArrowLeft','ArrowRight',' '].includes(e.key)) e.preventDefault();
    if(e.key==='Backspace' && !['INPUT','TEXTAREA'].includes((e.target.tagName||''))) e.preventDefault();
  },{passive:false});
})();

/* Elements */
const cv=document.getElementById('cv'), ctx=cv.getContext('2d',{alpha:false,desynchronized:true});
const bossNameEl=document.getElementById('bossName'), bossHPFill=document.getElementById('bossHPFill'), bossHPVal=document.getElementById('bossHPVal');
const pHPFill=document.getElementById('pHPFill'), pHPVal=document.getElementById('pHPVal'), nameLabel=document.getElementById('playerNameLabel');
const bubble=document.getElementById('bubble'), bubbleText=document.getElementById('bubbleText'), submenuHint=document.getElementById('submenuHint');
const uiMenu=document.getElementById('uiMenu'), uiBar=document.getElementById('uiBar'), uiCenter=document.getElementById('uiCenter');
const boxEl=document.getElementById('box'), toastEl=document.getElementById('toast');
const admin=document.getElementById('admin'), adBoss=document.getElementById('adBoss'), adClose=document.getElementById('adClose');
const adEndAtk=document.getElementById('adEndAtk'), adAutoWin=document.getElementById('adAutoWin'), adAutoSpare=document.getElementById('adAutoSpare'), adReset=document.getElementById('adReset');
const prevCanvas=document.getElementById('preview'), prevCtx=prevCanvas.getContext('2d',{desynchronized:true});

/* Save */
const SAVE_KEY='ug_stable_10_v2';
const loadSave=()=>{ try{return JSON.parse(localStorage.getItem(SAVE_KEY))||{};}catch{return {}} };
const writeSave=(d)=>{ try{localStorage.setItem(SAVE_KEY,JSON.stringify(d));}catch{} };
let SAVE=loadSave();

/* Arena/player */
const ARENA={x:240,y:420,w:480,h:180};
const HEART={x:ARENA.x+ARENA.w/2,y:ARENA.y+ARENA.h/2,r:4,sp:320,i:0,hp:Math.max(1,SAVE.hp||50),hpMax:Math.max(1,SAVE.hp||50),_px:0,_py:0,_pdt:1/60};
let username=(SAVE.username||'Traveler').slice(0,16); nameLabel.textContent=username;

/* Difficulty */
const DIFFS={Normal:{spd:1.10,rate:1.10,dmg:1.40,lead:0.08},Hard:{spd:1.28,rate:1.28,dmg:1.75,lead:0.10},Insane:{spd:1.46,rate:1.40,dmg:2.10,lead:0.12}};
let DIFF=DIFFS[SAVE.difficulty||'Normal'];

/* State */
const TURN={PLAYER:'player',ENEMY:'enemy',VICTORY:'victory',DEFEAT:'defeat',TRANS:'transition'};
let time=0, turn=TURN.PLAYER, showArena=false, attack=null, bullets=[], mode='main';
let bossIndex=(typeof SAVE.bossIndex==='number')?SAVE.bossIndex:0;
let BOSS=null, attackSeq=null, attackIx=0, damagePopup=null, turnCount=0;
let paused=false;

/* Routes + lore */
const routeState={fight:SAVE.fight||0, act:SAVE.act||0, mercy:SAVE.mercy||0};
const loreUnlocked=SAVE.loreUnlocked||{};
const saveProgress=()=>writeSave({bossIndex, hp:HEART.hpMax, username, fight:routeState.fight, act:routeState.act, mercy:routeState.mercy, difficulty: SAVE.difficulty||'Normal', loreUnlocked});
const unlockLore=(k)=>{loreUnlocked[k]=true; saveProgress();};

/* Inventory */
let inventory=SAVE.inventory || [{id:'dew',name:'Dew Petal',desc:'+12 HP',type:'heal',amount:12,count:2}];
const itemsList=()=> inventory.length? inventory.map((it,i)=>` ${i+1}. ${it.name} (${it.count}) — ${it.desc}`).join('\n') : "No items.";
function useItem(i){
  const it=inventory[i]; if(!it||it.count<=0) return "Empty.";
  if(it.type==='heal'){ HEART.hp=Math.min(HEART.hpMax, HEART.hp+(it.amount||10)); updateHP(); it.count--; if(it.count<=0) inventory.splice(i,1); SAVE.inventory=inventory; writeSave(SAVE); return `You used ${it.name}. +${it.amount} HP`; }
  return "Nothing happened.";
}

/* UI helpers */
const say=(t,h=false)=>{bubble.style.display='block'; bubbleText.textContent=t; submenuHint.style.display=h?'block':'none';};
const hideSay=()=>{bubble.style.display='none'; submenuHint.style.display='none';};
const bossBar=()=>{bossNameEl.textContent=BOSS.name; bossHPFill.style.width=(440*Math.max(0,BOSS.hp/BOSS.hpMax))+'px'; bossHPVal.textContent=`${BOSS.hp}/${BOSS.hpMax}`;};
const updateHP=()=>{pHPFill.style.width=(260*Math.max(0,HEART.hp/HEART.hpMax))+'px'; pHPVal.textContent=`${HEART.hp}/${HEART.hpMax}`;};
const centerHeart=()=>{HEART.x=ARENA.x+ARENA.w/2; HEART.y=ARENA.y+ARENA.h/2;};
const toast=(m)=>{toastEl.textContent=m; toastEl.classList.add('show'); setTimeout(()=>toastEl.classList.remove('show'),900);};

/* Secret: type 67 three times to open admin */
let secretBuf='', pairCount=0, secretCooldown=0;
function handleSecret67(k){
  if(secretCooldown>0) return;
  if(k==='6'||k==='7'){
    secretBuf=(secretBuf+k).slice(-2);
    if(secretBuf==='67'){ pairCount++; secretBuf=''; secretCooldown=10; if(pairCount>=3){pairCount=0; openAdmin(); toast('Admin opened');} }
  } else { secretBuf=''; pairCount=0; }
}

/* Input */
const down=new Set();
addEventListener('keydown',e=>{
  if(['ArrowLeft','ArrowRight','ArrowUp','ArrowDown','a','A','d','D','w','W','s','S'].includes(e.key)){
    if(!(turn===TURN.ENEMY && mode==='main')) return;
  }
  down.add(e.key);
  handleSecret67(e.key);
},{passive:true});
addEventListener('keyup',e=>down.delete(e.key),{passive:true});
const key=(k)=>down.has(k)||down.has(k.toUpperCase());

/* Submenu hotkeys */
addEventListener('keydown',e=>{
  if(mode==='act' || mode==='item'){
    if(['x','X','Backspace','Escape'].includes(e.key)){ mode='main'; say('Your turn.'); }
    if('1234'.includes(e.key)){ handleSubmenuSelect(parseInt(e.key,10)-1); }
    if(['Enter','z','Z',' '].includes(e.key)){ handleSubmenuSelect(0); }
  }
},{passive:true});
function handleSubmenuSelect(ix){ if(mode==='act') handleActChoice(ix); else if(mode==='item') handleItemChoice(ix); }

/* Helpers */
const bob=(v=3)=>Math.sin(time*2.4)*v;
function glow(ctx,x,y,r,fill,a=0.22){ctx.save();ctx.globalAlpha=a;ctx.fillStyle=fill;ctx.beginPath();ctx.arc(x,y,r,0,Math.PI*2);ctx.fill();ctx.restore();}
function drawHumanBase(ctx,x,y,p){ glow(ctx,x,y,64,p.aura,0.28); ctx.fillStyle=p.head; ctx.beginPath(); ctx.arc(x,y-34,12,0,Math.PI*2); ctx.fill(); ctx.fillStyle=p.body; ctx.fillRect(x-10,y-24,20,44); ctx.fillStyle=p.accent; ctx.fillRect(x-24,y-18,12,30); ctx.fillRect(x+12,y-18,12,30); ctx.fillStyle=p.body; ctx.fillRect(x-10,y+18,8,22); ctx.fillRect(x+2,y+18,8,22); }

/* Sprites */
function dSolar(ctx,t){const x=480,y=240+bob(2);drawHumanBase(ctx,x,y,{aura:'#fff3b8',head:'#ffefb0',body:'#ffd166',accent:'#ffe69a'});ctx.strokeStyle='#ffd166';ctx.beginPath();ctx.arc(x,y-34,18+Math.sin(t*5),0,Math.PI*2);ctx.stroke();}
function dEmber(ctx,t){const x=480,y=240+bob(2.4);drawHumanBase(ctx,x,y,{aura:'#ffb7a7',head:'#ffd3c7',body:'#ffa277',accent:'#ffc2a4'});ctx.fillStyle='rgba(255,194,164,0.35)';ctx.beginPath();ctx.ellipse(x-24,y-8,22,12+Math.sin(t*3)*3,0,0,Math.PI*2);ctx.fill();ctx.beginPath();ctx.ellipse(x+24,y-8,22,12+Math.sin(t*3+1.2)*3,0,0,Math.PI*2);ctx.fill();}
function dAbyss(ctx,t){const x=480,y=242+bob(2.2);drawHumanBase(ctx,x,y,{aura:'#b0a0ff',head:'#e5e1ff',body:'#a89bff',accent:'#d7cffc'});ctx.fillStyle='#222';ctx.fillRect(x-6,y-38,12,3);ctx.fillRect(x-4,y-33,8,2);}
function dMantis(ctx,t){const x=480,y=238+bob(2.2);drawHumanBase(ctx,x,y,{aura:'#ffe88a',head:'#fff5c0',body:'#ffd166',accent:'#ffeaa6'});ctx.strokeStyle:'#ffe88a';ctx.beginPath();ctx.moveTo(x-10,y-44);ctx.lineTo(x,y-52);ctx.lineTo(x+10,y-44);ctx.stroke();}
function dPixel(ctx,t){const x=480,y=240+bob(2);drawHumanBase(ctx,x,y,{aura:'#9fe0ff',head:'#dafeff',body:'#a8ecff',accent:'#bff3ff'});ctx.fillStyle='#111';ctx.fillRect(x-8,y-38,16,6);}
function dFrost(ctx,t){const x=480,y=238+bob(2);drawHumanBase(ctx,x,y,{aura:'#bfe7ff',head:'#e6f7ff',body:'#d0f0ff',accent:'#c5ecff'});ctx.fillStyle='#e6f7ff';ctx.beginPath();ctx.moveTo(x-10,y-44);ctx.lineTo(x-3,y-54);ctx.lineTo(x+3,y-44);ctx.fill();}
function dDJ(ctx,t){const x=480,y=242+bob(2.2);drawHumanBase(ctx,x,y,{aura:'#ffb0b0',head:'#ffd0d0',body:'#ff9090',accent:'#ffb7b7'});ctx.strokeStyle='#ffb0b0';ctx.beginPath();ctx.arc(x,y-34,14,Math.PI*0.2,Math.PI*0.8);ctx.stroke();}
function dVoid(ctx,t){const x=480,y=236+bob(2.2);drawHumanBase(ctx,x,y,{aura:'#d6c8ff',head:'#efe9ff',body:'#c9b9ff',accent:'#dacfff'});ctx.strokeStyle='#c9b9ff';ctx.beginPath();ctx.ellipse(x,y-34,20,8+Math.sin(t*3)*2,0,0,Math.PI*2);ctx.stroke();}
function dSiren(ctx,t){const x=480,y=240+bob(2.4);drawHumanBase(ctx,x,y,{aura:'#66ccff',head:'#aaddff',body:'#66ccff',accent:'#99ddff'});ctx.strokeStyle='#66ccff';ctx.strokeRect(x-10,y-44,20,6);}
function dStorm(ctx,t){const x=480,y=238+bob(2.4);drawHumanBase(ctx,x,y,{aura:'#fff59a',head:'#fffbd1',body:'#ffd455',accent:'#ffec8a'});ctx.strokeStyle='#ffe066';ctx.beginPath();ctx.moveTo(x-8,y-44);ctx.lineTo(x,y-54);ctx.lineTo(x+8,y-44);ctx.stroke();}
function dDream(ctx,t){const x=480,y=236+bob(2.6);drawHumanBase(ctx,x,y,{aura:'#e0c0ff',head:'#f2e5ff',body:'#d5a8ff',accent:'#e9d1ff'});}
function dObliv(ctx,t){const x=480,y=236+bob(2.4);drawHumanBase(ctx,x,y,{aura:'#1a141c',head:'#2a2230',body:'#0b0a0d',accent:'#3b3244'});ctx.strokeStyle='#ffd166';ctx.beginPath();ctx.arc(x,y-34,18+Math.sin(t*6),0,Math.PI*2);ctx.stroke();}

/* Heart */
function drawHeart(ctx,x,y,color='#ffd166',scale=0.8){
  ctx.save();ctx.translate(x,y);ctx.scale(scale,scale);
  const m=[[0,1,1,0,0,1,1,0],[1,1,1,1,1,1,1,1],[1,1,1,1,1,1,1,1],[0,1,1,1,1,1,1,0],[0,0,1,1,1,1,0,0],[0,0,0,1,1,0,0,0]];
  ctx.fillStyle=color;const s=3;
  for(let r=0;r<m.length;r++)for(let c=0;c<m[r].length;c++) if(m[r][c]) ctx.fillRect((c-4)*s,(r-3)*s,s,s);
  ctx.restore();
}

/* Spawning */
function spawn(b){b.t=0; bullets.push(b); return b;}
function spawnAimed(fx,fy,speed,dmg,col='#fff',r=3,lead=DIFF.lead){
  const vx0=(HEART.x-(HEART._px||HEART.x))/(HEART._pdt||1/60);
  const vy0=(HEART.y-(HEART._py||HEART.y))/(HEART._pdt||1/60);
  const dx=HEART.x-fx, dy=HEART.y-fy, L=Math.hypot(dx,dy)||1;
  const vx=(dx/L)*speed*DIFF.spd + vx0*lead, vy=(dy/L)*speed*DIFF.spd + vy0*lead;
  return spawn({x:fx,y:fy,vx,vy,r:Math.max(2,r),col,dmg:Math.max(1,Math.floor(dmg*DIFF.dmg))});
}
const rand=(a,b)=>Math.random()*(b-a)+a;
function ring(C,spd,col,dmg,n=12){for(let k=0;k<n;k++){const a=k/n*Math.PI*2;spawn({x:C.x,y:C.y,vx:Math.cos(a)*spd*DIFF.spd,vy:Math.sin(a)*spd*DIFF.spd,r:3,col,dmg});}}

/* Patterns — compact, unique per boss (3 each) */
/* Solar */
const pSolar1=(d=3)=>phaseWrap(d,(dt,t)=>{if(Math.random()<0.12){const c={x:ARENA.x+ARENA.w/2,y:ARENA.y+18};const base=rand(-0.3,0.3);for(const a of [base-0.7,base,base+0.7])spawn({x:c.x,y:c.y,vx:Math.cos(a)*250*DIFF.spd,vy:Math.sin(a)*250*DIFF.spd,r:3,col:'#fff3b8',dmg:5});}});
const pSolar2=(d=3)=>phaseWrap(d,(dt,t)=>{if(Math.random()<0.18){const C={x:ARENA.x+ARENA.w/2,y:ARENA.y+ARENA.h/2};ring(C,250,'#ffd166',6,14);}});
const pSolar3=(d=3)=>phaseWrap(d,(dt,t)=>{if(Math.random()<0.08){const left=Math.random()<0.5;for(let i=0;i<5;i++){const y=ARENA.y+20+i*30;spawn({x:left?ARENA.x-24:ARENA.x+ARENA.w+24,y, vx:(left?1:-1)*(260+Math.sin(t*3+i)*40)*DIFF.spd,vy:0,r:3,col:'#ffe9a0',dmg:6});}}});

/* Ember */
const pEmber1=(d=3.2)=>phaseWrap(d,(dt,t)=>{if(Math.random()<0.24){const x=ARENA.x+rand(10,ARENA.w-10);spawn({x,y:ARENA.y-18,vx:rand(-60,60),vy:240*DIFF.spd,r:3,col:'#ffb7a7',dmg:4});}});
const pEmber2=(d=3)=>phaseWrap(d,(dt,t)=>{if(Math.random()<0.18){const x=ARENA.x+rand(0,ARENA.w);spawnAimed(x,ARENA.y-10,210,5,'#ffd3a0',4,DIFF.lead*0.6);}});
const pEmber3=(d=3)=>phaseWrap(d,(dt,t)=>{if(Math.random()<0.18){const y=ARENA.y+rand(22,ARENA.h-22);spawn({x:ARENA.x-24,y,vx:270*DIFF.spd,vy:0,r:3,col:'#ffa277',dmg:5});spawn({x:ARENA.x+ARENA.w+24,y,vx:-270*DIFF.spd,vy:0,r:3,col:'#ffa277',dmg:5});}});

/* Abyss */
const pAbyss1=(d=3)=>phaseWrap(d,(dt,t)=>{if(Math.random()<0.2){const y=ARENA.y+rand(24,ARENA.h-24);const vx=(Math.random()<0.5?1:-1)*260*DIFF.spd;spawn({x:vx>0?ARENA.x-20:ARENA.x+ARENA.w+20,y,vx,vy:0,r:3,col:'#b0a0ff',dmg:5,bounce:1});}for(const b of bullets){if(b.bounce && b.x>ARENA.x&&b.x<ARENA.x+ARENA.w&&(b.y<ARENA.y+6||b.y>ARENA.y+ARENA.h-6)){b.vy*=-1;b.bounce--;}}});
const pAbyss2=(d=3)=>phaseWrap(d,(dt,t)=>{if(Math.random()<0.2){const real=Math.random()<0.65;const left=Math.random()<0.5;const y=ARENA.y+rand(12,ARENA.h-12);spawn({x:left?ARENA.x-24:ARENA.x+ARENA.w+24,y,vx:(left?1:-1)*(real?275:160)*DIFF.spd,vy:0,r:3,col:real?'#a89bff':'#444',dmg:real?5:1});}});
const pAbyss3=(d=3)=>phaseWrap(d,(dt,t)=>{if(Math.random()<0.18){const x=ARENA.x+rand(20,ARENA.w-20);const s=spawnAimed(x,ARENA.y-10,225,5,'#bfb3ff',3,DIFF.lead);s.split=0.45;}for(const b of bullets){if(b.split){b.split-=dt;if(b.split<=0&&!b.shot){b.shot=true;for(const a of [-0.45,0,0.45]) spawn({x:b.x,y:b.y,vx:b.vx+Math.cos(a)*120,vy:b.vy+Math.sin(a)*120,r:3,col:'#cfc6ff',dmg:4});}}}});

/* Mantis */
const pMantis1=(d=3)=>phaseWrap(d,(dt,t)=>{if(Math.random()<0.18){const c={x:ARENA.x+ARENA.w/2,y:ARENA.y+36};const base=t*1.8;for(let k=0;k<7;k++){const a=base+k*(Math.PI*2/7);spawn({x:c.x,y:c.y,vx:Math.cos(a)*255*DIFF.spd,vy:Math.sin(a)*255*DIFF.spd,r:3,col:'#ffe88a',dmg:5});}}});
const pMantis2=(d=3)=>phaseWrap(d,(dt,t)=>{if(Math.random()<0.22){const x=ARENA.x+rand(24,ARENA.w-24);const s=spawnAimed(x,ARENA.y-10,330,7,'#ffdf99',4,DIFF.lead*0.6);s.delay=0.25;s.vx*=0.6;s.vy*=0.6;}for(const b of bullets){if(b.delay){b.delay-=dt; if(b.delay<=0){b.vx*=1.6;b.vy*=1.6;b.delay=0;}}}});
const pMantis3=(d=3)=>phaseWrap(d,(dt,t)=>{if(Math.random()<0.22){for(let i=0;i<7;i++){const x=ARENA.x+20+i*(ARENA.w-40)/6;spawn({x,y:ARENA.y-18,vx:0,vy:230*DIFF.spd,r:3,col:'#fff3b8',dmg:4});}}});

/* Pixel */
const pPixel1=(d=3)=>phaseWrap(d,(dt,t)=>{if(Math.random()<0.22){const y=ARENA.y+rand(14,ARENA.h-14);const left=Math.random()<0.5;spawn({x:left?ARENA.x-24:ARENA.x+ARENA.w+24,y,vx:(left?1:-1)*270*DIFF.spd,vy:0,r:3,col:'#a8ecff',dmg:5});}});
const pPixel2=(d=3)=>phaseWrap(d,(dt,t)=>{if(Math.random()<0.18){const n=10;const C={x:ARENA.x+ARENA.w/2,y:ARENA.y+ARENA.h/2};for(let k=0;k<n;k++){const a=k/n*Math.PI*2;spawn({x:C.x,y:C.y,vx:Math.cos(a)*230*DIFF.spd,vy:Math.sin(a)*230*DIFF.spd,r:3,col:'#bdf4ff',dmg:5,tele:0.35+Math.random()*0.2});}}for(const b of bullets){if(b.tele){b.tele-=dt;if(b.tele<=0){b.x=ARENA.x+rand(0,ARENA.w);b.y=ARENA.y+rand(0,ARENA.h);b.tele=0;}}}});
const pPixel3=(d=3)=>phaseWrap(d,(dt,t)=>{if(Math.random()<0.18){const bb=spawnAimed(ARENA.x+rand(0,ARENA.w),ARENA.y-10,170,5,'#7fdcff',3,DIFF.lead*0.5); bb.speedUp=0.7;}for(const b of bullets){if(b.speedUp){b.speedUp-=dt;if(b.speedUp<=0){b.vx*=1.9;b.vy*=1.9;b.speedUp=0;}}}});

/* Frost */
const pFrost1=(d=3)=>phaseWrap(d,(dt,t)=>{if(Math.random()<0.18){for(let i=0;i<6;i++){const x=ARENA.x+40+i*70;spawn({x,y:ARENA.y-18,vx:0,vy:235*DIFF.spd,r:3,col:'#d0f0ff',dmg:5});}}});
const pFrost2=(d=3)=>phaseWrap(d,(dt,t)=>{if(Math.random()<0.2){const C={x:ARENA.x+ARENA.w/2,y:ARENA.y+10};const n=9,flip=(Math.floor(t*3)%2)===0;for(let k=0;k<n;k++){const a=((k/(n-1))-0.5)*(Math.PI/1.8)*(flip?-1:1);spawn({x:C.x,y:C.y,vx:Math.cos(a)*235*DIFF.spd,vy:Math.sin(a)*235*DIFF.spd,r:3,col:'#e6f7ff',dmg:5});}}});
const pFrost3=(d=3)=>phaseWrap(d,(dt,t)=>{if(Math.random()<0.15){HEART.sp=260; setTimeout(()=>HEART.sp=320,600); ring({x:ARENA.x+ARENA.w/2,y:ARENA.y+ARENA.h/2},220,'#d0f0ff',5,10)}});

/* DJ */
const pDJ1=(d=3)=>phaseWrap(d,(dt,t)=>{if(Math.random()<0.2){const n=5;for(let i=0;i<n;i++){const y=ARENA.y+20+i*(ARENA.h-40)/(n-1);const left=Math.random()<0.5;spawn({x:left?ARENA.x-24:ARENA.x+ARENA.w+24,y,vx:(left?1:-1)*(260+Math.sin(t*6+i)*40)*DIFF.spd,vy:0,r:3,col:'#ff9aaa',dmg:5});}}});
const pDJ2=(d=3)=>phaseWrap(d,(dt,t)=>{if(Math.random()<0.18){const c={x:ARENA.x+ARENA.w/2,y:ARENA.y+ARENA.h/2};ring(c,270,'#ffb0b0',6,10)}});
const pDJ3=(d=3)=>phaseWrap(d,(dt,t)=>{if(Math.random()<0.2){const a=t*2.1;spawn({x:ARENA.x+ARENA.w/2,y:ARENA.y+ARENA.h/2,vx:Math.cos(a)*245*DIFF.spd,vy:Math.sin(a)*245*DIFF.spd,r:3,col:'#ff99a9',dmg:5});}});

/* Void */
const pVoid1=(d=3)=>phaseWrap(d,(dt,t)=>{const C={x:ARENA.x+ARENA.w/2,y:ARENA.y+ARENA.h/2};const pull=(BOSS.flags.pullReduce||1);const dx=C.x-HEART.x,dy=C.y-HEART.y;HEART.x+=dx*0.38*pull*dt;HEART.y+=dy*0.38*pull*dt;if(Math.random()<0.2){const a=Math.random()*Math.PI*2;spawn({x:C.x,y:C.y,vx:Math.cos(a)*270*DIFF.spd,vy:Math.sin(a)*270*DIFF.spd,r:3,col:'#c9b9ff',dmg:6});}});
const pVoid2=(d=3)=>phaseWrap(d,(dt,t)=>{if(Math.random()<0.18){const n=8;for(let k=0;k<n;k++){const a=k/n*Math.PI*2;const b=spawn({x:HEART.x+Math.cos(a)*60,y:HEART.y+Math.sin(a)*60,vx:0,vy:0,r:3,col:'#bfb2ff',dmg:5,orbit:true,ang:a});}}for(const bb of bullets){if(bb.orbit){bb.ang+=dt*2.0; bb.x=HEART.x+Math.cos(bb.ang)*70; bb.y=HEART.y+Math.sin(bb.ang)*70; if(Math.random()<0.03){const dx=HEART.x-bb.x,dy=HEART.y-bb.y;const L=Math.hypot(dx,dy)||1;bb.vx=dx/L*285*DIFF.spd;bb.vy=dy/L*285*DIFF.spd;bb.orbit=false;}}});
const pVoid3=(d=3)=>phaseWrap(d,(dt,t)=>{const C={x:ARENA.x+ARENA.w/2,y:ARENA.y+ARENA.h/2};const rad=Math.max(40,120-60*t);if(Math.random()<0.2){const n=10;for(let k=0;k<n;k++){const a=k/n*Math.PI*2;spawn({x:C.x+Math.cos(a)*rad,y:C.y+Math.sin(a)*rad,vx:-Math.cos(a)*230*DIFF.spd,vy:-Math.sin(a)*230*DIFF.spd,r:3,col:'#d4c8ff',dmg:6});}}});

/* Siren */
const pSiren1=(d=3)=>phaseWrap(d,(dt,t)=>{if(Math.random()<0.22){for(let i=0;i<8;i++){const x=ARENA.x+20+i*(ARENA.w-40)/7;spawn({x,y:ARENA.y-18,vx:0,vy:220*DIFF.spd,r:3,col:'#66ccff',dmg:5});}}});
const pSiren2=(d=3)=>phaseWrap(d,(dt,t)=>{if(Math.random()<0.18){const cx=ARENA.x+rand(0,ARENA.w);spawnAimed(cx,ARENA.y-10,190,5,'#99ddff',5,DIFF.lead*0.5);}});
const pSiren3=(d=3)=>phaseWrap(d,(dt,t)=>{if(Math.random()<0.16){const c={x:ARENA.x+ARENA.w/2,y:ARENA.y+ARENA.h/2};ring(c,240,'#88d9ff',6,12)}});

/* Storm */
const pStorm1=(d=3)=>phaseWrap(d,(dt,t)=>{if(Math.random()<0.22){const left=Math.random()<0.5;const y=ARENA.y+rand(14,ARENA.h-14);const v=(left?1:-1)*(260+Math.sin(t*7)*40)*DIFF.spd;spawn({x:left?ARENA.x-24:ARENA.x+ARENA.w+24,y,vx:v,vy:0,r:3,col:'#ffe066',dmg:6,zig:1});}for(const b of bullets){if(b.zig){b.vy=(Math.sin((b.t||0)*10)*70);}}});
const pStorm2=(d=3)=>phaseWrap(d,(dt,t)=>{if(Math.random()<0.22){for(let i=0;i<3;i++){const x=ARENA.x+rand(20,ARENA.w-20);spawn({x,y:ARENA.y-18,vx:0,vy:300*DIFF.spd,r:4,col:'#ffea80',dmg:7});}}});
const pStorm3=(d=3)=>phaseWrap(d,(dt,t)=>{if(Math.random()<0.18){const c={x:ARENA.x+ARENA.w/2,y:ARENA.y+ARENA.h/2};const n=8;for(let k=0;k<n;k++){const a=k/n*Math.PI*2;const b=spawn({x:c.x,y:c.y,vx:Math.cos(a)*260*DIFF.spd,vy:Math.sin(a)*260*DIFF.spd,r:3,col:'#fff59a',dmg:6}); b.chain=0.35;}}for(const bb of bullets){if(bb.chain){bb.chain-=dt;if(bb.chain<=0&&!bb.split){bb.split=true;for(const a of [-0.35,0,0.35])spawn({x:bb.x,y:bb.y,vx:bb.vx+Math.cos(a)*120,vy:bb.vy+Math.sin(a)*120,r:3,col:'#fff59a',dmg:5});}}}});

/* Dream (final) */
const pDream1=(d=3.2)=>phaseWrap(d,(dt,t)=>{if(Math.random()<0.2){const C={x:ARENA.x+ARENA.w/2,y:ARENA.y+ARENA.h/2};for(let k=0;k<14;k++){const a=k/14*Math.PI*2;const s=250*DIFF.spd;spawn({x:C.x,y:C.y,vx:Math.cos(a)*s,vy:Math.sin(a)*s,r:3,col:'#e0c0ff',dmg:6,warp:true});}}for(const b of bullets){if(b.warp&&Math.random()<0.05){b.vx*=-1;b.vy*=-1;}}});
const pDream2=(d=3)=>phaseWrap(d,(dt,t)=>{if(Math.random()<0.22){const x=ARENA.x+rand(0,ARENA.w);spawnAimed(x,ARENA.y-10,225,7,'#d5a8ff',4,DIFF.lead*0.6);}});
const pDream3=(d=3)=>phaseWrap(d,(dt,t)=>{if(Math.random()<0.2){const cy=ARENA.y+ARENA.h-10;const count=9,spread=Math.PI/2;for(let k=0;k<count;k++){const a=(-spread)+k*(2*spread/(count-1));spawn({x:ARENA.x+ARENA.w/2,y:cy,vx:Math.cos(a)*255*DIFF.spd,vy:Math.sin(a)*-255*DIFF.spd,r:3,col:'#f0d1ff',dmg:6});}}});

/* Oblivion (admin hard) */
const pObliv1=(d=3.2)=>phaseWrap(d,(dt,t)=>{if(Math.random()<0.22){const C={x:ARENA.x+ARENA.w/2,y:ARENA.y+ARENA.h/2};const n=18;for(let k=0;k<n;k++){const a=t*2.0+k*(Math.PI*2/n);const s=285*DIFF.spd;spawn({x:C.x,y:C.y,vx:Math.cos(a)*s,vy:Math.sin(a)*s,r:3,col:'#fff3b8',dmg:7,rev:0.5});}}for(const b of bullets){if(b.rev){b.rev-=dt;if(b.rev<=0){b.vx*=-1;b.vy*=-1;b.rev=0;}}});
const pObliv2=(d=3.2)=>phaseWrap(d,(dt,t)=>{if(Math.random()<0.2){const n=6,hor=(Math.floor(t*2)%2)===0;for(let i=0;i<n;i++){if(hor){const x=ARENA.x+(i+0.5)*ARENA.w/n;spawn({x,y:ARENA.y-18,vx:0,vy:300*DIFF.spd,r:3,col:'#ffd166',dmg:7});}else{const y=ARENA.y+(i+0.5)*ARENA.h/n;spawn({x:ARENA.x-18,y,vx:300*DIFF.spd,vy:0,r:3,col:'#ffd166',dmg:7});}}}});
const pObliv3=(d=3)=>phaseWrap(d,(dt,t)=>{const C={x:ARENA.x+ARENA.w/2,y:ARENA.y+ARENA.h/2};const dx=C.x-HEART.x,dy=C.y-HEART.y;HEART.x+=dx*0.55*dt;HEART.y+=dy*0.55*dt;if(Math.random()<0.26){const a=Math.random()*Math.PI*2;spawn({x:C.x+Math.cos(a)*20,y:C.y+Math.sin(a)*20,vx:Math.cos(a)*295*DIFF.spd,vy:Math.sin(a)*295*DIFF.spd,r:3,col:'#f5e6b0',dmg:8});}});

/* Phase wrapper */
function phaseWrap(dur, update){
  let t=0; return { enter(){t=0;}, update(dt){t+=dt; update(dt,t);}, done(){return t>=dur;} };
}
function phase(dur,...parts){let t=0;return{enter(){t=0;parts.forEach(p=>p.enter&&p.enter());},update(dt){t+=dt;parts.forEach(p=>p.update&&p.update(dt));},done(){return t>=dur;}};}

/* Lore minimal (used in admin preview list message) */
const LORE={
  solar:"Fire respects breath more than bravado.",
  ember:"Soft pace, steady flame.",
  abyss:"Tricks teach rhythm.",
  mantis:"Discipline is the blade.",
  pixel:"Listen between frames.",
  frost:"Calm is armor.",
  dj:"Breath sets your tempo.",
  void:"Choose your orbit.",
  siren:"Tides test your breath.",
  storm:"Lightning favors resolve.",
  dream:"Bend habits, wake on purpose.",
  oblivion:"Endings are mirrors."
};

/* Boss roster (10 mains + admin) */
const BOSSES=[
  { key:'solar', name:'Solar Fang', hpMax:380, draw:dSolar,
    intro:["The sun bows to no one.","Step into the flare, "+username+".","Hold."],
    lines:["Burn bright.","Hold your ground.","Endure.","Again."],
    mercyNeed:3,
    actDefs:[
      {name:'Bow', say:"Respect accepted.", effect:s=>{s.mercy=(s.mercy||0)+1;}},
      {name:'Compliment', say:"Your courage glows.", effect:s=>{s.mercy=(s.mercy||0)+1;}},
      {name:'Focus', say:"Steady breath.", effect:s=>{HEART.i=Math.max(HEART.i,0.7);}},
      {name:'Taunt', say:"Heat rises.", effect:s=>{s.flags.boost=1.2;}}
    ],
    attacks:()=>[ phase(3,pSolar1(3)), phase(3,pSolar2(3)), phase(3,pSolar3(3)) ]
  },
  { key:'ember', name:'Ember Seraph', hpMax:360, draw:dEmber,
    intro:["Ash remembers flame.","We move softly.","Match my tempo."],
    lines:["Inhale.","Soft steps.","Patience.","You learn."],
    mercyNeed:3,
    actDefs:[
      {name:'Listen', say:"Silence shared.", effect:s=>{s.mercy=(s.mercy||0)+1; s.flags.nextSlow=0.82;}},
      {name:'Apologize', say:"Forgiven.", effect:s=>{s.mercy=(s.mercy||0)+1;}},
      {name:'Hum', say:"On pitch.", effect:s=>{s.mercy=(s.mercy||0)+1;}},
      {name:'Smile', say:"Warmth spreads.", effect:s=>{HEART.hp=Math.min(HEART.hpMax,HEART.hp+6); updateHP();}}
    ],
    attacks:()=>[ phase(3.2,pEmber1(3.2)), phase(3,pEmber2(3)), phase(3,pEmber3(3)) ]
  },
  { key:'abyss', name:'Abyss Jester', hpMax:370, draw:dAbyss,
    intro:["Smile through the dark.","Ready to play?","Look twice."],
    lines:["Ping.","Missed it.","Look closer.","Heh."],
    mercyNeed:3,
    actDefs:[
      {name:'Wave', say:"Wave returned.", effect:s=>{s.mercy=(s.mercy||0)+1;}},
      {name:'Laugh', say:"Heh.", effect:s=>{s.mercy=(s.mercy||0)+1;}},
      {name:'Compliment', say:"Flattery accepted.", effect:s=>{s.mercy=(s.mercy||0)+1;}},
      {name:'Ignore', say:"Bold.", effect:s=>{s.flags.boost=1.06;}}
    ],
    attacks:()=>[ phase(3,pAbyss1(3)), phase(3,pAbyss2(3)), phase(3,pAbyss3(3)) ]
  },
  { key:'mantis', name:'Golden Mantis', hpMax:400, draw:dMantis,
    intro:["Stillness. Then strike.","Measure the gap.","Blink and step."],
    lines:["Watch the arc.","Closer.","Precise.","Intent."],
    mercyNeed:3,
    actDefs:[
      {name:'Bow', say:"Gesture noted.", effect:s=>{s.mercy=(s.mercy||0)+1;}},
      {name:'Compliment', say:"Golden discipline.", effect:s=>{s.mercy=(s.mercy||0)+1; s.flags.nextSlow=0.9;}},
      {name:'Calm', say:"Breath lowers.", effect:s=>{HEART.i=Math.max(HEART.i,0.65);}},
      {name:'Dodge', say:"Good step.", effect:s=>{s.mercy=(s.mercy||0)+1;}}
    ],
    attacks:()=>[ phase(3,pMantis1(3)), phase(3,pMantis2(3)), phase(3,pMantis3(3)) ]
  },
  { key:'pixel', name:'Pixel Phantom', hpMax:360, draw:dPixel,
    intro:["gl1tch... r3ady?","rendering fear...","hold the frame."],
    lines:["tearing...","lag spike","packet lost","reboot soon"],
    mercyNeed:3,
    actDefs:[
      {name:'Debug', say:"errors reduced.", effect:s=>{s.mercy=(s.mercy||0)+1; s.flags.nextSlow=0.85;}},
      {name:'Compliment', say:"shader praised.", effect:s=>{s.mercy=(s.mercy||0)+1;}},
      {name:'Reboot', say:"temp calm.", effect:s=>{HEART.i=Math.max(HEART.i,0.75);}},
      {name:'Ignore', say:"…", effect:s=>{}}
    ],
    attacks:()=>[ phase(3,pPixel1(3)), phase(3,pPixel2(3)), phase(3,pPixel3(3)) ]
  },
  { key:'frost', name:'Frostbite Warden', hpMax:390, draw:dFrost,
    intro:["Cold clarifies.","Hold steady.","No flinching."],
    lines:["Breathe fog.","Still water.","Brace.","Now."],
    mercyNeed:3,
    actDefs:[
      {name:'Shiver', say:"Accepted.", effect:s=>{s.mercy=(s.mercy||0)+1;}},
      {name:'Respect', say:"Noted.", effect:s=>{s.mercy=(s.mercy||0)+1; s.flags.nextSlow=0.85;}},
      {name:'Warmth', say:"Fingers thaw.", effect:s=>{HEART.hp=Math.min(HEART.hpMax,HEART.hp+5); updateHP();}},
      {name:'Apologize', say:"Forgiven.", effect:s=>{s.mercy=(s.mercy||0)+1;}}
    ],
    attacks:()=>[ phase(3,pFrost1(3)), phase(3,pFrost2(3)), phase(3,pFrost3(3)) ]
  },
  { key:'dj', name:'Crimson DJ', hpMax:380, draw:dDJ,
    intro:["drop the bass.","move your feet.","on the one."],
    lines:["bop","beat","sync","step"],
    mercyNeed:3,
    actDefs:[
      {name:'Dance', say:"on tempo.", effect:s=>{s.mercy=(s.mercy||0)+1;}},
      {name:'Compliment', say:"fresh mix.", effect:s=>{s.mercy=(s.mercy||0)+1;}},
      {name:'Sync', say:"locked in.", effect:s=>{s.flags.nextSlow=0.9;}},
      {name:'Boo', say:"lol.", effect:s=>{}}
    ],
    attacks:()=>[ phase(3,pDJ1(3)), phase(3,pDJ2(3)), phase(3,pDJ3(3)) ]
  },
  { key:'void', name:'Void Prophet', hpMax:420, draw:dVoid,
    intro:["gravity listens.","do you?","choose your orbit."],
    lines:["fall inward","hush","orbit","release"],
    mercyNeed:4,
    actDefs:[
      {name:'Listen', say:"heard.", effect:s=>{s.mercy=(s.mercy||0)+1;}},
      {name:'Bow', say:"seen.", effect:s=>{s.mercy=(s.mercy||0)+1;}},
      {name:'Meditate', say:"settled.", effect:s=>{HEART.i=Math.max(HEART.i,0.8);}},
      {name:'Resist', say:"counter-force.", effect:s=>{s.flags.pullReduce=0.7;}}
    ],
    attacks:()=>[ phase(3,pVoid1(3)), phase(3,pVoid2(3)), phase(3,pVoid3(3)) ]
  },
  { key:'siren', name:'Tidecaller Siren', hpMax:380, draw:dSiren,
    intro:["The tide rises.","Can you breathe?"],
    lines:["Splash.","Drown.","Flow."],
    mercyNeed:3,
    actDefs:[
      {name:'Listen', say:"You match the swell.", effect:s=>{s.mercy=(s.mercy||0)+1; s.flags.nextSlow=0.85;}},
      {name:'Compliment', say:"She softens.", effect:s=>{s.mercy=(s.mercy||0)+1;}},
      {name:'Hold Breath', say:"You steady your lungs.", effect:s=>{HEART.i=Math.max(HEART.i,0.75);}},
      {name:'Reach Out', say:"A calm passes.", effect:s=>{HEART.hp=Math.min(HEART.hpMax,HEART.hp+5); updateHP();}}
    ],
    attacks:()=>[ phase(3,pSiren1(3)), phase(3,pSiren2(3)), phase(3,pSiren3(3)) ]
  },
  { key:'storm', name:'Storm Herald', hpMax:400, draw:dStorm,
    intro:["Thunder answers.","Lightning strikes."],
    lines:["Crack.","Flash.","Boom."],
    mercyNeed:3,
    actDefs:[
      {name:'Stand Firm', say:"You brace the strike.", effect:s=>{HEART.i=Math.max(HEART.i,0.72);}},
      {name:'Compliment', say:"They nod.", effect:s=>{s.mercy=(s.mercy||0)+1;}},
      {name:'Sync Breath', say:"Your timing improves.", effect:s=>{s.flags.nextSlow=0.9;}},
      {name:'Taunt', say:"Bolts intensify.", effect:s=>{s.flags.boost=1.15;}}
    ],
    attacks:()=>[ phase(3,pStorm1(3)), phase(3,pStorm2(3)), phase(3,pStorm3(3)) ]
  },
  { key:'dream', name:'Dream Eater', hpMax:500, draw:dDream, // final
    intro:["This is not real.","But your habits are.","Survive me."],
    lines:["bend","slur","warp","wake"],
    mercyNeed:6,
    actDefs:[
      {name:'Admit Fear', say:"Naming helps.", effect:s=>{s.mercy=(s.mercy||0)+1;}},
      {name:'Slow Down', say:"Time obeys.", effect:s=>{s.flags.nextSlow=0.8;}},
      {name:'Blink Twice', say:"You return.", effect:s=>{HEART.i=Math.max(HEART.i,0.85);}},
      {name:'Smile', say:"Brave.", effect:s=>{s.mercy=(s.mercy||0)+1;}}
    ],
    attacks:()=>[ phase(3.2,pDream1(3.2)), phase(3,pDream2(3)), phase(3,pDream3(3)) ]
  }
];

const ADMIN_BOSSES=[
  { key:'oblivion', name:'[Admin] Oblivion Herald', hpMax:620, draw:dObliv,
    intro:["entropy remembers you.","endings echo.","only now exists."],
    lines:["closer","unmake","reverse","again"],
    mercyNeed:6,
    actDefs:[
      {name:'Bow', say:"acknowledged.", effect:s=>{s.mercy=(s.mercy||0)+1;}},
      {name:'Resist', say:"defiance mapped.", effect:s=>{s.flags.nextSlow=0.85;}},
      {name:'Reflect', say:"brief light returns.", effect:s=>{HEART.i=Math.max(HEART.i,0.95);}},
      {name:'Accept', say:"peace is choice.", effect:s=>{s.mercy=(s.mercy||0)+1;}}
    ],
    attacks:()=>[ phase(3.2,pObliv1(3.2)), phase(3.2,pObliv2(3.2)), phase(3,pObliv3(3)) ]
  }
];

/* Admin list + preview */
function buildAdminList(){
  adBoss.innerHTML='';
  BOSSES.forEach((b,i)=>{const o=document.createElement('option');o.value='main:'+i;o.textContent=`${i+1}. ${b.name}`;adBoss.appendChild(o);});
  ADMIN_BOSSES.forEach((b,i)=>{const o=document.createElement('option');o.value='admin:'+i;o.textContent=b.name;adBoss.appendChild(o);});
}
function drawPreview(){
  prevCtx.fillStyle='#0b0b0b'; prevCtx.fillRect(0,0,180,180);
  if(BOSS){ prevCtx.save(); prevCtx.translate(-300,-80); BOSS.draw(prevCtx,time); prevCtx.restore(); }
}
function openAdmin(){ admin.style.display='flex'; buildAdminList(); adBoss.value='main:'+bossIndex; drawPreview(); }
function closeAdmin(){ admin.style.display='none'; }

/* Flow */
function setBossFromObj(obj){
  BOSS={ key:obj.key,name:obj.name,hpMax:obj.hpMax,hp:obj.hpMax,draw:obj.draw,
    intro:[...obj.intro],lines:[...obj.lines],mercyNeed:obj.mercyNeed,mercy:0,
    flags:{nextSlow:1,boost:1,pullReduce:1}, actDefs:obj.actDefs.map(x=>x), attacks:obj.attacks
  };
  attackSeq=BOSS.attacks(); attackIx=0; bossBar(); drawPreview(); saveProgress(); turnCount=0;
}
function setBoss(ix){ bossIndex=Math.max(0,Math.min(BOSSES.length-1,ix|0)); setBossFromObj(BOSSES[bossIndex]); }
function initBoss(sel){
  if(typeof sel==='string' && sel.startsWith('admin:')){ const idx=parseInt(sel.split(':')[1],10)||0; setBossFromObj(ADMIN_BOSSES[idx]); }
  else setBoss(typeof sel==='number'?sel:bossIndex);
  HEART.hp=HEART.hpMax=Math.max(1,SAVE.hp||50); updateHP(); HEART.i=0; centerHeart();
  turn=TURN.PLAYER; mode='main'; showArena=false; boxEl.style.display='none'; uiBar.classList.remove('hidden');
  say((BOSS.intro||[]).join('\n'));
}

/* Movement */
function processMovement(dt){
  if(turn!==TURN.ENEMY || mode!=='main') return;
  let dx=0,dy=0; if(key('ArrowLeft')||key('a'))dx-=1; if(key('ArrowRight')||key('d'))dx+=1; if(key('ArrowUp')||key('w'))dy-=1; if(key('ArrowDown')||key('s'))dy+=1;
  const L=Math.hypot(dx,dy)||1;
  HEART.x=Math.max(ARENA.x+HEART.r,Math.min(ARENA.x+ARENA.w-HEART.r, HEART.x+dx/L*HEART.sp*dt));
  HEART.y=Math.max(ARENA.y+HEART.r,Math.min(ARENA.y+ARENA.h-HEART.r, HEART.y+dy/L*HEART.sp*dt));
  HEART._pdt=dt; HEART._px=HEART.x; HEART._py=HEART.y;
}

/* Bullets update/collide */
function updateBullets(dt){
  const speedMul=BOSS.flags.nextSlow||1;
  for(const b of bullets){ b.t=(b.t||0)+dt; b.x+=b.vx*dt*speedMul; b.y+=b.vy*dt*speedMul; }
  const m=240; bullets=bullets.filter(b=>b.x>ARENA.x-m&&b.x<ARENA.x+ARENA.w+m&&b.y>ARENA.y-m&&b.y<ARENA.y+ARENA.h+m);
}
function collide(){
  if(HEART.i>0) return;
  for(const b of bullets){
    const dx=b.x-HEART.x, dy=b.y-HEART.y, rr=(b.r||4)+HEART.r;
    if(dx*dx+dy*dy<=rr*rr){
      const dmg=Math.max(1,Math.floor((b.dmg||3)*(BOSS.flags.boost||1)));
      HEART.hp=Math.max(0,HEART.hp-dmg); updateHP(); HEART.i=0.85; break;
    }
  }
}

/* Attacks lifecycle */
function startAttack(){
  bullets.length=0; showArena=true; boxEl.style.display='block';
  attack=attackSeq[attackIx]; attackIx=(attackIx+1)%attackSeq.length;
  attack.enter&&attack.enter();
}
function finishAttack(){
  showArena=false; boxEl.style.display='none'; uiBar.classList.remove('hidden');
  BOSS.flags.nextSlow=1; BOSS.flags.boost=1; BOSS.flags.pullReduce=1;
  turn=TURN.PLAYER; mode='main'; turnCount++;
  say(BOSS.lines[(Math.floor(time*3))%(BOSS.lines.length||1)]||'...');
  attack=null;
}

/* Actions */
function bossHit(dmg){ const dealt=Math.max(1,Math.floor(dmg/(BOSS.flags.boost||1))); BOSS.hp=Math.max(0,BOSS.hp-dealt); bossBar(); damagePopup={x:480,y:200,t:0,text:String(dealt)}; }
function playerFight(){ if(turn!==TURN.PLAYER||mode!=='main') return; const dmg=26; routeState.fight++; saveProgress(); say(`${username} strikes for ${dmg}.`); bossHit(dmg); endPlayerTurn(); }
function openAct(){ if(turn!==TURN.PLAYER||mode!=='main') return; mode='act'; const opts=BOSS.actDefs.map((a,i)=>` ${i+1}. ${a.name}`).join('\n'); say(`ACT on ${BOSS.name}:\n${opts}`,true); }
function handleActChoice(i){
  const a=BOSS.actDefs[i||0]; if(!a){ say('No such act.'); return; }
  a.effect(BOSS); routeState.act++; saveProgress(); say(a.say);
  if((BOSS.mercy||0)>=BOSS.mercyNeed) say(`${BOSS.name} seems more willing to listen.`);
  mode='main'; endPlayerTurn();
}
function openItem(){ if(turn!==TURN.PLAYER||mode!=='main') return; mode='item'; say(`ITEMS:\n${itemsList()}\n\nPick with 1-4`,true); }
function handleItemChoice(i){ const msg=useItem(i); say(msg); mode='main'; endPlayerTurn(); }
function openMercy(){
  if(turnCount>=6 && (BOSS.mercy||0)>=BOSS.mercyNeed){ routeState.mercy++; saveProgress(); victory(true); }
  else say(`${BOSS.name} isn't ready to be spared.\n(Survive 6 waves and raise Mercy enough.)`);
}
function endPlayerTurn(){ if(turn!==TURN.PLAYER) return; turn=TURN.TRANS; setTimeout(()=>{ if(turn!==TURN.TRANS) return; turn=TURN.ENEMY; uiBar.classList.add('hidden'); hideSay(); startAttack(); },120); }

/* End states */
function defeat(){ if(turn===TURN.DEFEAT) return; turn=TURN.DEFEAT; say('You fall. The hall dims.'); setTimeout(()=>initBoss(bossIndex),900); }
function victory(spared=false){
  if(turn===TURN.VICTORY) return; turn=TURN.VICTORY;
  unlockLore(BOSS.key);
  say(`${spared?'You spared':'You defeated'} ${BOSS.name}. Lore unlocked.`);
  setTimeout(()=>{ const next=bossIndex+1; if(next<BOSSES.length) initBoss(next); else { say('Ending: You carried your choices.'); setTimeout(()=>initBoss(0),1000);} },900);
}

/* Loop */
let last=performance.now();
function loop(now){
  const dt=Math.min(0.033, Math.max(0,(now-last)/1000)); last=now;
  secretCooldown=Math.max(0,secretCooldown-1);
  if(!paused){ update(dt); render(); }
  requestAnimationFrame(loop);
}
requestAnimationFrame(loop);

function update(dt){
  time+=dt; HEART.i=Math.max(0,HEART.i-dt);
  if(turn===TURN.ENEMY){
    processMovement(dt);
    attack&&attack.update&&attack.update(dt);
    updateBullets(dt);
    collide();
    if(attack&&attack.done&&attack.done()) finishAttack();
    if(HEART.hp<=0) defeat();
  }
  if(BOSS && BOSS.hp<=0 && turn!==TURN.VICTORY) victory(false);
  if(damagePopup){ damagePopup.t+=dt; if(damagePopup.t>0.9) damagePopup=null; }
}
function render(){
  ctx.fillStyle='#08070a'; ctx.fillRect(0,0,960,720);
  ctx.fillStyle='#141018'; for(let i=0;i<60;i++){const x=(i*137)%960, y=(i*173)%720; ctx.fillRect(x,y,2,2);}
  if(BOSS&&BOSS.draw) BOSS.draw(ctx,time);
  if(turn===TURN.ENEMY && showArena){
    ctx.strokeStyle='#fff'; ctx.lineWidth=3; ctx.strokeRect(ARENA.x,ARENA.y,ARENA.w,ARENA.h);
    for(const b of bullets){ ctx.fillStyle=b.col||'#fff'; ctx.beginPath(); ctx.arc(b.x,b.y,b.r||4,0,Math.PI*2); ctx.fill(); }
    ctx.save(); if(HEART.i>0) ctx.globalAlpha=0.6+0.3*Math.sin(time*20);
    drawHeart(ctx,HEART.x-6,HEART.y-6,'#ffd166',0.8);
    ctx.restore();
  }
  if(damagePopup){ const a=Math.max(0,1-damagePopup.t/0.9); ctx.save(); ctx.globalAlpha=a; ctx.fillStyle='#fff1b6'; ctx.font='16px monospace'; ctx.fillText(damagePopup.text,480,200-damagePopup.t*60); ctx.restore(); }
}

/* Admin */
buildAdminList();
adClose.onclick=()=>closeAdmin();
adEndAtk.onclick=()=>{ if(turn===TURN.ENEMY) finishAttack(); };
adAutoWin.onclick=()=>{ if(BOSS){ BOSS.hp=0; bossBar(); } };
adAutoSpare.onclick=()=>{ if(BOSS){ BOSS.mercy=BOSS.mercyNeed; turnCount=6; openMercy(); } };
adReset.onclick=()=>{ localStorage.removeItem(SAVE_KEY); SAVE=loadSave(); initBoss(0); };
adBoss.onchange=()=>{ const v=adBoss.value; if(v.startsWith('admin:')){ const i=parseInt(v.split(':')[1])||0; setBossFromObj(ADMIN_BOSSES[i]); } else { const i=parseInt(v.split(':')[1])||0; initBoss(i); } };
addEventListener('keydown',e=>handleSecret67(e.key),{passive:true});

/* UI clicks + shortcuts */
uiMenu.addEventListener('click',e=>{
  const btn=e.target.closest('.uiBtn'); if(!btn) return;
  const act=btn.dataset.act;
  if(turn!==TURN.PLAYER||mode!=='main'){ if(act==='MERCY') openMercy(); return; }
  if(act==='FIGHT') playerFight();
  else if(act==='ACT') openAct();
  else if(act==='ITEM') openItem();
  else if(act==='MERCY') openMercy();
});
addEventListener('keydown',e=>{
  if(turn!==TURN.PLAYER) return;
  if(mode==='main'){
    if(['z','Z','Enter',' '].includes(e.key)) playerFight();
    if(e.key==='a'||e.key==='A') openAct();
    if(e.key==='i'||e.key==='I') openItem();
    if(e.key==='m'||e.key==='M') openMercy();
  }
},{passive:true});

/* Start */
function firstBoss(){ return bossIndex<0||bossIndex>=BOSSES.length?0:bossIndex; }
initBoss(firstBoss());
updateHP();
cv.focus();
</script>
</body>
</html>

<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<title>Undertale Gold — Battle (12 bosses, full build, profile color, hidden admin)</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover, user-scalable=no"/>
<style>
/* Centered stage */
html,body{
  margin:0;height:100%;background:#000;color:#ffd166;
  display:flex;align-items:center;justify-content:center;
  font-family:ui-monospace,menlo,consolas,monospace;
}
*{box-sizing:border-box}
#wrap{
  width:960px;height:720px;position:relative;
  background:#070606;border:4px solid #0a0a0f;image-rendering:pixelated;
}

/* HUD */
#hud{
  position:absolute;left:0;right:0;top:0;padding:10px 16px;
  display:flex;justify-content:space-between;pointer-events:none;z-index:3
}
.hcol{display:flex;flex-direction:column;gap:6px}
.bar{height:10px;background:#141414;border:1px solid #383838;position:relative}
.fill{position:absolute;left:0;top:0;bottom:0}
#bossFill{background:#ff5e6b;width:100%}
#hpFill{background:#7affb7;width:100%}

/* Dialogue bubble */
#bubble{
  position:absolute;left:50%;bottom:136px;transform:translateX(-50%);
  width:90%;min-height:96px;background:#0b0b0b;border:2px solid #ffd166;padding:12px;display:none;z-index:3
}
#bubbleText{white-space:pre-line;line-height:1.5}

/* Bottom UI */
#uiBar{
  position:absolute;left:50%;bottom:8px;transform:translateX(-50%);
  width:920px;height:108px;background:#0b0b0b;border:2px solid #262626;
  display:flex;align-items:center;justify-content:space-around;z-index:3
}
.btn{cursor:pointer;user-select:none;display:flex;align-items:center;gap:10px}
.key{width:20px;height:20px;border:2px solid #fff;display:flex;align-items:center;justify-content:center;font-weight:700}
.lab{font-size:20px;letter-spacing:1px}

/* Arena */
#arenaBox{position:absolute;left:240px;top:420px;width:480px;height:180px;border:3px solid #fff;display:none;pointer-events:none;z-index:2}

/* Toast */
#toast{
  position:absolute;left:50%;top:18px;transform:translateX(-50%);
  background:#111;border:1px solid #fff;color:#ffd166;padding:6px 10px;font-size:12px;opacity:0;transition:opacity .22s;pointer-events:none;z-index:5
}
#toast.show{opacity:1}

/* Admin overlay (hidden triggers only) */
#admin{
  position:absolute;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.65);z-index:10
}
#panel{
  width:920px;max-width:95%;background:#0e0e0e;border:2px solid #fff;padding:14px;color:#ffd166
}
.tabs{display:flex;gap:6px;margin-bottom:8px}
.tab{padding:6px 10px;border:1px solid #fff;background:#121212;color:#ffd166;cursor:pointer}
.tab.active{background:#1b1b1b}
.view{display:none}
.view.active{display:block}
.row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin:6px 0}
.col{display:flex;flex-direction:column;gap:6px}
.sel,.inp,textarea{background:#111;color:#ffd166;border:1px solid #333;padding:6px 8px}
.btn2{padding:6px 10px;border:1px solid #fff;background:transparent;color:#ffd166;cursor:pointer}
#preview{width:180px;height:180px;border:1px solid #333;background:#0b0b0b}
</style>
</head>
<body>
<div id="wrap">
  <canvas id="cv" width="960" height="720"></canvas>

  <div id="hud">
    <div class="hcol" style="min-width:300px">
      <div id="bossName">Solar Fang</div>
      <div class="bar" style="width:440px"><div id="bossFill" class="fill"></div></div>
      <div id="bossVal" style="font-size:12px">000/000</div>
    </div>
    <div class="hcol" style="align-items:flex-end;min-width:180px">
      <div id="playerName" style="color:#9be7c0">Traveler</div>
      <div class="bar" style="width:260px"><div id="hpFill" class="fill"></div></div>
      <div id="hpVal" style="font-size:12px">50/50</div>
    </div>
  </div>

  <div id="bubble"><div id="bubbleText"></div></div>
  <div id="arenaBox"></div>

  <div id="uiBar">
    <div class="btn" data-act="FIGHT"><div class="key">Z</div><div class="lab">FIGHT</div></div>
    <div class="btn" data-act="ACT"><div class="key">A</div><div class="lab">ACT</div></div>
    <div class="btn" data-act="ITEM"><div class="key">I</div><div class="lab">ITEM</div></div>
    <div class="btn" data-act="MERCY"><div class="key">M</div><div class="lab">MERCY</div></div>
  </div>

  <div id="toast">Admin opened</div>

  <!-- Admin overlay -->
  <div id="admin">
    <div id="panel">
      <div class="tabs">
        <button class="tab active" data-t="profile">Profile</button>
        <button class="tab" data-t="boss">Boss</button>
        <button class="tab" data-t="patterns">Patterns</button>
        <button class="tab" data-t="save">Save</button>
      </div>

      <div id="view-profile" class="view active">
        <div class="row">
          <div class="col">
            <label>Username</label>
            <input id="adUser" class="inp" placeholder="Traveler"/>
          </div>
          <div class="col">
            <label>Player HP Max</label>
            <input id="adHP" class="inp" type="number" value="50" min="1" max="99"/>
          </div>
          <div class="col">
            <label>Difficulty</label>
            <select id="adDiff" class="sel">
              <option>Normal</option><option>Hard</option><option>Insane</option>
            </select>
          </div>
          <button id="adApplyProfile" class="btn2">Apply</button>
        </div>
      </div>

      <div id="view-boss" class="view">
        <div class="row">
          <select id="adBoss" class="sel" style="min-width:260px"></select>
          <button id="adLoadBoss" class="btn2">Load</button>
          <button id="adEnd" class="btn2">End attack</button>
          <button id="adWin" class="btn2">Win</button>
          <button id="adSpare" class="btn2">Spare</button>
        </div>
        <div class="row" style="align-items:flex-start">
          <canvas id="preview" width="180" height="180"></canvas>
          <div class="col" style="min-width:300px">
            <label>Notes</label>
            <textarea id="adNotes" rows="7" placeholder="Internal notes…"></textarea>
          </div>
        </div>
      </div>

      <div id="view-patterns" class="view">
        <div class="row">
          <button id="adTestP1" class="btn2">Test pattern 1</button>
          <button id="adTestP2" class="btn2">Test pattern 2</button>
          <button id="adTestP3" class="btn2">Test pattern 3</button>
          <button id="adHitbox" class="btn2">Toggle heart glow</button>
        </div>
        <div class="row">
          <label>Global speed x</label>
          <input id="adSpeedMul" class="inp" type="number" step="0.05" min="0.5" max="2.0" value="1.00"/>
          <button id="adApplySpeed" class="btn2">Apply</button>
        </div>
      </div>

      <div id="view-save" class="view">
        <div class="row">
          <button id="adExport" class="btn2">Export save</button>
          <button id="adImport" class="btn2">Import save</button>
          <button id="adReset" class="btn2">Reset save</button>
          <button id="adClose" class="btn2">Close</button>
        </div>
        <div class="row">
          <textarea id="adSaveBox" rows="8" style="width:100%" placeholder="Save JSON will appear here…"></textarea>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
"use strict";

/* -------- Profile integration -------- */
const LS_PROFILE='utg_shared_profile_v1';
function loadProfile(){ try{ return JSON.parse(localStorage.getItem(LS_PROFILE))||{}; }catch{ return {}; } }
const PROFILE=loadProfile();
const PLAYER_NAME=(PROFILE.name||'Traveler').slice(0,16);
const HEART_COLOR=PROFILE.glow||'#ffd166';

/* -------- Elements -------- */
const cv=document.getElementById('cv'), ctx=cv.getContext('2d',{alpha:false, desynchronized:true});
const bossName=document.getElementById('bossName'), bossVal=document.getElementById('bossVal'), bossFill=document.getElementById('bossFill');
const playerNameEl=document.getElementById('playerName'); playerNameEl.textContent=PLAYER_NAME;
const hpVal=document.getElementById('hpVal'), hpFill=document.getElementById('hpFill');
const bubble=document.getElementById('bubble'), bubbleText=document.getElementById('bubbleText');
const uiBar=document.getElementById('uiBar'), arenaBox=document.getElementById('arenaBox');
const toast=document.getElementById('toast'), admin=document.getElementById('admin');
const prevCtx=document.getElementById('preview').getContext('2d',{desynchronized:true});

/* -------- Admin UI refs -------- */
const tabs=[...document.querySelectorAll('.tab')];
const views={profile:document.getElementById('view-profile'), boss:document.getElementById('view-boss'), patterns:document.getElementById('view-patterns'), save:document.getElementById('view-save')};
const adUser=document.getElementById('adUser'), adHP=document.getElementById('adHP'), adDiff=document.getElementById('adDiff');
const adApplyProfile=document.getElementById('adApplyProfile'), adBoss=document.getElementById('adBoss');
const adLoadBoss=document.getElementById('adLoadBoss'), adEnd=document.getElementById('adEnd'), adWin=document.getElementById('adWin'), adSpare=document.getElementById('adSpare');
const adTestP1=document.getElementById('adTestP1'), adTestP2=document.getElementById('adTestP2'), adTestP3=document.getElementById('adTestP3');
const adHitbox=document.getElementById('adHitbox'), adSpeedMul=document.getElementById('adSpeedMul'), adApplySpeed=document.getElementById('adApplySpeed');
const adExport=document.getElementById('adExport'), adImport=document.getElementById('adImport'), adReset=document.getElementById('adReset'), adClose=document.getElementById('adClose');
const adSaveBox=document.getElementById('adSaveBox');

/* -------- Tabs -------- */
tabs.forEach(b=>{
  b.onclick=()=>{
    tabs.forEach(t=>t.classList.remove('active')); b.classList.add('active');
    Object.values(views).forEach(v=>v.classList.remove('active'));
    views[b.dataset.t].classList.add('active');
  };
});

/* -------- Save -------- */
const SAVE_KEY='ug_battle_full_v3';
function loadSave(){ try{ return JSON.parse(localStorage.getItem(SAVE_KEY))||{} }catch{return {} } }
function saveWrite(d){ try{ localStorage.setItem(SAVE_KEY, JSON.stringify(d)); }catch{} }
let SAVE=loadSave();

/* -------- Game constants -------- */
const ARENA={x:240,y:420,w:480,h:180};
const TURN={PLAYER:'p',ENEMY:'e',TRANS:'t',WIN:'w',LOSE:'l'};
const DIFFS={
  Normal:{spd:1.10,rate:1.10,dmg:1.40,lead:0.08},
  Hard:{spd:1.28,rate:1.28,dmg:1.75,lead:0.10},
  Insane:{spd:1.46,rate:1.40,dmg:2.10,lead:0.12}
};

/* -------- Player -------- */
let DIFF=DIFFS[SAVE.difficulty||'Normal']||DIFFS.Normal;
let GLOBAL_SPEED=1.0;
const HEART={ x:ARENA.x+ARENA.w/2,y:ARENA.y+ARENA.h/2,r:4,sp:320,i:0,
  hp: Math.max(1,SAVE.hp||50), hpMax: Math.max(1,SAVE.hp||50),
  _px:0,_py:0,_pdt:1/60, glow:true
};
function centerHeart(){ HEART.x=ARENA.x+ARENA.w/2; HEART.y=ARENA.y+ARENA.h/2; }
function updateHPUI(){ hpFill.style.width=(260*Math.max(0,HEART.hp/HEART.hpMax))+'px'; hpVal.textContent=`${HEART.hp}/${HEART.hpMax}`; }
function say(t){ bubble.style.display='block'; bubbleText.textContent=t; }
function hideSay(){ bubble.style.display='none'; }
function toastMsg(m){ toast.textContent=m; toast.classList.add('show'); setTimeout(()=>toast.classList.remove('show'),900); }

/* -------- State -------- */
let time=0, turn=TURN.PLAYER, mode='main', waveCount=0;
let bullets=[], attack=null, attackSeq=null, attackIx=0, damagePopup=null, showArena=false;
let bossIndex=(typeof SAVE.bossIndex==='number')?SAVE.bossIndex:0;
let BOSS=null;

/* -------- Helpers & drawing -------- */
const rand=(a,b)=>Math.random()*(b-a)+a;
function glow(x,y,r,fill,a=0.25){ ctx.save(); ctx.globalAlpha=a; ctx.fillStyle=fill; ctx.beginPath(); ctx.arc(x,y,r,0,Math.PI*2); ctx.fill(); ctx.restore(); }
function drawHeart(x,y,color=HEART_COLOR,scale=0.8){
  ctx.save(); ctx.translate(x,y); ctx.scale(scale,scale);
  const m=[[0,1,1,0,0,1,1,0],[1,1,1,1,1,1,1,1],[1,1,1,1,1,1,1,1],[0,1,1,1,1,1,1,0],[0,0,1,1,1,1,0,0],[0,0,0,1,1,0,0,0]];
  ctx.fillStyle=color; const s=3;
  for(let r=0;r<m.length;r++) for(let c=0;c<m[r].length;c++) if(m[r][c]) ctx.fillRect((c-4)*s,(r-3)*s,s,s);
  ctx.restore();
}
/* Detailed character base */
function drawBaseDetailed(x,y,colors,t){
  glow(x,y,68,colors.aura,0.30); glow(x,y,36,colors.aura2||colors.aura,0.18);
  ctx.fillStyle=colors.head; ctx.beginPath(); ctx.arc(x, y-34, 12.5, 0, Math.PI*2); ctx.fill();
  ctx.fillStyle='#222'; ctx.beginPath(); ctx.arc(x-4,y-38,1.6,0,Math.PI*2); ctx.fill(); ctx.beginPath(); ctx.arc(x+4,y-38,1.6,0,Math.PI*2); ctx.fill();
  const g=ctx.createLinearGradient(x,y-24,x,y+20); g.addColorStop(0,colors.body); g.addColorStop(1,'#00000022');
  ctx.fillStyle=g; ctx.fillRect(x-10, y-24, 20, 44);
  ctx.fillStyle=colors.accent; ctx.fillRect(x-24,y-18,12,30); ctx.fillRect(x+12,y-18,12,30);
  ctx.fillStyle=colors.body; ctx.fillRect(x-10, y+18, 8, 22); ctx.fillRect(x+2, y+18, 8, 22);
  ctx.strokeStyle=colors.emblem||'#fff3b8'; ctx.lineWidth=1.6; ctx.beginPath(); ctx.arc(x, y-12, 6+Math.sin(t*3)*0.8,0,Math.PI*2); ctx.stroke();
}
/* Boss sprites */
function dSolar(t){ const x=480,y=240+Math.sin(t*2.4)*2; drawBaseDetailed(x,y,{aura:'#fff3b8',aura2:'#ffe9a0',head:'#ffefb0',body:'#ffd166',accent:'#ffe69a',emblem:'#ffd166'},t); }
function dEmber(t){ const x=480,y=240+Math.sin(t*2.4)*2; drawBaseDetailed(x,y,{aura:'#ffb7a7',aura2:'#ffc7b8',head:'#ffd3c7',body:'#ffa277',accent:'#ffc2a4',emblem:'#ffbca0'},t); }
function dAbyss(t){ const x=480,y=242+Math.sin(t*2.2)*2; drawBaseDetailed(x,y,{aura:'#b0a0ff',aura2:'#c7c0ff',head:'#e5e1ff',body:'#a89bff',accent:'#d7cffc',emblem:'#c9c1ff'},t); }
function dMantis(t){ const x=480,y=238+Math.sin(t*2.2)*2; drawBaseDetailed(x,y,{aura:'#ffe88a',aura2:'#fff2aa',head:'#fff5c0',body:'#ffd166',accent:'#ffeaa6',emblem:'#ffe27a'},t); }
function dPixel(t){ const x=480,y=240+Math.sin(t*2)*2; drawBaseDetailed(x,y,{aura:'#9fe0ff',aura2:'#bff0ff',head:'#dafeff',body:'#a8ecff',accent:'#bff3ff',emblem:'#a8ecff'},t); }
function dFrost(t){ const x=480,y=238+Math.sin(t*2)*2; drawBaseDetailed(x,y,{aura:'#bfe7ff',aura2:'#d4f2ff',head:'#e6f7ff',body:'#d0f0ff',accent:'#c5ecff',emblem:'#bfe7ff'},t); }
function dDJ(t){ const x=480,y=242+Math.sin(t*2.2)*2; drawBaseDetailed(x,y,{aura:'#ffb0b0',aura2:'#ffc3c3',head:'#ffd0d0',body:'#ff9090',accent:'#ffb7b7',emblem:'#ffaaaa'},t); }
function dVoid(t){ const x=480,y=236+Math.sin(t*2.2)*2; drawBaseDetailed(x,y,{aura:'#d6c8ff',aura2:'#e6dcff',head:'#efe9ff',body:'#c9b9ff',accent:'#dacfff',emblem:'#c9b9ff'},t); }
function dSiren(t){ const x=480,y=240+Math.sin(t*2.4)*2; drawBaseDetailed(x,y,{aura:'#66ccff',aura2:'#88d9ff',head:'#aaddff',body:'#66ccff',accent:'#99ddff',emblem:'#66ccff'},t); }
function dStorm(t){ const x=480,y=238+Math.sin(t*2.4)*2; drawBaseDetailed(x,y,{aura:'#fff59a',aura2:'#fffac4',head:'#fffbd1',body:'#ffd455',accent:'#ffec8a',emblem:'#ffe066'},t); }
function dObliv(t){ const x=480,y=236+Math.sin(t*2.4)*2; drawBaseDetailed(x,y,{aura:'#1a141c',aura2:'#221a27',head:'#2a2230',body:'#0b0a0d',accent:'#3b3244',emblem:'#ffd166'},t); }
/* New bosses */
function dChrono(t){ const x=480,y=238+Math.sin(t*2.0)*2; drawBaseDetailed(x,y,{aura:'#a0ffd6',aura2:'#c2ffe7',head:'#e9fff7',body:'#64f0c2',accent:'#b9ffe9',emblem:'#a0ffd6'},t); }
function dAurora(t){ const x=480,y=240+Math.sin(t*2.1)*2; drawBaseDetailed(x,y,{aura:'#ffb6f2',aura2:'#ffc9f6',head:'#ffe6fb',body:'#ff91e6',accent:'#ffc3f3',emblem:'#ffd6f8'},t); }

/* -------- Spawning & phases -------- */
function spawn(b){ b.t=0; bullets.push(b); return b; }
function spawnAimed(fx,fy,speed,dmg,col='#fff',r=3,lead=DIFF.lead){
  const vx0=(HEART.x-(HEART._px||HEART.x))/(HEART._pdt||1/60);
  const vy0=(HEART.y-(HEART._py||HEART.y))/(HEART._pdt||1/60);
  const dx=HEART.x-fx, dy=HEART.y-fy, L=Math.hypot(dx,dy)||1;
  const vx=(dx/L)*speed*DIFF.spd + vx0*lead, vy=(dy/L)*speed*DIFF.spd + vy0*lead;
  return spawn({x:fx,y:fy,vx,vy,r, col, dmg:Math.max(1,Math.floor(dmg*DIFF.dmg))});
}
function ring(C,spd,col,dmg,n=12){ for(let k=0;k<n;k++){ const a=k/n*Math.PI*2; spawn({x:C.x,y:C.y,vx:Math.cos(a)*spd*DIFF.spd,vy:Math.sin(a)*spd*DIFF.spd,r:3,col,dmg}); } }

function phaseWrap(dur, update){ let t=0; return { enter(){t=0;}, update(dt){t+=dt; update(dt,t);}, done(){return t>=dur;} }; }
function phase(dur,...parts){ let t=0; return { enter(){t=0;parts.forEach(p=>p.enter&&p.enter());}, update(dt){t+=dt;parts.forEach(p=>p.update&&p.update(dt));}, done(){return t>=dur;} }; }

/* -------- Patterns library -------- */
/* Solar */
const pSolarFan=(d=3)=>{let t=0,g=0,rate=.22/DIFF.rate;const c={x:ARENA.x+ARENA.w/2,y:ARENA.y+18};return{enter(){},update(dt){dt*=GLOBAL_SPEED;t+=dt;g+=dt;if(g>=rate){g=0;const base=rand(-0.4,0.4);for(const a of [base-0.7,base,base+0.7])spawn({x:c.x,y:c.y,vx:Math.cos(a)*250*DIFF.spd,vy:Math.sin(a)*250*DIFF.spd,r:3,col:'#fff3b8',dmg:5});}},done(){return t>=d;}}};
const pSolarRing=(d=3)=>{let t=0,g=0,rate=.5/DIFF.rate;const C={x:ARENA.x+ARENA.w/2,y:ARENA.y+ARENA.h/2};return{enter(){},update(dt){dt*=GLOBAL_SPEED;t+=dt;g+=dt;if(g>=rate){g=0;ring(C,255,'#ffd166',6,14)}},done(){return t>=d;}}};
const pSolarWall=(d=3)=>{let t=0,g=0,rate=.36/DIFF.rate;return{enter(){},update(dt){dt*=GLOBAL_SPEED;t+=dt;g+=dt;if(g>=rate){g=0;const left=Math.random()<0.5;for(let i=0;i<5;i++){const y=ARENA.y+20+i*30;spawn({x:left?ARENA.x-24:ARENA.x+ARENA.w+24,y,vx:(left?1:-1)*260*DIFF.spd,vy:0,r:3,col:'#ffe9a0',dmg:6});}}},done(){return t>=d;}}};
const pSolarSpiral=(d=3)=>{let t=0,g=0,rate=.2/DIFF.rate;return{enter(){},update(dt){dt*=GLOBAL_SPEED;t+=dt;g+=dt;if(g>=rate){g=0;const a=t*2.4;spawn({x:ARENA.x+ARENA.w/2,y:ARENA.y+10,vx:Math.cos(a)*250*DIFF.spd,vy:Math.sin(a)*250*DIFF.spd,r:3,col:'#ffd166',dmg:6});}},done(){return t>=d;}}};
const pSolarCross=(d=3)=>{let t=0,g=0,rate=.5/DIFF.rate;return{enter(){},update(dt){dt*=GLOBAL_SPEED;t+=dt;g+=dt;if(g>=rate){g=0;const mid={x:ARENA.x+ARENA.w/2,y:ARENA.y+ARENA.h/2};['h','v'].forEach(ax=>{for(let k=-3;k<=3;k++){if(ax==='h') spawn({x:ARENA.x-20,y:mid.y+k*20,vx:270*DIFF.spd,vy:0,r:3,col:'#fff1b6',dmg:5}); else spawn({x:mid.x+k*20,y:ARENA.y-20,vx:0,vy:270*DIFF.spd,r:3,col:'#fff1b6',dmg:5});}})}},done(){return t>=d;}}};

/* Ember */
const pEmberRain=(d=3.2)=>{let t=0,g=0,rate=.16/DIFF.rate;return{enter(){},update(dt){dt*=GLOBAL_SPEED;t+=dt;g+=dt;if(g>=rate){g=0;const x=ARENA.x+rand(10,ARENA.w-10);spawn({x,y:ARENA.y-18,vx:rand(-60,60),vy:240*DIFF.spd,r:3,col:'#ffb7a7',dmg:4});}},done(){return t>=d;}}};
const pEmberHoming=(d=3)=>{let t=0,g=0,rate=.46/DIFF.rate;return{enter(){},update(dt){dt*=GLOBAL_SPEED;t+=dt;g+=dt;if(g>=rate){g=0;const x=ARENA.x+rand(0,ARENA.w);spawnAimed(x,ARENA.y-10,210,5,'#ffd3a0',4,DIFF.lead*0.6);}},done(){return t>=d;}}};
const pEmberSweep=(d=3)=>{let t=0,g=0,rate=.42/DIFF.rate;return{enter(){},update(dt){dt*=GLOBAL_SPEED;t+=dt;g+=dt;if(g>=rate){g=0;const y=ARENA.y+rand(22,ARENA.h-22);spawn({x:ARENA.x-24,y,vx:270*DIFF.spd,vy:0,r:3,col:'#ffa277',dmg:5});spawn({x:ARENA.x+ARENA.w+24,y,vx:-270*DIFF.spd,vy:0,r:3,col:'#ffa277',dmg:5});}},done(){return t>=d;}}};
const pEmberArc=(d=3)=>{let t=0,g=0,rate=.28/DIFF.rate;return{enter(){},update(dt){dt*=GLOBAL_SPEED;t+=dt;g+=dt;if(g>=rate){g=0;const c={x:ARENA.x+ARENA.w/2,y:ARENA.y+6};for(let k=0;k<9;k++){const a=(-Math.PI/2)+k*(Math.PI/8);spawn({x:c.x,y:c.y,vx:Math.cos(a)*240*DIFF.spd,vy:Math.sin(a)*240*DIFF.spd,r:3,col:'#ffc4a3',dmg:5});}}},done(){return t>=d;}}};
const pEmberBurst=(d=3)=>{let t=0,g=0,rate=.55/DIFF.rate;const C={x:ARENA.x+ARENA.w/2,y:ARENA.y+ARENA.h/2};return{enter(){},update(dt){dt*=GLOBAL_SPEED;t+=dt;g+=dt;if(g>=rate){g=0;ring(C,235,'#ffb286',5,12)}},done(){return t>=d;}}};

/* Abyss */
const pAbyssBounce=(d=3)=>{let t=0,g=0,rate=.28/DIFF.rate;return{enter(){},update(dt){dt*=GLOBAL_SPEED;t+=dt;g+=dt;if(g>=rate){g=0;const y=ARENA.y+rand(24,ARENA.h-24);const vx=(Math.random()<0.5?1:-1)*260*DIFF.spd;spawn({x:vx>0?ARENA.x-20:ARENA.x+ARENA.w+20,y,vx,vy:0,r:3,col:'#b0a0ff',dmg:5,bounce:1});}for(const b of bullets){if(b.bounce && b.x>ARENA.x&&b.x<ARENA.x+ARENA.w && (b.y<ARENA.y+6||b.y>ARENA.y+ARENA.h-6)){b.vy*=-1;b.bounce--;}}},done(){return t>=d;}}};
const pAbyssFake=(d=3)=>{let t=0,g=0,rate=.44/DIFF.rate;return{enter(){},update(dt){dt*=GLOBAL_SPEED;t+=dt;g+=dt;if(g>=rate){g=0;const real=Math.random()<0.65;const left=Math.random()<0.5;const y=ARENA.y+rand(12,ARENA.h-12);spawn({x:left?ARENA.x-24:ARENA.x+ARENA.w+24,y,vx:(left?1:-1)*(real?275:160)*DIFF.spd,vy:0,r:3,col:real?'#a89bff':'#444',dmg:real?5:1});}},done(){return t>=d;}}};
const pAbyssClone=(d=3)=>{let t=0,g=0,rate=.5/DIFF.rate;return{enter(){},update(dt){dt*=GLOBAL_SPEED;t+=dt;g+=dt;if(g>=rate){g=0;const x=ARENA.x+rand(20,ARENA.w-20);const s=spawnAimed(x,ARENA.y-10,225,5,'#bfb3ff',3,DIFF.lead);s.split=0.45;}for(const b of bullets){if(b.split){b.split-=dt;if(b.split<=0&&!b.shot){b.shot=true;for(const a of [-0.45,0,0.45])spawn({x:b.x,y:b.y,vx:b.vx+Math.cos(a)*120,vy:b.vy+Math.sin(a)*120,r:3,col:'#cfc6ff',dmg:4});}}}},done(){return t>=d;}}};
const pAbyssRain=(d=3)=>{let t=0,g=0,rate=.2/DIFF.rate;return{enter(){},update(dt){dt*=GLOBAL_SPEED;t+=dt;g+=dt;if(g>=rate){g=0;const x=ARENA.x+rand(0,ARENA.w);spawn({x,y:ARENA.y-18,vx:rand(-40,40),vy:250*DIFF.spd,r:3,col:'#c0b3ff',dmg:4});}},done(){return t>=d;}}};
const pAbyssRing=(d=3)=>{let t=0,g=0,rate=.6/DIFF.rate;const C={x:ARENA.x+ARENA.w/2,y:ARENA.y+ARENA.h/2};return{enter(){},update(dt){dt*=GLOBAL_SPEED;t+=dt;g+=dt;if(g>=rate){g=0;ring(C,245,'#b9afff',6,16)}},done(){return t>=d;}}};

/* Mantis */
const pMantisFan=(d=3)=>{let t=0,g=0,rate=.3/DIFF.rate;return{enter(){},update(dt){dt*=GLOBAL_SPEED;t+=dt;g+=dt;if(g>=rate){g=0;const c={x:ARENA.x+ARENA.w/2,y:ARENA.y+36};const base=t*1.8;for(let k=0;k<7;k++){const a=base+k*(Math.PI*2/7);spawn({x:c.x,y:c.y,vx:Math.cos(a)*255*DIFF.spd,vy:Math.sin(a)*255*DIFF.spd,r:3,col:'#ffe88a',dmg:5});}}},done(){return t>=d;}}};
const pMantisDive=(d=3)=>{let t=0,g=0,rate=.42/DIFF.rate;return{enter(){},update(dt){dt*=GLOBAL_SPEED;t+=dt;g+=dt;if(g>=rate){g=0;const x=ARENA.x+rand(24,ARENA.w-24);const s=spawnAimed(x,ARENA.y-10,330,7,'#ffdf99',4,DIFF.lead*0.6);s.delay=0.25;s.vx*=0.6;s.vy*=0.6;}for(const b of bullets){if(b.delay){b.delay-=dt;if(b.delay<=0){b.vx*=1.6;b.vy*=1.6;b.delay=0;}}}},done(){return t>=d;}}};
const pMantisRain=(d=3)=>{let t=0,g=0,rate=.22/DIFF.rate;return{enter(){},update(dt){dt*=GLOBAL_SPEED;t+=dt;g+=dt;if(g>=rate){g=0;for(let i=0;i<7;i++){const x=ARENA.x+20+i*(ARENA.w-40)/6;spawn({x,y:ARENA.y-18,vx:0,vy:230*DIFF.spd,r:3,col:'#fff3b8',dmg:4});}}},done(){return t>=d;}}};
const pMantisLine=(d=3)=>{let t=0,g=0,rate=.4/DIFF.rate;return{enter(){},update(dt){dt*=GLOBAL_SPEED;t+=dt;g+=dt;if(g>=rate){g=0;const y=ARENA.y+ARENA.h-10;for(let i=0;i<8;i++){const x=ARENA.x+10+i*(ARENA.w-20)/7;spawn({x,y,vx:0,vy:-260*DIFF.spd,r:3,col:'#ffe27a',dmg:5});}}},done(){return t>=d;}}};
const pMantisArc=(d=3)=>{let t=0,g=0,rate=.34/DIFF.rate;return{enter(){},update(dt){dt*=GLOBAL_SPEED;t+=dt;g+=dt;if(g>=rate){g=0;const c={x:ARENA.x+ARENA.w/2,y:ARENA.y+ARENA.h-6};for(let k=0;k<9;k++){const a=(Math.PI/2)+k*(Math.PI/10);spawn({x:c.x,y:c.y,vx:Math.cos(a)*260*DIFF.spd,vy:Math.sin(a)*260*DIFF.spd,r:3,col:'#ffd166',dmg:5});}}},done(){return t>=d;}}};

/* Pixel */
const pPixelLanes=(d=3)=>{let t=0,g=0,rate=.18/DIFF.rate;return{enter(){},update(dt){dt*=GLOBAL_SPEED;t+=dt;g+=dt;if(g>=rate){g=0;const y=ARENA.y+rand(14,ARENA.h-14);const left=Math.random()<0.5;spawn({x:left?ARENA.x-24:ARENA.x+ARENA.w+24,y,vx:(left?1:-1)*270*DIFF.spd,vy:0,r:3,col:'#a8ecff',dmg:5});}},done(){return t>=d;}}};
const pPixelTeleport=(d=3)=>{let t=0,g=0,rate=.5/DIFF.rate;const C={x:ARENA.x+ARENA.w/2,y:ARENA.y+ARENA.h/2};return{enter(){},update(dt){dt*=GLOBAL_SPEED;t+=dt;g+=dt;if(g>=rate){g=0;const n=10;for(let k=0;k<n;k++){const a=k/n*Math.PI*2;spawn({x:C.x,y:C.y,vx:Math.cos(a)*230*DIFF.spd,vy:Math.sin(a)*230*DIFF.spd,r:3,col:'#bdf4ff',dmg:5,tele:0.35+Math.random()*0.2});}}for(const b of bullets){if(b.tele){b.tele-=dt;if(b.tele<=0){b.x=ARENA.x+rand(0,ARENA.w);b.y=ARENA.y+rand(0,ARENA.h);b.tele=0;}}}},done(){return t>=d;}}};
const pPixelLag=(d=3)=>{let t=0,g=0,rate=.46/DIFF.rate;return{enter(){},update(dt){dt*=GLOBAL_SPEED;t+=dt;g+=dt;if(g>=rate){g=0;const bb=spawnAimed(ARENA.x+rand(0,ARENA.w),ARENA.y-10,170,5,'#7fdcff',3,DIFF.lead*0.5);bb.speedUp=0.7;}for(const b of bullets){if(b.speedUp){b.speedUp-=dt;if(b.speedUp<=0){b.vx*=1.9;b.vy*=1.9;b.speedUp=0;}}}},done(){return t>=d;}}};
const pPixelGrid=(d=3)=>{let t=0,g=0,rate=.6/DIFF.rate;return{enter(){},update(dt){dt*=GLOBAL_SPEED;t+=dt;g+=dt;if(g>=rate){g=0;for(let i=0;i<5;i++){const x=ARENA.x+20+i*(ARENA.w-40)/4;spawn({x,y:ARENA.y-18,vx:0,vy:250*DIFF.spd,r:3,col:'#9fe0ff',dmg:5});}}},done(){return t>=d;}}};
const pPixelBurst=(d=3)=>{let t=0,g=0,rate=.55/DIFF.rate;const c={x:ARENA.x+ARENA.w/2,y:ARENA.y+ARENA.h/2};return{enter(){},update(dt){dt*=GLOBAL_SPEED;t+=dt;g+=dt;if(g>=rate){g=0;ring(c,235,'#a8ecff',6,10)}},done(){return t>=d;}}};

/* Frost */
const pFrostWall=(d=3)=>{let t=0,g=0,rate=.46/DIFF.rate;return{enter(){},update(dt){dt*=GLOBAL_SPEED;t+=dt;g+=dt;if(g>=rate){g=0;for(let i=0;i<6;i++){const x=ARENA.x+40+i*70;spawn({x,y:ARENA.y-18,vx:0,vy:235*DIFF.spd,r:3,col:'#d0f0ff',dmg:5});}}},done(){return t>=d;}}};
const pFrostFan=(d=3)=>{let t=0,g=0,rate=.34/DIFF.rate;return{enter(){},update(dt){dt*=GLOBAL_SPEED;t+=dt;g+=dt;if(g>=rate){g=0;const C={x:ARENA.x+ARENA.w/2,y:ARENA.y+10};const n=9,flip=(Math.floor(t*3)%2)===0;for(let k=0;k<n;k++){const a=((k/(n-1))-0.5)*(Math.PI/1.8)*(flip?-1:1);spawn({x:C.x,y:C.y,vx:Math.cos(a)*235*DIFF.spd,vy:Math.sin(a)*235*DIFF.spd,r:3,col:'#e6f7ff',dmg:5});}}},done(){return t>=d;}}};
const pFrostPulse=(d=3)=>{let t=0,g=0,rate=.7/DIFF.rate;return{enter(){},update(dt){dt*=GLOBAL_SPEED;t+=dt;g+=dt;if(g>=rate){g=0;HEART.sp=260;setTimeout(()=>HEART.sp=320,600);ring({x:ARENA.x+ARENA.w/2,y:ARENA.y+ARENA.h/2},220,'#d0f0ff',5,10)}},done(){return t>=d;}}};
const pFrostRain=(d=3)=>{let t=0,g=0,rate=.26/DIFF.rate;return{enter(){},update(dt){dt*=GLOBAL_SPEED;t+=dt;g+=dt;if(g>=rate){g=0;const x=ARENA.x+rand(0,ARENA.w);spawn({x,y:ARENA.y-18,vx:0,vy:260*DIFF.spd,r:3,col:'#bfe7ff',dmg:5});}}},done(){return t>=d;}}};
const pFrostShards=(d=3)=>{let t=0,g=0,rate=.42/DIFF.rate;return{enter(){},update(dt){dt*=GLOBAL_SPEED;t+=dt;g+=dt;if(g>=rate){g=0;for(let k=0;k<8;k++){const y=ARENA.y+10+k*(ARENA.h-20)/7;spawn({x:ARENA.x-20,y,vx:280*DIFF.spd,vy:0,r:3,col:'#c5ecff',dmg:5});}}},done(){return t>=d;}}};

/* DJ */
const pDJLanes=(d=3)=>{let t=0,g=0,rate=.2/DIFF.rate;return{enter(){},update(dt){dt*=GLOBAL_SPEED;t+=dt;g+=dt;if(g>=rate){g=0;const n=5;for(let i=0;i<n;i++){const y=ARENA.y+20+i*(ARENA.h-40)/(n-1);const left=Math.random()<0.5;spawn({x:left?ARENA.x-24:ARENA.x+ARENA.w+24,y,vx:(left?1:-1)*(260+Math.sin(t*6+i)*40)*DIFF.spd,vy:0,r:3,col:'#ff9aaa',dmg:5});}}},done(){return t>=d;}}};
const pDJDrop=(d=3)=>{let t=0,g=0,rate=.72/DIFF.rate;const c={x:ARENA.x+ARENA.w/2,y:ARENA.y+ARENA.h/2};return{enter(){},update(dt){dt*=GLOBAL_SPEED;t+=dt;g+=dt;if(g>=rate){g=0;ring(c,270,'#ffb0b0',6,10)}},done(){return t>=d;}}};
const pDJSpiral=(d=3)=>{let t=0,g=0,rate=.22/DIFF.rate;return{enter(){},update(dt){dt*=GLOBAL_SPEED;t+=dt;g+=dt;if(g>=rate){g=0;const a=t*2.1;spawn({x:ARENA.x+ARENA.w/2,y:ARENA.y+ARENA.h/2,vx:Math.cos(a)*245*DIFF.spd,vy:Math.sin(a)*245*DIFF.spd,r:3,col:'#ff99a9',dmg:5});}},done(){return t>=d;}}};
const pDJBeat=(d=3)=>{let t=0,g=0,rate=.5/DIFF.rate;return{enter(){},update(dt){dt*=GLOBAL_SPEED;t+=dt;g+=dt;const pulse=(Math.sin(t*6)>0.85);if(pulse){for(let i=0;i<10;i++){const y=ARENA.y+rand(10,ARENA.h-10);spawn({x:ARENA.x-20,y,vx:300*DIFF.spd,vy:0,r:3,col:'#ffb7c7',dmg:5});}}},done(){return t>=d;}}};
const pDJWave=(d=3)=>{let t=0,g=0,rate=.28/DIFF.rate;return{enter(){},update(dt){dt*=GLOBAL_SPEED;t+=dt;g+=dt;if(g>=rate){g=0;for(let i=0;i<6;i++){const x=ARENA.x+15+i*(ARENA.w-30)/5;spawn({x,y:ARENA.y-16,vx:0,vy:245*DIFF.spd,r:3,col:'#ffb0b0',dmg:5});}}},done(){return t>=d;}}};

/* Void + Siren + Storm (already defined elsewhere) */
const pVoidWell=(d=3)=>{let t=0;const C={x:ARENA.x+ARENA.w/2,y:ARENA.y+ARENA.h/2};return{enter(){},update(dt){dt*=GLOBAL_SPEED;t+=dt;const pull=(BOSS.flags.pullReduce||1);const dx=C.x-HEART.x,dy=C.y-HEART.y;HEART.x+=dx*0.38*pull*dt;HEART.y+=dy*0.38*pull*dt;if(Math.random()<0.2){const a=Math.random()*Math.PI*2;spawn({x:C.x,y:C.y,vx:Math.cos(a)*270*DIFF.spd,vy:Math.sin(a)*270*DIFF.spd,r:3,col:'#c9b9ff',dmg:6});}},done(){return t>=d;}}};
const pVoidOrbit=(d=3)=>{let t=0,g=0,rate=.5/DIFF.rate;return{enter(){},update(dt){dt*=GLOBAL_SPEED;t+=dt;g+=dt;if(g>=rate){g=0;const n=8;for(let k=0;k<n;k++){const a=k/n*Math.PI*2;spawn({x:HEART.x+Math.cos(a)*60,y:HEART.y+Math.sin(a)*60,vx:0,vy:0,r:3,col:'#bfb2ff',dmg:5,orbit:true,ang:a});}}for(const bb of bullets){if(bb.orbit){bb.ang+=dt*2.0;bb.x=HEART.x+Math.cos(bb.ang)*70;bb.y=HEART.y+Math.sin(bb.ang)*70;if(Math.random()<0.03){const dx=HEART.x-bb.x,dy=HEART.y-bb.y;const L=Math.hypot(dx,dy)||1;bb.vx=dx/L*285*DIFF.spd;bb.vy=dy/L*285*DIFF.spd;bb.orbit=false;}}}},done(){return t>=d;}}};
const pVoidCollapse=(d=3)=>{let t=0,g=0,rate=.38/DIFF.rate;let rad=Math.max(ARENA.w,ARENA.h)*0.55;const C={x:ARENA.x+ARENA.w/2,y:ARENA.y+ARENA.h/2};return{enter(){},update(dt){dt*=GLOBAL_SPEED;t+=dt;g+=dt;rad=Math.max(24,rad-140*dt);if(g>=rate){g=0;const n=10;for(let k=0;k<n;k++){const a=k/n*Math.PI*2;spawn({x:C.x+Math.cos(a)*rad,y:C.y+Math.sin(a)*rad,vx:-Math.cos(a)*230*DIFF.spd,vy:-Math.sin(a)*230*DIFF.spd,r:3,col:'#d4c8ff',dmg:6});}}},done(){return t>=d;}}};

const pSirenWave=(d=3)=>{let t=0,g=0,rate=.25/DIFF.rate;return{enter(){},update(dt){dt*=GLOBAL_SPEED;t+=dt;g+=dt;if(g>=rate){g=0;for(let i=0;i<8;i++){const x=ARENA.x+20+i*(ARENA.w-40)/7;spawn({x,y:ARENA.y-18,vx:0,vy:220*DIFF.spd,r:3,col:'#66ccff',dmg:5});}}},done(){return t>=d;}}};
const pSirenBubble=(d=3)=>{let t=0,g=0,rate=.42/DIFF.rate;return{enter(){},update(dt){dt*=GLOBAL_SPEED;t+=dt;g+=dt;if(g>=rate){g=0;const cx=ARENA.x+rand(0,ARENA.w);spawnAimed(cx,ARENA.y-10,190,5,'#99ddff',5,DIFF.lead*0.5);}},done(){return t>=d;}}};
const pSirenTsunami=(d=3)=>{let t=0,g=0,rate=.5/DIFF.rate;return{enter(){},update(dt){dt*=GLOBAL_SPEED;t+=dt;g+=dt;if(g>=rate){g=0;const c={x:ARENA.x+ARENA.w/2,y:ARENA.y+ARENA.h/2};ring(c,240,'#88d9ff',6,14)}},done(){return t>=d;}}};

const pStormZig=(d=3)=>{let t=0,g=0,rate=.22/DIFF.rate;return{enter(){},update(dt){dt*=GLOBAL_SPEED;t+=dt;g+=dt;if(g>=rate){g=0;const left=Math.random()<0.5;const y=ARENA.y+rand(14,ARENA.h-14);const v=(left?1:-1)*(280+Math.sin(t*8)*50)*DIFF.spd;spawn({x:left?ARENA.x-24:ARENA.x+ARENA.w+24,y,vx:v,vy:0,r:3,col:'#ffe066',dmg:7,zig:1});}for(const b of bullets){if(b.zig){b.vy=Math.sin((b.t||0)*12)*90;}}},done(){return t>=d;}}};
const pStormBolts=(d=3)=>{let t=0,g=0,rate=.32/DIFF.rate;return{enter(){},update(dt){dt*=GLOBAL_SPEED;t+=dt;g+=dt;if(g>=rate){g=0;for(let i=0;i<4;i++){const x=ARENA.x+rand(20,ARENA.w-20);spawn({x,y:ARENA.y-18,vx:0,vy:320*DIFF.spd,r:4,col:'#ffea80',dmg:8});}}},done(){return t>=d;}}};
const pStormChain=(d=3)=>{let t=0,g=0,rate=.42/DIFF.rate;return{enter(){},update(dt){dt*=GLOBAL_SPEED;t+=dt;g+=dt;if(g>=rate){g=0;const c={x:ARENA.x+ARENA.w/2,y:ARENA.y+ARENA.h/2};const n=10;for(let k=0;k<n;k++){const a=k/n*Math.PI*2;const b=spawn({x:c.x,y:c.y,vx:Math.cos(a)*275*DIFF.spd,vy:Math.sin(a)*275*DIFF.spd,r:3,col:'#fff59a',dmg:7});b.chain=0.35;}}for(const bb of bullets){if(bb.chain){bb.chain-=dt;if(bb.chain<=0&&!bb.split){bb.split=true;for(const a of [-0.35,0,0.35])spawn({x:bb.x,y:bb.y,vx:bb.vx+Math.cos(a)*140,vy:bb.vy+Math.sin(a)*140,r:3,col:'#fff59a',dmg:6});}}}},done(){return t>=d;}}};

/* Chrono (new): reuse frost/pixel/void with time vibes */
const pChronoPulse=(d=3)=>pFrostPulse(d);
const pChronoOrbit=(d=3)=>pVoidOrbit(d);
const pChronoLag=(d=3)=>pPixelLag(d);
const pChronoRing=(d=3)=>pSolarRing(d);
const pChronoBolts=(d=3)=>pStormBolts(d);

/* Aurora (new): colorful waves and fans) */
const pAuroraWave=(d=3)=>pSirenWave(d);
const pAuroraFan=(d=3)=>pFrostFan(d);
const pAuroraTeleport=(d=3)=>pPixelTeleport(d);
const pAuroraRain=(d=3)=>pEmberRain(d);
const pAuroraRing=(d=3)=>pPixelBurst(d);

/* -------- Boss roster (12, each with 5 attacks) -------- */
const BOSSES = [
  { key:'solar', name:'Solar Fang', hpMax:380, draw:dSolar,
    intro:["The sun bows to no one.","Step into the flare, "+PLAYER_NAME+".","Hold."],
    lines:["Burn bright.","Hold your ground.","Endure.","Again."],
    mercyNeed:3,
    actDefs:[
      {name:'Bow', say:"Respect accepted.", effect:s=>{s.mercy=(s.mercy||0)+1;}},
      {name:'Compliment', say:"Your courage glows.", effect:s=>{s.mercy=(s.mercy||0)+1;}},
      {name:'Focus', say:"Steady breath.", effect:s=>{HEART.i=Math.max(HEART.i,0.7);}},
      {name:'Taunt', say:"Heat rises.", effect:s=>{s.flags.boost=1.15;}}
    ],
    attacks:()=>[
      phase(3,pSolarFan(3)),
      phase(3,pSolarRing(3)),
      phase(3,pSolarWall(3)),
      phase(3,pSolarSpiral(3)),
      phase(3,pSolarCross(3))
    ]
  },
  { key:'ember', name:'Ember Seraph', hpMax:360, draw:dEmber,
    intro:["Ash remembers flame.","We move softly.","Match my tempo."],
    lines:["Inhale.","Soft steps.","Patience.","You learn."],
    mercyNeed:3,
    actDefs:[
      {name:'Listen', say:"Silence shared.", effect:s=>{s.mercy=(s.mercy||0)+1; s.flags.nextSlow=0.82;}},
      {name:'Apologize', say:"Forgiven.", effect:s=>{s.mercy=(s.mercy||0)+1;}},
      {name:'Hum', say:"On pitch.", effect:s=>{s.mercy=(s.mercy||0)+1;}},
      {name:'Smile', say:"Warmth spreads.", effect:s=>{HEART.hp=Math.min(HEART.hpMax,HEART.hp+6); updateHPUI();}}
    ],
    attacks:()=>[
      phase(3.2,pEmberRain(3.2)),
      phase(3,pEmberHoming(3)),
      phase(3,pEmberSweep(3)),
      phase(3,pEmberArc(3)),
      phase(3,pEmberBurst(3))
    ]
  },
  { key:'abyss', name:'Abyss Jester', hpMax:370, draw:dAbyss,
    intro:["Smile through the dark.","Ready to play?","Look twice."],
    lines:["Ping.","Missed it.","Look closer.","Heh."],
    mercyNeed:3,
    actDefs:[
      {name:'Wave', say:"Wave returned.", effect:s=>{s.mercy=(s.mercy||0)+1;}},
      {name:'Laugh', say:"Heh.", effect:s=>{s.mercy=(s.mercy||0)+1;}},
      {name:'Compliment', say:"Flattery accepted.", effect:s=>{s.mercy=(s.mercy||0)+1;}},
      {name:'Ignore', say:"Bold.", effect:s=>{s.flags.boost=1.06;}}
    ],
    attacks:()=>[
      phase(3,pAbyssBounce(3)),
      phase(3,pAbyssFake(3)),
      phase(3,pAbyssClone(3)),
      phase(3,pAbyssRain(3)),
      phase(3,pAbyssRing(3))
    ]
  },
  { key:'mantis', name:'Golden Mantis', hpMax:400, draw:dMantis,
    intro:["Stillness. Then strike.","Measure the gap.","Blink and step."],
    lines:["Watch the arc.","Closer.","Precise.","Intent."],
    mercyNeed:3,
    actDefs:[
      {name:'Bow', say:"Gesture noted.", effect:s=>{s.mercy=(s.mercy||0)+1;}},
      {name:'Compliment', say:"Golden discipline.", effect:s=>{s.mercy=(s.mercy||0)+1; s.flags.nextSlow=0.9;}},
      {name:'Calm', say:"Breath lowers.", effect:s=>{HEART.i=Math.max(HEART.i,0.65);}},
      {name:'Dodge', say:"Good step.", effect:s=>{s.mercy=(s.mercy||0)+1;}}
    ],
    attacks:()=>[
      phase(3,pMantisFan(3)),
      phase(3,pMantisDive(3)),
      phase(3,pMantisRain(3)),
      phase(3,pMantisLine(3)),
      phase(3,pMantisArc(3))
    ]
  },
  { key:'pixel', name:'Pixel Phantom', hpMax:360, draw:dPixel,
    intro:["gl1tch... r3ady?","rendering fear...","hold the frame."],
    lines:["tearing...","lag spike","packet lost","reboot soon"],
    mercyNeed:3,
    actDefs:[
      {name:'Debug', say:"errors reduced.", effect:s=>{s.mercy=(s.mercy||0)+1; s.flags.nextSlow=0.85;}},
      {name:'Compliment', say:"shader praised.", effect:s=>{s.mercy=(s.mercy||0)+1;}},
      {name:'Reboot', say:"temp calm.", effect:s=>{HEART.i=Math.max(HEART.i,0.75);}},
      {name:'Ignore', say:"…", effect:s=>{}}
    ],
    attacks:()=>[
      phase(3,pPixelLanes(3)),
      phase(3,pPixelTeleport(3)),
      phase(3,pPixelLag(3)),
      phase(3,pPixelGrid(3)),
      phase(3,pPixelBurst(3))
    ]
  },
  { key:'frost', name:'Frostbite Warden', hpMax:390, draw:dFrost,
    intro:["Cold clarifies.","Hold steady.","No flinching."],
    lines:["Breathe fog.","Still water.","Brace.","Now."],
    mercyNeed:3,
    actDefs:[
      {name:'Shiver', say:"Accepted.", effect:s=>{s.mercy=(s.mercy||0)+1;}},
      {name:'Respect', say:"Noted.", effect:s=>{s.mercy=(s.mercy||0)+1; s.flags.nextSlow=0.85;}},
      {name:'Warmth', say:"Fingers thaw.", effect:s=>{HEART.hp=Math.min(HEART.hpMax,HEART.hp+5); updateHPUI();}},
      {name:'Apologize', say:"Forgiven.", effect:s=>{s.mercy=(s.mercy||0)+1;}}
    ],
    attacks:()=>[
      phase(3,pFrostWall(3)),
      phase(3,pFrostFan(3)),
      phase(3,pFrostPulse(3)),
      phase(3,pFrostRain(3)),
      phase(3,pFrostShards(3))
    ]
  },
  { key:'dj', name:'Crimson DJ', hpMax:380, draw:dDJ,
    intro:["drop the bass.","move your feet.","on the one."],
    lines:["bop","beat","sync","step"],
    mercyNeed:3,
    actDefs:[
      {name:'Dance', say:"on tempo.", effect:s=>{s.mercy=(s.mercy||0)+1;}},
      {name:'Compliment', say:"fresh mix.", effect:s=>{s.mercy=(s.mercy||0)+1;}},
      {name:'Sync', say:"locked in.", effect:s=>{s.flags.nextSlow=0.9;}},
      {name:'Boo', say:"lol.", effect:s=>{}}
    ],
    attacks:()=>[
      phase(3,pDJLanes(3)),
      phase(3,pDJDrop(3)),
      phase(3,pDJSpiral(3)),
      phase(3,pDJBeat(3)),
      phase(3,pDJWave(3))
    ]
  },
  { key:'void', name:'Void Prophet', hpMax:420, draw:dVoid,
    intro:["gravity listens.","do you?","choose your orbit."],
    lines:["fall inward","hush","orbit","release"],
    mercyNeed:4,
    actDefs:[
      {name:'Listen', say:"heard.", effect:s=>{s.mercy=(s.mercy||0)+1;}},
      {name:'Bow', say:"seen.", effect:s=>{s.mercy=(s.mercy||0)+1;}},
      {name:'Meditate', say:"settled.", effect:s=>{HEART.i=Math.max(HEART.i,0.8);}},
      {name:'Resist', say:"counter-force.", effect:s=>{s.flags.pullReduce=0.7;}}
    ],
    attacks:()=>[
      phase(3,pVoidWell(3)),
      phase(3,pVoidOrbit(3)),
      phase(3,pVoidCollapse(3)),
      phase(3,pAbyssRing(3)),
      phase(3,pPixelTeleport(3))
    ]
  },
  { key:'siren', name:'Tidecaller Siren', hpMax:380, draw:dSiren,
    intro:["The tide rises.","Can you breathe?"],
    lines:["Splash.","Drown.","Flow.","Still."],
    mercyNeed:3,
    actDefs:[
      {name:'Listen', say:"You match the swell.", effect:s=>{s.mercy=(s.mercy||0)+1; s.flags.nextSlow=0.85;}},
      {name:'Compliment', say:"She softens.", effect:s=>{s.mercy=(s.mercy||0)+1;}},
      {name:'Hold Breath', say:"You steady your lungs.", effect:s=>{HEART.i=Math.max(HEART.i,0.75);}},
      {name:'Reach Out', say:"A calm passes.", effect:s=>{HEART.hp=Math.min(HEART.hpMax,HEART.hp+5); updateHPUI();}}
    ],
    attacks:()=>[
      phase(3,pSirenWave(3)),
      phase(3,pSirenBubble(3)),
      phase(3,pSirenTsunami(3)),
      phase(3,pEmberSweep(3)),
      phase(3,pPixelLanes(3))
    ]
  },
  { key:'storm', name:'Storm Herald', hpMax:520, draw:dStorm,
    intro:["Thunder answers.","Lightning chooses those who stand still in it."],
    lines:["Crack.","Flash.","Boom.","Again."],
    mercyNeed:6,
    actDefs:[
      {name:'Stand Firm', say:"You brace the strike.", effect:s=>{HEART.i=Math.max(HEART.i,0.8);}},
      {name:'Compliment', say:"They nod once.", effect:s=>{s.mercy=(s.mercy||0)+1;}},
      {name:'Sync Breath', say:"Timing improves.", effect:s=>{s.flags.nextSlow=0.85;}},
      {name:'Taunt', say:"Sky gets angrier.", effect:s=>{s.flags.boost=1.25;}}
    ],
    attacks:()=>[
      phase(3,pStormZig(3)),
      phase(3,pStormBolts(3)),
      phase(3,pStormChain(3)),
      phase(3,pSolarCross(3)),
      phase(3,pEmberHoming(3))
    ]
  },
  { key:'chrono', name:'Chrono Warden', hpMax:430, draw:dChrono,
    intro:["Time bends around will.","Your heartbeat is a metronome."],
    lines:["Tick.","Tock.","Pause.","Resume."],
    mercyNeed:4,
    actDefs:[
      {name:'Breathe', say:"Your pace steadies.", effect:s=>{HEART.i=Math.max(HEART.i,0.8);}},
      {name:'Observe', say:"Gaps widen.", effect:s=>{s.flags.nextSlow=0.85;}},
      {name:'Respect', say:"Acknowledged.", effect:s=>{s.mercy=(s.mercy||0)+1;}},
      {name:'Defy', say:"Then race me.", effect:s=>{s.flags.boost=1.15;}}
    ],
    attacks:()=>[
      phase(3,pChronoPulse(3)),
      phase(3,pChronoOrbit(3)),
      phase(3,pChronoLag(3)),
      phase(3,pChronoRing(3)),
      phase(3,pChronoBolts(3))
    ]
  },
  { key:'aurora', name:'Aurora Weaver', hpMax:410, draw:dAurora,
    intro:["Colors hum in the air.","Hold the thread."],
    lines:["Weave.","Glow.","Bloom.","Shift."],
    mercyNeed:3,
    actDefs:[
      {name:'Compliment', say:"She brightens.", effect:s=>{s.mercy=(s.mercy||0)+1;}},
      {name:'Listen', say:"You match the tone.", effect:s=>{s.mercy=(s.mercy||0)+1; s.flags.nextSlow=0.9;}},
      {name:'Reach', say:"She softens.", effect:s=>{HEART.i=Math.max(HEART.i,0.8);}},
      {name:'Spin', say:"Threads tighten.", effect:s=>{s.flags.boost=1.1;}}
    ],
    attacks:()=>[
      phase(3,pAuroraWave(3)),
      phase(3,pAuroraFan(3)),
      phase(3,pAuroraTeleport(3)),
      phase(3,pAuroraRain(3)),
      phase(3,pAuroraRing(3))
    ]
  }
];

/* -------- Admin boss (10 patterns) -------- */
const ADMIN_BOSS={
  key:'oblivion', name:'[Admin] Oblivion Herald', hpMax:650, draw:dObliv,
  intro:["entropy remembers you.","endings echo.","only now exists."],
  lines:["closer","unmake","reverse","again"],
  mercyNeed:6,
  actDefs:[
    {name:'Bow', say:"acknowledged.", effect:s=>{s.mercy=(s.mercy||0)+1;}},
    {name:'Resist', say:"defiance mapped.", effect:s=>{s.flags.nextSlow=0.85;}},
    {name:'Reflect', say:"brief light returns.", effect:s=>{HEART.i=Math.max(HEART.i,0.95);}},
    {name:'Accept', say:"peace is choice.", effect:s=>{s.mercy=(s.mercy||0)+1;}}
  ],
  attacks:()=>[
    phase(3,pStormZig(3)),
    phase(3,pSolarRing(3)),
    phase(3,pStormBolts(3)),
    phase(3,pVoidOrbit(3)),
    phase(3,pPixelTeleport(3)),
    phase(3,pFrostPulse(3)),
    phase(3,pStormChain(3)),
    phase(3,pEmberHoming(3)),
    phase(3,pSirenTsunami(3)),
    phase(3,pVoidCollapse(3))
  ]
};

/* -------- Admin logic -------- */
function drawPreview(){
  prevCtx.fillStyle='#0b0b0b'; prevCtx.fillRect(0,0,180,180);
  prevCtx.save(); prevCtx.translate(-300,-60);
  if(BOSS && BOSS.draw) BOSS.draw(time);
  prevCtx.restore();
}
function openAdmin(){ admin.style.display='flex'; buildAdminLists(); drawPreview(); }
function closeAdmin(){ admin.style.display='none'; }
function buildAdminLists(){
  adBoss.innerHTML='';
  BOSSES.forEach((b,i)=>{ const o=document.createElement('option'); o.value='main:'+i; o.textContent=`${i+1}. ${b.name}`; adBoss.appendChild(o); });
  { const o=document.createElement('option'); o.value='admin:0'; o.textContent=ADMIN_BOSS.name; adBoss.appendChild(o); }
  adBoss.value='main:'+bossIndex;
  adUser.value=PLAYER_NAME; adHP.value=HEART.hpMax; adDiff.value=SAVE.difficulty||'Normal';
}
adApplyProfile.onclick=()=>{
  const name=(adUser.value||PLAYER_NAME).slice(0,16); playerNameEl.textContent=name;
  let v=parseInt(adHP.value,10)||50; v=Math.max(1,Math.min(99,v)); HEART.hpMax=v; HEART.hp=v; updateHPUI();
  const d=adDiff.value; SAVE.difficulty=d; DIFF=DIFFS[d]||DIFFS.Normal; saveWrite({...SAVE, hp:HEART.hpMax});
};
adLoadBoss.onclick=()=>{ const v=adBoss.value; if(v.startsWith('admin:')) initBoss('admin:0'); else initBoss(parseInt(v.split(':')[1],10)||0); };
adEnd.onclick=()=>{ if(turn===TURN.ENEMY) endAttack(); };
adWin.onclick=()=>{ if(BOSS){ BOSS.hp=0; updateBossBar(); win(false); } };
adSpare.onclick=()=>{ if(BOSS){ BOSS.mercy=BOSS.mercyNeed; waveCount=6; tryMercy(); } };
adTestP1.onclick=()=>previewPattern(0);
adTestP2.onclick=()=>previewPattern(1);
adTestP3.onclick=()=>previewPattern(2);
adHitbox.onclick=()=>{ HEART.glow=!HEART.glow; toastMsg(`Heart glow ${HEART.glow?'on':'off'}`); };
adApplySpeed.onclick=()=>{ const v=parseFloat(adSpeedMul.value)||1; GLOBAL_SPEED=Math.max(0.5,Math.min(2,v)); toastMsg(`Speed x${GLOBAL_SPEED.toFixed(2)}`); };
adExport.onclick=()=>{ adSaveBox.value=JSON.stringify(SAVE,null,2); };
adImport.onclick=()=>{ try{ const obj=JSON.parse(adSaveBox.value||'{}'); SAVE=obj; saveWrite(SAVE); toastMsg('Save imported'); }catch{ toastMsg('Invalid JSON'); } };
adReset.onclick=()=>{ localStorage.removeItem(SAVE_KEY); SAVE=loadSave(); initBoss(0); };
adClose.onclick=()=> closeAdmin();
function previewPattern(ix){
  if(turn===TURN.ENEMY) return;
  const seq=(BOSS.attacks&&BOSS.attacks())||[]; const p=seq[ix]||seq[0]; if(!p) return;
  bullets.length=0; showArena=true; arenaBox.style.display='block'; hideSay(); turn=TURN.ENEMY; uiBar.style.opacity='0'; uiBar.style.pointerEvents='none'; p.enter&&p.enter(); attack=p;
}

/* -------- Boss flow -------- */
function setBossFromObj(obj){
  BOSS={ key:obj.key,name:obj.name,hpMax:obj.hpMax,hp:obj.hpMax,draw:obj.draw,
    intro:[...obj.intro],lines:[...obj.lines],mercyNeed:obj.mercyNeed,mercy:0,
    flags:{nextSlow:1,boost:1,pullReduce:1}, actDefs:obj.actDefs.map(x=>x), attacks:obj.attacks
  };
  attackSeq=BOSS.attacks(); attackIx=0; waveCount=0;
  bossName.textContent=BOSS.name; bossFill.style.width='100%'; bossVal.textContent=`${BOSS.hp}/${BOSS.hpMax}`;
  drawPreview();
}
function initBoss(sel){
  if(typeof sel==='string' && sel.startsWith('admin:')) setBossFromObj(ADMIN_BOSS);
  else { const ix=(typeof sel==='number'?sel:bossIndex)|0; bossIndex=Math.max(0,Math.min(BOSSES.length-1,ix)); setBossFromObj(BOSSES[bossIndex]); }
  HEART.hp=HEART.hpMax=Math.max(1,SAVE.hp||50); updateHPUI(); HEART.i=0; centerHeart();
  turn=TURN.PLAYER; mode='main'; showArena=false; arenaBox.style.display='none';
  say((BOSS.intro||[]).join('\n'));
  saveWrite({...SAVE,bossIndex, hp:HEART.hpMax});
}
function updateBossBar(){ bossFill.style.width=(440*Math.max(0,BOSS.hp/BOSS.hpMax))+'px'; bossVal.textContent=`${BOSS.hp}/${BOSS.hpMax}`; }

/* -------- Input + movement -------- */
const held=new Set();
addEventListener('keydown',e=>{
  if(['ArrowLeft','ArrowRight','ArrowUp','ArrowDown','a','A','d','D','w','W','s','S'].includes(e.key)){
    if(!(turn===TURN.ENEMY && mode==='main')) return;
  }
  held.add(e.key);
  handleHiddenTriggers(e.key);
},{passive:true});
addEventListener('keyup',e=>held.delete(e.key),{passive:true});
function key(k){ return held.has(k)||held.has(k.toUpperCase()); }
function moveHeart(dt){
  if(turn!==TURN.ENEMY || mode!=='main') return;
  let dx=0,dy=0; if(key('ArrowLeft')||key('a'))dx-=1; if(key('ArrowRight')||key('d'))dx+=1; if(key('ArrowUp')||key('w'))dy-=1; if(key('ArrowDown')||key('s'))dy+=1;
  const L=Math.hypot(dx,dy)||1;
  HEART.x=Math.max(ARENA.x+HEART.r,Math.min(ARENA.x+ARENA.w-HEART.r, HEART.x+dx/L*HEART.sp*dt));
  HEART.y=Math.max(ARENA.y+HEART.r,Math.min(ARENA.y+ARENA.h-HEART.r, HEART.y+dy/L*HEART.sp*dt));
  HEART._pdt=dt; HEART._px=HEART.x; HEART._py=HEART.y;
}

/* -------- Bullets + collide -------- */
function updateBullets(dt){
  const s=(BOSS.flags.nextSlow||1)*GLOBAL_SPEED;
  for(const b of bullets){ b.t=(b.t||0)+dt; b.x+=b.vx*dt*s; b.y+=b.vy*dt*s; }
  const m=240; bullets=bullets.filter(b=> b.x>ARENA.x-m && b.x<ARENA.x+ARENA.w+m && b.y>ARENA.y-m && b.y<ARENA.y+ARENA.h+m );
}
function collide(){
  if(HEART.i>0) return;
  for(const b of bullets){
    const dx=b.x-HEART.x, dy=b.y-HEART.y; const rr=(b.r||4)+HEART.r;
    if(dx*dx+dy*dy<=rr*rr){
      const dmg=Math.max(1,Math.floor((b.dmg||3)*(BOSS.flags.boost||1)));
      HEART.hp=Math.max(0, HEART.hp-dmg); updateHPUI(); HEART.i=0.85;
      break;
    }
  }
}

/* -------- Turns -------- */
function startAttack(){
  bullets.length=0; showArena=true; arenaBox.style.display='block';
  hideSay(); uiBar.style.opacity='0'; uiBar.style.pointerEvents='none';
  attack=attackSeq[attackIx]; attackIx=(attackIx+1)%attackSeq.length; attack.enter&&attack.enter();
}
function endAttack(){
  showArena=false; arenaBox.style.display='none'; uiBar.style.opacity='1'; uiBar.style.pointerEvents='auto';
  BOSS.flags.nextSlow=1; BOSS.flags.boost=1; BOSS.flags.pullReduce=1;
  turn=TURN.PLAYER; mode='main'; waveCount++; say(BOSS.lines[Math.floor(Math.random()*BOSS.lines.length)]||'...'); attack=null;
}
function bossHit(dmg){ const dealt=Math.max(1,Math.floor(dmg/(BOSS.flags.boost||1))); BOSS.hp=Math.max(0,BOSS.hp-dealt); updateBossBar(); damagePopup={x:480,y:200,t:0,text:String(dealt)}; }

/* -------- UI -------- */
uiBar.addEventListener('click', e=>{
  const btn=e.target.closest('.btn'); if(!btn) return; handleAction(btn.dataset.act);
});
addEventListener('keydown', e=>{
  if(turn!==TURN.PLAYER) return;
  if(mode==='main'){
    if(['z','Z','Enter',' '].includes(e.key)) handleAction('FIGHT');
    if(e.key==='a'||e.key==='A') handleAction('ACT');
    if(e.key==='i'||e.key==='I') handleAction('ITEM');
    if(e.key==='m'||e.key==='M') handleAction('MERCY');
  }else if(mode==='act'){
    if('1234'.includes(e.key)) doAct(parseInt(e.key,10)-1);
    if(['x','X','Escape','Backspace'].includes(e.key)){ mode='main'; say('Your turn.'); }
  }else if(mode==='item'){
    if('1234'.includes(e.key)){ const msg=useItem(parseInt(e.key,10)-1); say(msg); endPlayerTurn(); }
    if(['x','X','Escape','Backspace'].includes(e.key)){ mode='main'; say('Your turn.'); }
  }
},{passive:true});
function handleAction(act){
  if(turn!==TURN.PLAYER || mode!=='main'){ if(act==='MERCY') tryMercy(); return; }
  if(act==='FIGHT'){ say(`${PLAYER_NAME} strikes for 26.`); bossHit(26); endPlayerTurn(); }
  if(act==='ACT'){ mode='act'; const list=BOSS.actDefs.map((a,i)=>` ${i+1}. ${a.name}`).join('\n'); say(`ACT on ${BOSS.name}:\n${list}\n(Use 1-4)`); }
  if(act==='ITEM'){ mode='item'; say(`ITEMS:\n${itemsList()}\nPick 1-4`); }
  if(act==='MERCY'){ tryMercy(); }
}
function doAct(i){
  const a=BOSS.actDefs[i]; if(!a){ say('No such ACT.'); return; }
  a.effect(BOSS); say(a.say);
  if((BOSS.mercy||0)>=BOSS.mercyNeed) say(`${BOSS.name} seems more willing to listen.`);
  endPlayerTurn();
}
function endPlayerTurn(){ turn=TURN.TRANS; setTimeout(()=>{ if(turn!==TURN.TRANS) return; turn=TURN.ENEMY; uiBar.style.opacity='0'; uiBar.style.pointerEvents='none'; startAttack(); },120); }
function tryMercy(){
  if(waveCount>=6 && (BOSS.mercy||0)>=(BOSS.mercyNeed||99)) win(true);
  else say(`${BOSS.name} isn't ready to be spared.`);
}

/* -------- Items -------- */
let inventory=SAVE.inventory || [{id:'dew',name:'Dew Petal',desc:'+12 HP',type:'heal',amount:12,count:2}];
function itemsList(){ if(inventory.length===0) return "No items."; return inventory.map((it,i)=>` ${i+1}. ${it.name} (${it.count}) — ${it.desc}`).join('\n'); }
function useItem(i){
  const it=inventory[i]; if(!it||it.count<=0) return "Empty.";
  if(it.type==='heal'){ HEART.hp=Math.min(HEART.hpMax, HEART.hp+(it.amount||10)); updateHPUI(); it.count--; if(it.count<=0) inventory.splice(i,1); SAVE.inventory=inventory; saveWrite(SAVE); return `You used ${it.name}. +${it.amount} HP`; }
  return "Nothing happened.";
}

/* -------- Win/lose -------- */
function lose(){ if(turn===TURN.LOSE) return; turn=TURN.LOSE; say('You fall. The hall dims.'); setTimeout(()=>initBoss(bossIndex),900); }
function win(spared){
  if(turn===TURN.WIN) return; turn=TURN.WIN; say(`${spared?'You spared':'You defeated'} ${BOSS.name}.`);
  setTimeout(()=>{ const next=bossIndex+1; if(next<BOSSES.length) initBoss(next); else { say('Ending: You carried your choices.'); setTimeout(()=>initBoss(0),1000); } }, 950);
}

/* -------- Hidden admin triggers: 67×3 + two words -------- */
const ADMIN_TRIG_WORDS=['skibidi','overdrive'];
const ADMIN_TRIG_MAXLEN=Math.max(...ADMIN_TRIG_WORDS.map(w=>w.length),7);
let secretBuf='', pairCount=0, secretCooldown=0, wordBuf='';
function handleHiddenTriggers(k){
  const key=String(k||'').toLowerCase();
  if(secretCooldown>0) secretCooldown--;

  // 67 chain
  if(key==='6'||key==='7'){
    if(secretCooldown<=0){
      secretBuf=(secretBuf+key).slice(-2);
      if(secretBuf==='67'){
        pairCount++; secretBuf=''; secretCooldown=10;
        if(pairCount>=3){ pairCount=0; wordBuf=''; openAdmin(); toastMsg('Admin opened'); }
      }
    }
  } else { secretBuf=''; pairCount=0; }

  // word triggers
  if(/^[a-z]$/.test(key)){
    wordBuf=(wordBuf+key).slice(-ADMIN_TRIG_MAXLEN);
    for(const w of ADMIN_TRIG_WORDS){
      if(wordBuf.endsWith(w.toLowerCase())){
        wordBuf=''; secretBuf=''; pairCount=0; openAdmin(); toastMsg('Admin opened'); break;
      }
    }
  }
}

/* -------- Render + loop -------- */
function render(){
  ctx.fillStyle='#08070a'; ctx.fillRect(0,0,960,720);
  ctx.fillStyle='#141018'; for(let i=0;i<64;i++){const x=(i*137)%960, y=(i*173)%720; ctx.fillRect(x,y,2,2);}

  if(BOSS && typeof BOSS.draw==='function') BOSS.draw(time);

  if(turn===TURN.ENEMY && showArena){
    ctx.strokeStyle='#ffffff'; ctx.lineWidth=3; ctx.strokeRect(ARENA.x,ARENA.y,ARENA.w,ARENA.h);
    for(const b of bullets){ ctx.fillStyle=b.col||'#fff'; ctx.beginPath(); ctx.arc(b.x,b.y,b.r||4,0,Math.PI*2); ctx.fill(); }
    ctx.save();
    if(HEART.glow){ ctx.globalAlpha=0.15; glow(HEART.x,HEART.y,16,HEART_COLOR,0.35); }
    if(HEART.i>0) ctx.globalAlpha = 0.6+0.3*Math.sin(time*20);
    drawHeart(HEART.x-6,HEART.y-6,HEART_COLOR,0.8);
    ctx.restore();
  }

  if(damagePopup){
    damagePopup.t+=0.016*GLOBAL_SPEED;
    const a=Math.max(0,1-damagePopup.t/0.9);
    ctx.save(); ctx.globalAlpha=a; ctx.fillStyle='#fff1b6'; ctx.font='16px monospace';
    ctx.fillText(damagePopup.text, damagePopup.x, 200-damagePopup.t*60);
    ctx.restore();
    if(damagePopup.t>0.9) damagePopup=null;
  }
}
let last=performance.now();
function loop(now){
  const dt=Math.min(0.033, Math.max(0,(now-last)/1000)); last=now; time+=dt;
  if(turn===TURN.ENEMY){
    moveHeart(dt);
    attack&&attack.update&&attack.update(dt);
    updateBullets(dt);
    collide();
    if(HEART.hp<=0) lose();
    if(attack&&attack.done&&attack.done()) endAttack();
  }
  render();
  requestAnimationFrame(loop);
}

/* -------- Start (clean ending) -------- */
updateHPUI();
buildAdminLists();
initBoss(bossIndex>=0 && bossIndex<BOSSES.length ? bossIndex : 0);
requestAnimationFrame(loop);
cv.focus();
</script>
</body>
</html>

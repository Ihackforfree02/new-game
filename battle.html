<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<title>Undertale Gold — Centered Stable (hidden 67)</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover, user-scalable=no"/>
<style>
/* Center the game surface perfectly on any screen */
html,body{
  margin:0;height:100%;background:#000;color:#ffd166;
  display:flex;align-items:center;justify-content:center;
  font-family:ui-monospace,menlo,consolas,monospace;
}
*{box-sizing:border-box}
#wrap{
  width:960px;height:720px;position:relative;
  background:#070606;border:4px solid #0a0a0f;image-rendering:pixelated;
}
#hud{
  position:absolute;left:0;right:0;top:0;padding:10px 16px;display:flex;justify-content:space-between;pointer-events:none
}
.hcol{display:flex;flex-direction:column;gap:6px}
.bar{height:10px;background:#141414;border:1px solid #383838;position:relative}
.fill{position:absolute;left:0;top:0;bottom:0}
#bossFill{background:#ff5e6b;width:100%}
#hpFill{background:#7affb7;width:100%}
#bubble{
  position:absolute;left:50%;bottom:136px;transform:translateX(-50%);
  width:90%;min-height:96px;background:#0b0b0b;border:2px solid #ffd166;padding:12px;display:none
}
#bubbleText{white-space:pre-line;line-height:1.5}
#uiBar{
  position:absolute;left:50%;bottom:8px;transform:translateX(-50%);
  width:920px;height:108px;background:#0b0b0b;border:2px solid #262626;
  display:flex;align-items:center;justify-content:space-around
}
.btn{cursor:pointer;user-select:none;display:flex;align-items:center;gap:10px}
.key{width:20px;height:20px;border:2px solid #fff;display:flex;align-items:center;justify-content:center;font-weight:700}
.lab{font-size:20px;letter-spacing:1px}
#arenaBox{position:absolute;left:240px;top:420px;width:480px;height:180px;border:3px solid #fff;display:none;pointer-events:none}
#toast{
  position:absolute;left:50%;top:18px;transform:translateX(-50%);
  background:#111;border:1px solid #fff;color:#ffd166;padding:6px 10px;font-size:12px;opacity:0;transition:opacity .22s;pointer-events:none
}
#toast.show{opacity:1}

/* Admin overlay (hidden trigger via 67 x3 — no hint shown) */
#admin{
  position:absolute;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.65);z-index:10
}
#panel{
  width:880px;max-width:95%;background:#0e0e0e;border:2px solid #fff;padding:14px;color:#ffd166
}
.row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin:6px 0}
.sel,.inp{background:#111;color:#ffd166;border:1px solid #333;padding:6px 8px}
.btn2{padding:6px 10px;border:1px solid #fff;background:transparent;color:#ffd166;cursor:pointer}
#preview{width:180px;height:180px;border:1px solid #333;background:#0b0b0b}

@media (max-width:480px){
  #wrap{transform:scale(.9)}
  .lab{font-size:18px}
}
</style>
</head>
<body>
<div id="wrap">
  <canvas id="cv" width="960" height="720"></canvas>

  <div id="hud">
    <div class="hcol" style="min-width:300px">
      <div id="bossName">Solar Fang</div>
      <div class="bar" style="width:440px"><div id="bossFill" class="fill"></div></div>
      <div id="bossVal" style="font-size:12px">000/000</div>
    </div>
    <div class="hcol" style="align-items:flex-end;min-width:180px">
      <div id="playerName" style="color:#9be7c0">Traveler</div>
      <div class="bar" style="width:260px"><div id="hpFill" class="fill"></div></div>
      <div id="hpVal" style="font-size:12px">50/50</div>
    </div>
  </div>

  <div id="bubble"><div id="bubbleText"></div></div>
  <div id="arenaBox"></div>

  <div id="uiBar">
    <div class="btn" data-act="FIGHT"><div class="key">Z</div><div class="lab">FIGHT</div></div>
    <div class="btn" data-act="ACT"><div class="key">A</div><div class="lab">ACT</div></div>
    <div class="btn" data-act="ITEM"><div class="key">I</div><div class="lab">ITEM</div></div>
    <div class="btn" data-act="MERCY"><div class="key">M</div><div class="lab">MERCY</div></div>
  </div>

  <div id="toast">Admin opened</div>

  <div id="admin">
    <div id="panel">
      <div class="row">
        <select id="adBoss" class="sel"></select>
        <input id="adHP" class="inp" type="number" value="50" min="1" max="99"/>
        <select id="adDiff" class="sel">
          <option>Normal</option><option>Hard</option><option>Insane</option>
        </select>
        <button id="adClose" class="btn2">Close</button>
        <button id="adEnd" class="btn2">End attack</button>
        <button id="adWin" class="btn2">Win</button>
        <button id="adSpare" class="btn2">Spare</button>
        <button id="adReset" class="btn2">Reset save</button>
      </div>
      <canvas id="preview" width="180" height="180"></canvas>
    </div>
  </div>
</div>

<script>
"use strict";

/* Elements */
const cv = document.getElementById('cv');
const ctx = cv.getContext('2d',{alpha:false});
const bossName = document.getElementById('bossName');
const bossVal = document.getElementById('bossVal');
const bossFill = document.getElementById('bossFill');
const playerNameEl = document.getElementById('playerName');
const hpVal = document.getElementById('hpVal');
const hpFill = document.getElementById('hpFill');
const bubble = document.getElementById('bubble');
const bubbleText = document.getElementById('bubbleText');
const uiBar = document.getElementById('uiBar');
const arenaBox = document.getElementById('arenaBox');
const toast = document.getElementById('toast');
const admin = document.getElementById('admin');
const adBoss = document.getElementById('adBoss');
const adHP = document.getElementById('adHP');
const adDiff = document.getElementById('adDiff');
const adClose = document.getElementById('adClose');
const adEnd = document.getElementById('adEnd');
const adWin = document.getElementById('adWin');
const adSpare = document.getElementById('adSpare');
const adReset = document.getElementById('adReset');
const prev = document.getElementById('preview').getContext('2d');

/* Save */
const SAVE_KEY='ug_final_hidden67_v1';
function loadSave(){ try{ return JSON.parse(localStorage.getItem(SAVE_KEY))||{} }catch{return {}} }
function saveWrite(d){ try{ localStorage.setItem(SAVE_KEY, JSON.stringify(d)); }catch{} }
let SAVE=loadSave();

/* Game constants */
const ARENA = {x:240,y:420,w:480,h:180};
const TURN = {PLAYER:'p', ENEMY:'e', TRANS:'t', WIN:'w', LOSE:'l'};
const DIFFS = {
  Normal:{spd:1.10,rate:1.10,dmg:1.40,lead:0.08},
  Hard:{spd:1.28,rate:1.28,dmg:1.75,lead:0.10},
  Insane:{spd:1.46,rate:1.40,dmg:2.10,lead:0.12}
};

/* Player */
let username = (SAVE.username||'Traveler').slice(0,16);
playerNameEl.textContent = username;
let DIFF = DIFFS[SAVE.difficulty||'Normal']||DIFFS.Normal;
const HEART = {
  x:ARENA.x+ARENA.w/2, y:ARENA.y+ARENA.h/2, r:4, sp:320, i:0,
  hp: Math.max(1,SAVE.hp||50),
  hpMax: Math.max(1,SAVE.hp||50),
  _px:0,_py:0,_pdt:1/60
};

/* State */
let time=0, turn=TURN.PLAYER, mode='main', waveCount=0;
let bullets=[], attack=null, attackSeq=null, attackIx=0, damagePopup=null, showArena=false;
function centerHeart(){ HEART.x=ARENA.x+ARENA.w/2; HEART.y=ARENA.y+ARENA.h/2; }
function say(t){ bubble.style.display='block'; bubbleText.textContent=t; }
function hideSay(){ bubble.style.display='none'; }
function toastMsg(m){ toast.textContent=m; toast.classList.add('show'); setTimeout(()=>toast.classList.remove('show'),900); }
function updateHPUI(){ hpFill.style.width = (260*Math.max(0,HEART.hp/HEART.hpMax))+'px'; hpVal.textContent=`${HEART.hp}/${HEART.hpMax}`; }

/* Bosses (2 sample + final placeholder) */
function drawBase(x,y,colors){
  ctx.save(); ctx.globalAlpha=0.25; ctx.fillStyle=colors.aura; ctx.beginPath(); ctx.arc(x,y,60,0,Math.PI*2); ctx.fill(); ctx.restore();
  ctx.fillStyle=colors.head; ctx.beginPath(); ctx.arc(x, y-34, 12, 0, Math.PI*2); ctx.fill();
  ctx.fillStyle=colors.body; ctx.fillRect(x-10, y-24, 20, 44);
  ctx.fillStyle=colors.accent; ctx.fillRect(x-24, y-18, 12, 30); ctx.fillRect(x+12, y-18, 12, 30);
  ctx.fillStyle=colors.body; ctx.fillRect(x-10, y+18, 8, 22); ctx.fillRect(x+2, y+18, 8, 22);
}
function dSolar(t){ const x=480,y=240+Math.sin(t*2.4)*2; drawBase(x,y,{aura:'#fff3b8',head:'#ffefb0',body:'#ffd166',accent:'#ffe69a'}); ctx.strokeStyle='#ffd166'; ctx.beginPath(); ctx.arc(x,y-34,18+Math.sin(t*5),0,Math.PI*2); ctx.stroke(); }
function dStorm(t){ const x=480,y=238+Math.sin(t*2.2)*2; drawBase(x,y,{aura:'#fff59a',head:'#fffbd1',body:'#ffd455',accent:'#ffec8a'}); ctx.strokeStyle='#ffe066'; ctx.beginPath(); ctx.moveTo(x-8,y-44); ctx.lineTo(x,y-54); ctx.lineTo(x+8,y-44); ctx.stroke(); }

function ring(C,spd,col,dmg,n=12){ for(let k=0;k<n;k++){ const a=k/n*Math.PI*2; spawn({x:C.x,y:C.y,vx:Math.cos(a)*spd*DIFF.spd,vy:Math.sin(a)*spd*DIFF.spd,r:3,col,dmg}); } }
function spawn(b){ b.t=0; bullets.push(b); return b; }
function spawnAimed(fx,fy,speed,dmg,col='#fff',r=3,lead=DIFF.lead){
  const vx0=(HEART.x-(HEART._px||HEART.x))/(HEART._pdt||1/60);
  const vy0=(HEART.y-(HEART._py||HEART.y))/(HEART._pdt||1/60);
  const dx=HEART.x-fx, dy=HEART.y-fy, L=Math.hypot(dx,dy)||1;
  const vx=(dx/L)*speed*DIFF.spd + vx0*lead, vy=(dy/L)*speed*DIFF.spd + vy0*lead;
  return spawn({x:fx,y:fy,vx,vy,r, col, dmg:Math.max(1,Math.floor(dmg*DIFF.dmg))});
}
function rand(a,b){return Math.random()*(b-a)+a;}
const phase = (dur,...parts)=>{ let t=0; return { enter(){t=0;parts.forEach(p=>p.enter&&p.enter())}, update(dt){t+=dt;parts.forEach(p=>p.update&&p.update(dt))}, done(){return t>=dur} } };
/* Patterns (distinct and lightweight) */
const pSolarFan = (d=3)=>{ let t=0,g=0,rate=.22/DIFF.rate; const c={x:ARENA.x+ARENA.w/2,y:ARENA.y+18}; return {
  enter(){}, update(dt){ t+=dt; g+=dt; if(g>=rate){ g=0; const base=rand(-0.4,0.4); for(const a of [base-0.7,base,base+0.7]) spawn({x:c.x,y:c.y,vx:Math.cos(a)*250*DIFF.spd,vy:Math.sin(a)*250*DIFF.spd,r:3,col:'#fff3b8',dmg:5}); } },
  done(){ return t>=d; }
}};
const pSolarRing = (d=3)=>{ let t=0,g=0,rate=.5/DIFF.rate; const C={x:ARENA.x+ARENA.w/2,y:ARENA.y+ARENA.h/2}; return {
  enter(){}, update(dt){ t+=dt; g+=dt; if(g>=rate){ g=0; ring(C,255,'#ffd166',6,14); } }, done(){ return t>=d; }
}};
const pStormZig = (d=3)=>{ let t=0,g=0,rate=.22/DIFF.rate; return{
  enter(){}, update(dt){ t+=dt; g+=dt; if(g>=rate){ g=0; const left=Math.random()<0.5; const y=ARENA.y+rand(14,ARENA.h-14); const v=(left?1:-1)*(260+Math.sin(t*7)*40)*DIFF.spd; spawn({x:left?ARENA.x-24:ARENA.x+ARENA.w+24,y, vx:v, vy:0, r:3, col:'#ffe066',dmg:6,zig:1}); } for(const b of bullets){ if(b.zig){ b.vy = Math.sin((b.t||0)*10)*70; } } }, done(){ return t>=d; }
}};
const pStormBolts = (d=3)=>{ let t=0,g=0,rate=.36/DIFF.rate; return{
  enter(){}, update(dt){ t+=dt; g+=dt; if(g>=rate){ g=0; for(let i=0;i<3;i++){ const x=ARENA.x+rand(20,ARENA.w-20); spawn({x, y:ARENA.y-18, vx:0, vy:300*DIFF.spd, r:4, col:'#ffea80', dmg:7}); } } }, done(){ return t>=d; }
}};

/* Boss roster (2 real + one hard final sample) */
const BOSSES = [
  {
    key:'solar', name:'Solar Fang', hpMax:380, draw:dSolar,
    intro:["The sun bows to no one.","Step into the flare, traveler.","Hold."],
    lines:["Burn bright.","Hold your ground.","Endure.","Again."],
    mercyNeed:3,
    actDefs:[
      {name:'Bow', say:"Respect accepted.", effect:s=>{s.mercy=(s.mercy||0)+1;}},
      {name:'Compliment', say:"Your courage glows.", effect:s=>{s.mercy=(s.mercy||0)+1;}},
      {name:'Focus', say:"Steady breath.", effect:s=>{HEART.i=Math.max(HEART.i,0.7);}},
      {name:'Taunt', say:"Heat rises.", effect:s=>{s.flags.boost=1.15;}}
    ],
    attacks:()=>[ phase(3,pSolarFan(3)), phase(3,pSolarRing(3)), phase(3,pSolarFan(3)) ]
  },
  {
    key:'storm', name:'Storm Herald', hpMax:400, draw:dStorm,
    intro:["Thunder answers.","Lightning strikes."],
    lines:["Crack.","Flash.","Boom.","Again."],
    mercyNeed:3,
    actDefs:[
      {name:'Stand Firm', say:"You brace the strike.", effect:s=>{HEART.i=Math.max(HEART.i,0.72);}},
      {name:'Compliment', say:"They nod.", effect:s=>{s.mercy=(s.mercy||0)+1;}},
      {name:'Sync Breath', say:"Timing improves.", effect:s=>{s.flags.nextSlow=0.9;}},
      {name:'Taunt', say:"Bolts intensify.", effect:s=>{s.flags.boost=1.2;}}
    ],
    attacks:()=>[ phase(3,pStormZig(3)), phase(3,pStormBolts(3)), phase(3,pStormZig(3)) ]
  },
  {
    key:'dream', name:'Dream Eater', hpMax:500, draw:(t)=>{ const x=480,y=236+Math.sin(t*2.6)*2; drawBase(x,y,{aura:'#e0c0ff',head:'#f2e5ff',body:'#d5a8ff',accent:'#e9d1ff'}); },
    intro:["This is not real.","But your habits are.","Survive me."],
    lines:["bend","slur","warp","wake"],
    mercyNeed:6,
    actDefs:[
      {name:'Admit Fear', say:"Naming helps.", effect:s=>{s.mercy=(s.mercy||0)+1;}},
      {name:'Slow Down', say:"Time obeys.", effect:s=>{s.flags.nextSlow=0.8;}},
      {name:'Blink Twice', say:"You return.", effect:s=>{HEART.i=Math.max(HEART.i,0.85);}},
      {name:'Smile', say:"Brave.", effect:s=>{s.mercy=(s.mercy||0)+1;}}
    ],
    attacks:()=>[ phase(3,pStormZig(3)), phase(3,pSolarRing(3)), phase(3,pStormBolts(3)) ] // hard mix
  }
];

/* Current boss object */
let bossIndex = (typeof SAVE.bossIndex==='number')?SAVE.bossIndex:0;
let BOSS = null;

/* UI + boss init */
function setBossFromObj(obj){
  BOSS = {
    key:obj.key, name:obj.name, hpMax:obj.hpMax, hp:obj.hpMax,
    draw:obj.draw, intro:[...obj.intro], lines:[...obj.lines],
    mercyNeed:obj.mercyNeed, mercy:0, flags:{nextSlow:1,boost:1,pullReduce:1},
    actDefs:obj.actDefs.map(x=>x), attacks:obj.attacks
  };
  attackSeq = BOSS.attacks(); attackIx=0;
  bossName.textContent = BOSS.name;
  bossFill.style.width = '100%';
  bossVal.textContent = `${BOSS.hp}/${BOSS.hpMax}`;
  waveCount = 0;
}
function initBoss(ix){
  bossIndex = Math.max(0, Math.min(BOSSES.length-1, ix|0));
  setBossFromObj(BOSSES[bossIndex]);
  HEART.hp = HEART.hpMax = Math.max(1,SAVE.hp||50);
  updateHPUI(); HEART.i=0; centerHeart();
  turn = TURN.PLAYER; mode='main'; showArena=false; arenaBox.style.display='none';
  say(BOSS.intro.join('\n'));
  saveWrite({...SAVE, bossIndex, hp:HEART.hpMax});
}

/* HUD updates */
function updateBossBar(){ bossFill.style.width = (440*Math.max(0,BOSS.hp/BOSS.hpMax))+'px'; bossVal.textContent = `${BOSS.hp}/${BOSS.hpMax}`; }

/* Input */
const held = new Set();
addEventListener('keydown', e=>{
  if(['ArrowLeft','ArrowRight','ArrowUp','ArrowDown','a','A','d','D','w','W','s','S'].includes(e.key)){
    if(!(turn===TURN.ENEMY && mode==='main')) return;
  }
  held.add(e.key);
  secret67(e.key);
},{passive:true});
addEventListener('keyup', e=>held.delete(e.key),{passive:true});
function key(k){ return held.has(k) || held.has(k.toUpperCase()); }

/* Secret: 67 three times (no hint shown) */
let secretBuf='', pairCount=0, secretCooldown=0;
function secret67(k){
  if(secretCooldown>0) return;
  if(k==='6'||k==='7'){
    secretBuf=(secretBuf+k).slice(-2);
    if(secretBuf==='67'){
      pairCount++; secretBuf=''; secretCooldown=10;
      if(pairCount>=3){ pairCount=0; admin.style.display='flex'; toastMsg('Admin opened'); buildAdmin(); }
    }
  }else{ secretBuf=''; pairCount=0; }
}

/* Movement */
function moveHeart(dt){
  if(turn!==TURN.ENEMY || mode!=='main') return;
  let dx=0,dy=0;
  if(key('ArrowLeft')||key('a')) dx-=1;
  if(key('ArrowRight')||key('d')) dx+=1;
  if(key('ArrowUp')||key('w')) dy-=1;
  if(key('ArrowDown')||key('s')) dy+=1;
  const L=Math.hypot(dx,dy)||1;
  HEART.x=Math.max(ARENA.x+HEART.r, Math.min(ARENA.x+ARENA.w-HEART.r, HEART.x+dx/L*HEART.sp*dt));
  HEART.y=Math.max(ARENA.y+HEART.r, Math.min(ARENA.x+ARENA.h-HEART.r, HEART.y+dy/L*HEART.sp*dt));
  HEART._pdt=dt; HEART._px=HEART.x; HEART._py=HEART.y;
}

/* Bullets */
function updateBullets(dt){
  const s = BOSS.flags.nextSlow||1;
  for(const b of bullets){ b.t=(b.t||0)+dt; b.x+=b.vx*dt*s; b.y+=b.vy*dt*s; }
  const m=240;
  bullets = bullets.filter(b=> b.x>ARENA.x-m && b.x<ARENA.x+ARENA.w+m && b.y>ARENA.y-m && b.y<ARENA.y+ARENA.h+m );
}
function collide(){
  if(HEART.i>0) return;
  for(const b of bullets){
    const dx=b.x-HEART.x, dy=b.y-HEART.y; const rr=(b.r||4)+HEART.r;
    if(dx*dx+dy*dy<=rr*rr){
      const dmg=Math.max(1,Math.floor((b.dmg||3)*(BOSS.flags.boost||1)));
      HEART.hp=Math.max(0, HEART.hp-dmg); updateHPUI(); HEART.i=0.85;
      break;
    }
  }
}

/* Turn flow */
function startAttack(){
  bullets.length=0; showArena=true; arenaBox.style.display='block';
  hideSay(); uiBar.style.opacity='0'; uiBar.style.pointerEvents='none';
  attack = attackSeq[attackIx]; attackIx=(attackIx+1)%attackSeq.length;
  attack.enter && attack.enter();
}
function endAttack(){
  showArena=false; arenaBox.style.display='none';
  uiBar.style.opacity='1'; uiBar.style.pointerEvents='auto';
  BOSS.flags.nextSlow=1; BOSS.flags.boost=1; BOSS.flags.pullReduce=1;
  turn=TURN.PLAYER; mode='main'; waveCount++;
  say(BOSS.lines[Math.floor(Math.random()*BOSS.lines.length)]||'...');
  attack=null;
}
function bossHit(dmg){
  const dealt = Math.max(1,Math.floor(dmg/(BOSS.flags.boost||1)));
  BOSS.hp = Math.max(0, BOSS.hp - dealt);
  updateBossBar(); damagePopup = {x:480,y:200,t:0,text:String(dealt)};
}

/* Buttons */
document.getElementById('uiBar').addEventListener('click', e=>{
  const btn = e.target.closest('.btn'); if(!btn) return;
  const act = btn.dataset.act;
  if(turn!==TURN.PLAYER||mode!=='main'){ if(act==='MERCY') tryMercy(); return; }
  if(act==='FIGHT'){ routeState.fight=(routeState.fight||0)+1; say(`${username} strikes for 26.`); bossHit(26); endPlayerTurn(); }
  if(act==='ACT'){ mode='act'; const list=BOSS.actDefs.map((a,i)=>` ${i+1}. ${a.name}`).join('\n'); say(`ACT on ${BOSS.name}:\n${list}\n(Use 1-4)`); }
  if(act==='ITEM'){ mode='item'; say(`ITEMS:\n${itemsList()}\nPick 1-4`); }
  if(act==='MERCY'){ tryMercy(); }
});
addEventListener('keydown', e=>{
  if(turn!==TURN.PLAYER) return;
  if(mode==='main'){
    if(['z','Z','Enter',' '].includes(e.key)){ routeState.fight=(routeState.fight||0)+1; say(`${username} strikes for 26.`); bossHit(26); endPlayerTurn(); }
    if(e.key==='a'||e.key==='A'){ mode='act'; const list=BOSS.actDefs.map((a,i)=>` ${i+1}. ${a.name}`).join('\n'); say(`ACT on ${BOSS.name}:\n${list}\n(Use 1-4)`); }
    if(e.key==='i'||e.key==='I'){ mode='item'; say(`ITEMS:\n${itemsList()}\nPick 1-4`); }
    if(e.key==='m'||e.key==='M'){ tryMercy(); }
  }else if(mode==='act'){
    if('1234'.includes(e.key)){ const a=BOSS.actDefs[parseInt(e.key,10)-1]; if(a){ a.effect(BOSS); routeState.act=(routeState.act||0)+1; say(a.say); endPlayerTurn(); } }
    if(['x','X','Escape','Backspace'].includes(e.key)){ mode='main'; say('Your turn.'); }
  }else if(mode==='item'){
    if('1234'.includes(e.key)){ const msg = useItem(parseInt(e.key,10)-1); say(msg); endPlayerTurn(); }
    if(['x','X','Escape','Backspace'].includes(e.key)){ mode='main'; say('Your turn.'); }
  }
},{passive:true});

function tryMercy(){
  if(waveCount>=6 && (BOSS.mercy||0)>=(BOSS.mercyNeed||99)){
    routeState.mercy=(routeState.mercy||0)+1; win(true);
  }else{
    say(`${BOSS.name} isn't ready to be spared.`);
  }
}
function endPlayerTurn(){
  turn = TURN.TRANS;
  setTimeout(()=>{ if(turn!==TURN.TRANS) return;
    turn = TURN.ENEMY; uiBar.style.opacity='0'; uiBar.style.pointerEvents='none'; startAttack();
  }, 120);
}

/* Win/lose */
function lose(){ if(turn===TURN.LOSE) return; turn=TURN.LOSE; say('You fall. The hall dims.'); setTimeout(()=>initBoss(bossIndex),900); }
function win(spared){
  if(turn===TURN.WIN) return; turn=TURN.WIN;
  say(`${spared?'You spared':'You defeated'} ${BOSS.name}.`);
  setTimeout(()=>{ const next=bossIndex+1; if(next<BOSSES.length) initBoss(next); else { say('Ending: You carried your choices.'); setTimeout(()=>initBoss(0),1000); } }, 950);
}

/* Admin UI (opened only by secret 67) */
function buildAdmin(){
  adBoss.innerHTML='';
  BOSSES.forEach((b,i)=>{ const o=document.createElement('option'); o.value=i; o.textContent=`${i+1}. ${b.name}`; adBoss.appendChild(o); });
  adBoss.value = String(bossIndex);
  adHP.value = HEART.hpMax;
  adDiff.value = SAVE.difficulty||'Normal';
  drawPreview();
}
function drawPreview(){
  prev.fillStyle='#0b0b0b'; prev.fillRect(0,0,180,180);
  prev.save(); prev.translate(-300,-60);
  if(BOSS && BOSS.draw){ BOSS.draw(time); }
  prev.restore();
}
adClose.onclick = ()=> admin.style.display='none';
adEnd.onclick = ()=>{ if(turn===TURN.ENEMY) endAttack(); };
adWin.onclick = ()=>{ if(BOSS){ BOSS.hp=0; updateBossBar(); win(false); } };
adSpare.onclick = ()=>{ if(BOSS){ BOSS.mercy=BOSS.mercyNeed; waveCount=6; tryMercy(); } };
adReset.onclick = ()=>{ localStorage.removeItem(SAVE_KEY); SAVE=loadSave(); initBoss(0); };
adBoss.onchange = ()=>{ const ix=parseInt(adBoss.value,10)||0; admin.style.display='none'; initBoss(ix); };
adHP.onchange = ()=>{ let v=parseInt(adHP.value,10)||50; v=Math.max(1,Math.min(99,v)); HEART.hpMax=v; HEART.hp=v; SAVE.hp=v; saveWrite(SAVE); updateHPUI(); };
adDiff.onchange = ()=>{ const d=adDiff.value; SAVE.difficulty=d; DIFF = DIFFS[d]||DIFFS.Normal; saveWrite(SAVE); };

/* Loop */
updateHPUI();
function drawHeart(x,y,color='#ffd166',scale=0.8){
  ctx.save(); ctx.translate(x,y); ctx.scale(scale,scale);
  const m=[[0,1,1,0,0,1,1,0],[1,1,1,1,1,1,1,1],[1,1,1,1,1,1,1,1],[0,1,1,1,1,1,1,0],[0,0,1,1,1,1,0,0],[0,0,0,1,1,0,0,0]];
  ctx.fillStyle=color; const s=3;
  for(let r=0;r<m.length;r++) for(let c=0;c<m[r].length;c++) if(m[r][c]) ctx.fillRect((c-4)*s,(r-3)*s,s,s);
  ctx.restore();
}
function render(){
  ctx.fillStyle='#08070a'; ctx.fillRect(0,0,960,720);
  ctx.fillStyle='#141018'; for(let i=0;i<60;i++){const x=(i*137)%960, y=(i*173)%720; ctx.fillRect(x,y,2,2);}

  if(BOSS && typeof BOSS.draw==='function') BOSS.draw(time);

  if(turn===TURN.ENEMY && showArena){
    ctx.strokeStyle='#ffffff'; ctx.lineWidth=3; ctx.strokeRect(ARENA.x,ARENA.y,ARENA.w,ARENA.h);
    for(const b of bullets){ ctx.fillStyle=b.col||'#fff'; ctx.beginPath(); ctx.arc(b.x,b.y,b.r||4,0,Math.PI*2); ctx.fill(); }
    ctx.save(); if(HEART.i>0) ctx.globalAlpha = 0.6+0.3*Math.sin(time*20);
    drawHeart(HEART.x-6,HEART.y-6,'#ffd166',0.8);
    ctx.restore();
  }

  if(damagePopup){
    damagePopup.t += 0.016;
    const a = Math.max(0, 1-damagePopup.t/0.9);
    ctx.save(); ctx.globalAlpha=a; ctx.fillStyle='#fff1b6'; ctx.font='16px monospace';
    ctx.fillText(damagePopup.text, damagePopup.x, 200-damagePopup.t*60);
    ctx.restore();
    if(damagePopup.t>0.9) damagePopup=null;
  }
}
let last=performance.now();
function loop(now){
  const dt = Math.min(0.033, Math.max(0,(now-last)/1000)); last=now; time+=dt;
  if(turn===TURN.ENEMY){
    moveHeart(dt);
    attack && attack.update && attack.update(dt);
    updateBullets(dt);
    collide();
    if(HEART.hp<=0) lose();
    if(attack && attack.done && attack.done()) endAttack();
  }
  render();
  requestAnimationFrame(loop);
}

/* Start */
initBoss(bossIndex);
requestAnimationFrame(loop);
cv.focus();
</script>
</body>
</html>
```[43dcd9a7-70db-4a1f-b0ae-981daa162054](https://github.com/simongarton/pi/tree/44f2eb228db9aebcaa3b37256592cd504fec423a/weather%2Fweather.py?citationMarker=43dcd9a7-70db-4a1f-b0ae-981daa162054 "1")[43dcd9a7-70db-4a1f-b0ae-981daa162054](https://github.com/simongarton/pi/tree/44f2eb228db9aebcaa3b37256592cd504fec423a/sense-hat%2Fheart.py?citationMarker=43dcd9a7-70db-4a1f-b0ae-981daa162054 "2")[43dcd9a7-70db-4a1f-b0ae-981daa162054](https://github.com/glennklockwood/raspberrypi/tree/7b04fb9d975cb631627b6aaa939fa9fc8521d8c2/led-matrix-heart.py?citationMarker=43dcd9a7-70db-4a1f-b0ae-981daa162054 "3")[43dcd9a7-70db-4a1f-b0ae-981daa162054](https://github.com/tonyyuanzaizai/Match3/tree/dcca184c1e27f0a6ff75e8e42ad63f5b7e211c29/match3_cpp%2FGameData.cpp?citationMarker=43dcd9a7-70db-4a1f-b0ae-981daa162054 "4")[43dcd9a7-70db-4a1f-b0ae-981daa162054](https://github.com/ElroyDolleman/PicrossPhaser/tree/ccbaed3e481cf1c04a15b7c93ea9936e09d2ca15/source%2Fgrid%2Fpictures.ts?citationMarker=43dcd9a7-70db-4a1f-b0ae-981daa162054 "5")

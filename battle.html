<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<title>Undertale Gold — Battle (admin panel, lore, equips, OP controls, boss order)</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover, user-scalable=no"/>
<style>
html,body{
  margin:0;height:100%;background:#000;color:#ffd166;
  display:flex;align-items:center;justify-content:center;
  font-family:ui-monospace,Menlo,Consolas,monospace;
}
*{box-sizing:border-box}
#wrap{width:960px;height:720px;position:relative;background:#070606;border:4px solid #0a0a0f;image-rendering:pixelated;}
/* HUD */
#hud{position:absolute;left:0;right:0;top:0;padding:10px 16px;display:flex;justify-content:space-between;pointer-events:none;z-index:3}
.hcol{display:flex;flex-direction:column;gap:6px}
.bar{height:10px;background:#141414;border:1px solid #383838;position:relative}
.fill{position:absolute;left:0;top:0;bottom:0}
#bossFill{background:#ff5e6b;width:100%}
#hpFill{background:#7affb7;width:100%}
/* Dialogue */
#bubble{
  position:absolute;left:50%;bottom:136px;transform:translateX(-50%);
  width:90%;min-height:96px;background:rgba(11,11,11,0.85);border-radius:6px;border:2px solid #ffd166;padding:12px;display:none;z-index:3
}
#bubbleText{white-space:pre-line;line-height:1.5}
/* Bottom UI */
#uiBar{
  position:absolute;left:50%;bottom:8px;transform:translateX(-50%);
  width:920px;height:108px;background:#111;border:2px solid #444;
  display:flex;align-items:center;justify-content:space-around;z-index:3
}
.btn{cursor:pointer;user-select:none;display:flex;align-items:center;gap:10px}
.key{width:20px;height:20px;border:2px solid #fff;display:flex;align-items:center;justify-content:center;font-weight:700}
.lab{font-size:20px;letter-spacing:1px;min-width:84px}
.btn:hover .lab{color:#fff}
/* Arena */
#arenaBox{
  position:absolute;left:240px;top:420px;width:480px;height:180px;border:3px solid #fff;display:none;pointer-events:none;z-index:2;
  box-shadow:0 0 12px rgba(255,255,255,0.35);
}
/* Toast */
#toast{position:absolute;left:50%;top:18px;transform:translateX(-50%);background:#111;border:1px solid #fff;color:#ffd166;padding:6px 10px;font-size:12px;opacity:0;transition:opacity .22s;pointer-events:none;z-index:5}
#toast.show{opacity:1}
/* Admin overlay */
#admin{position:absolute;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.65);z-index:10}
#panel{width:740px;max-width:95%;background:#0e0e0e;border:2px solid #fff;border-radius:6px;padding:14px;color:#ffd166}
.row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin:6px 0}
.sel,.inp,textarea{background:#111;color:#ffd166;border:1px solid #333;padding:6px 8px}
.btn2{padding:6px 10px;border:1px solid #fff;background:transparent;color:#ffd166;cursor:pointer;transition:background .15s}
.btn2:hover{background:#1b1b1f}
/* Equip overlay */
#equip{position:absolute;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.75);z-index:9}
#equipPanel{width:820px;max-width:95%;background:#0f0f12;border:2px solid #ffd166;color:#ffd166;padding:14px}
#equipHeader{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
#equipList{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.itemCard{border:1px solid #333;padding:8px;background:#121217;display:flex;justify-content:space-between;align-items:center}
.itemName{font-weight:700}
.itemDesc{color:#c9c9d6;font-size:12px}
.badge{border:1px solid #333;padding:2px 6px;font-size:12px;border-radius:4px;margin-left:6px}
.btn3{padding:6px 10px;border:1px solid #ffd166;background:#16161c;color:#ffd166;cursor:pointer}
</style>
</head>
<body>
<div id="wrap">
  <canvas id="cv" width="960" height="720"></canvas>

  <div id="hud">
    <div class="hcol" style="min-width:300px">
      <div id="bossName">—</div>
      <div class="bar" style="width:440px"><div id="bossFill" class="fill"></div></div>
      <div id="bossVal" style="font-size:12px">0/0</div>
    </div>
    <div class="hcol" style="align-items:flex-end;min-width:260px">
      <div id="playerName" style="color:#9be7c0">Traveler</div>
      <div class="bar" style="width:260px"><div id="hpFill" class="fill"></div></div>
      <div id="hpVal" style="font-size:12px">50/50</div>
      <div id="eqVal" style="font-size:12px;color:#fff1b6">Stick (+0 ATK)</div>
    </div>
  </div>

  <div id="bubble"><div id="bubbleText"></div></div>
  <div id="arenaBox"></div>

  <div id="uiBar">
    <div class="btn" data-act="FIGHT"><div class="key">Z</div><div class="lab">FIGHT</div></div>
    <div class="btn" data-act="ACT"><div class="key">A</div><div class="lab">ACT</div></div>
    <div class="btn" data-act="ITEM"><div class="key">I</div><div class="lab">ITEM</div></div>
    <div class="btn" data-act="MERCY"><div class="key">M</div><div class="lab">MERCY</div></div>
    <div class="btn" data-act="EQUIP"><div class="key">E</div><div class="lab">EQUIP</div></div>
  </div>

  <div id="toast">Admin opened</div>

  <!-- Admin overlay -->
  <div id="admin">
    <div id="panel">
      <div style="font-size:18px;font-weight:700;margin-bottom:8px">Admin</div>

      <div class="row" style="gap:8px;flex-wrap:nowrap">
        <button class="btn2" data-tab="boss">Boss</button>
        <button class="btn2" data-tab="power">Power</button>
        <button class="btn2" data-tab="lore">Lore</button>
        <button id="adClose" class="btn2" style="margin-left:auto">Close [X]</button>
      </div>

      <div id="adView-boss">
        <div class="row">
          <select id="adBoss" class="sel" style="min-width:260px"></select>
          <button id="adLoadBoss" class="btn2">Load</button>
          <button id="adEnd" class="btn2">End attack</button>
          <button id="adWin" class="btn2">Win</button>
        </div>
        <div class="row">
          <label>Difficulty</label>
          <select id="adDiff" class="sel"><option>Normal</option><option>Hard</option><option>Insane</option></select>
          <button id="adApplyDiff" class="btn2">Apply</button>
          <label>Global speed</label>
          <input id="adSpeed" class="inp" type="number" step="0.05" min="0.5" max="2" value="1.00"/>
          <button id="adApplySpeed" class="btn2">Apply</button>
        </div>
      </div>

      <div id="adView-power" style="display:none">
        <div class="row">
          <button id="adHealFull" class="btn2">Heal player to max</button>
          <button id="adInvinc" class="btn2">Toggle invincibility</button>
          <button id="adKillBoss" class="btn2">Set boss HP to 1</button>
          <button id="adGiveAll" class="btn2">Give all weapons</button>
        </div>
        <div class="row">
          <button id="adMaxMercy" class="btn2">Set mercy to max</button>
          <button id="adSkipWave" class="btn2">Skip current attack</button>
          <button id="adClearBullets" class="btn2">Clear bullets</button>
        </div>
      </div>

      <div id="adView-lore" style="display:none">
        <div class="row" style="flex-direction:column;align-items:stretch">
          <label>World lore</label>
          <textarea id="adLoreBox" rows="8" class="inp" placeholder="Write your world lore here..."></textarea>
          <div style="font-size:12px;color:#c9c9d6">Saved locally; appended to boss intro screens.</div>
          <button id="adSaveLore" class="btn2" style="margin-top:6px">Save lore</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Equip overlay -->
  <div id="equip">
    <div id="equipPanel">
      <div id="equipHeader">
        <div>
          <div style="font-size:18px;font-weight:700">Equipment</div>
          <div style="font-size:12px;color:#c9c9d6">Choose a weapon before the battle. Press X to close.</div>
        </div>
        <div><button id="equipClose" class="btn3">Close [X]</button></div>
      </div>
      <div style="margin-bottom:10px">
        <span>Equipped:</span>
        <span id="equippedName" class="badge">None</span>
      </div>
      <div id="equipList"></div>
      <div style="display:flex;gap:10px;margin-top:12px">
        <button id="btnUnequip" class="btn3">Unequip</button>
        <button id="btnStart" class="btn3">Start Battle</button>
      </div>
    </div>
  </div>
</div>

<script>
"use strict";

/* ---------------- Profile ---------------- */
const LS_PROFILE='utg_shared_profile_v1';
function loadProfile(){ try{ return JSON.parse(localStorage.getItem(LS_PROFILE))||{}; }catch{ return {}; } }
const PROFILE=loadProfile();
const PLAYER_NAME=(PROFILE.name||'Traveler').slice(0,16);
const HEART_COLOR=PROFILE.glow||'#ffd166';

/* ---------------- Elements ---------------- */
const cv=document.getElementById('cv');
const ctx=cv.getContext('2d',{alpha:false,desynchronized:true});
ctx.imageSmoothingEnabled=false;

const bossName=document.getElementById('bossName'), bossVal=document.getElementById('bossVal'), bossFill=document.getElementById('bossFill');
const playerNameEl=document.getElementById('playerName'); playerNameEl.textContent=PLAYER_NAME;
const hpVal=document.getElementById('hpVal'), hpFill=document.getElementById('hpFill'), eqVal=document.getElementById('eqVal');
const bubble=document.getElementById('bubble'), bubbleText=document.getElementById('bubbleText');
const uiBar=document.getElementById('uiBar'), arenaBox=document.getElementById('arenaBox'), toast=document.getElementById('toast');

/* Admin refs */
const admin=document.getElementById('admin');
const adClose=document.getElementById('adClose');
const adBoss=document.getElementById('adBoss');
const adLoadBoss=document.getElementById('adLoadBoss');
const adEnd=document.getElementById('adEnd');
const adWin=document.getElementById('adWin');
const adDiff=document.getElementById('adDiff');
const adApplyDiff=document.getElementById('adApplyDiff');
const adSpeed=document.getElementById('adSpeed');
const adApplySpeed=document.getElementById('adApplySpeed');
const adHealFull=document.getElementById('adHealFull');
const adInvinc=document.getElementById('adInvinc');
const adKillBoss=document.getElementById('adKillBoss');
const adGiveAll=document.getElementById('adGiveAll');
const adMaxMercy=document.getElementById('adMaxMercy');
const adSkipWave=document.getElementById('adSkipWave');
const adClearBullets=document.getElementById('adClearBullets');
const adLoreBox=document.getElementById('adLoreBox');
const adSaveLore=document.getElementById('adSaveLore');
const adTabs=[...document.querySelectorAll('#panel .btn2[data-tab]')];
const adViewBoss=document.getElementById('adView-boss');
const adViewPower=document.getElementById('adView-power');
const adViewLore=document.getElementById('adView-lore');

/* Equip refs */
const equip=document.getElementById('equip'), equipClose=document.getElementById('equipClose'), equipList=document.getElementById('equipList');
const btnStart=document.getElementById('btnStart'), btnUnequip=document.getElementById('btnUnequip'), equippedName=document.getElementById('equippedName');

/* ---------------- Save & constants ---------------- */
const SAVE_KEY='ug_refined_v2';
function loadSave(){ try{ return JSON.parse(localStorage.getItem(SAVE_KEY))||{} }catch{return {} } }
function saveWrite(d){ try{ localStorage.setItem(SAVE_KEY, JSON.stringify(d)); }catch{} }
let SAVE=loadSave();

const ARENA={x:240,y:420,w:480,h:180};
const TURN={PLAYER:'p',ENEMY:'e',TRANS:'t',WIN:'w',LOSE:'l'};
const DIFFS={ Normal:{spd:1.10,rate:1.10,dmg:1.40,lead:0.08}, Hard:{spd:1.28,rate:1.28,dmg:1.75,lead:0.10}, Insane:{spd:1.46,rate:1.40,dmg:2.10,lead:0.12} };

/* ---------------- Weapons & drops ---------------- */
const WEAPONS={
  stick:{id:'stick',name:'Stick',atk:0,desc:'Basic stick',source:'default'},
  solar:{id:'solar',name:'Solar Brand',atk:7,desc:'+7 ATK. Burns bright.',source:'solar'},
  ember:{id:'ember',name:'Ember Blade',atk:6,desc:'+6 ATK. Warm to the touch.',source:'ember'},
  abyss:{id:'abyss',name:'Abyss Poker',atk:8,desc:'+8 ATK. Unnerving point.',source:'abyss'},
  frost:{id:'frost',name:'Frost Lance',atk:9,desc:'+9 ATK. Chilling edge.',source:'frost'},
  storm:{id:'storm',name:'Thunder Knuckles',atk:10,desc:'+10 ATK. Crackling arcs.',source:'storm'},
  cupcakeLegend:{id:'cupcakeLegend',name:'Legendary Cupcake',atk:12,desc:'+12 ATK. Too sweet to handle.',source:'cupcake'},
  oblivLegend:{id:'oblivLegend',name:'Legendary Oblivion',atk:12,desc:'+12 ATK. Echoes of endings.',source:'oblivion'}
};
const BOSS_DROP={solar:'solar', ember:'ember', abyss:'abyss', frost:'frost', storm:'storm'};
const ADMIN_DROP={cupcake:'cupcakeLegend', oblivion:'oblivLegend'};

function ensureInventory(){
  if(!Array.isArray(SAVE.weapons)) SAVE.weapons=['stick'];
  if(!SAVE.currentWeapon) SAVE.currentWeapon='stick';
  if(!Array.isArray(SAVE.inventory)) SAVE.inventory=[
    {id:'dew',name:'Dew Petal',desc:'+12 HP',type:'heal',amount:12,count:2},
    {id:'honey',name:'Amber Honey',desc:'+18 HP',type:'heal',amount:18,count:1}
  ];
  if(!SAVE.difficulty) SAVE.difficulty='Normal';
  if(typeof SAVE.bossIndex!=='number') SAVE.bossIndex=0;
  if(typeof SAVE.hp!=='number') SAVE.hp=50;
  if(typeof SAVE.lore!=='string') SAVE.lore='';
  saveWrite(SAVE);
}
function hasWeapon(id){ return (SAVE.weapons||[]).includes(id); }
function addWeaponByBossKey(k,isAdmin=false){
  const wid = isAdmin ? ADMIN_DROP[k] : BOSS_DROP[k];
  if(!wid) return;
  if(!hasWeapon(wid)){ SAVE.weapons.push(wid); saveWrite(SAVE); toastMsg(`New weapon: ${WEAPONS[wid].name}`); }
}
function equippedWeapon(){ return WEAPONS[SAVE.currentWeapon]||WEAPONS.stick; }
function equippedLabel(){ const w=equippedWeapon(); return `${w.name} (+${w.atk} ATK)`; }

/* ---------------- Player ---------------- */
let DIFF=DIFFS[SAVE.difficulty||'Normal']||DIFFS.Normal;
let GLOBAL_SPEED=1.0;
const HEART={ x:ARENA.x+ARENA.w/2,y:ARENA.y+ARENA.h/2,r:5,sp:320,i:0,
  hp: Math.max(1,SAVE.hp||50), hpMax: Math.max(1,SAVE.hp||50),
  _px:0,_py:0,_pdt:1/60, glow:true
};
function centerHeart(){ HEART.x=ARENA.x+ARENA.w/2; HEART.y=ARENA.y+ARENA.h/2; }
function say(t){ bubble.style.display='block'; bubbleText.textContent=t; }
function hideSay(){ bubble.style.display='none'; }
function toastMsg(m){ toast.textContent=m; toast.classList.add('show'); setTimeout(()=>toast.classList.remove('show'),1100); }

/* Smooth bars */
let bossHPDisplay=HEART.hp, playerHPDisplay=HEART.hp;
function resetBars(){ bossHPDisplay=BOSS?BOSS.hp:0; playerHPDisplay=HEART.hp; }
function updateBars(dt){
  bossHPDisplay += (BOSS.hp - bossHPDisplay) * Math.min(1, dt*8);
  playerHPDisplay += (HEART.hp - playerHPDisplay) * Math.min(1, dt*8);

  const bf=Math.max(0, bossHPDisplay/BOSS.hpMax);
  bossFill.style.width=(440*bf)+'px';
  bossVal.textContent=`${Math.round(bossHPDisplay)}/${BOSS.hpMax}`;

  const pf=Math.max(0, playerHPDisplay/HEART.hpMax);
  let col='#7affb7'; if(pf<0.5) col='#ffd166'; if(pf<0.25) col='#ff5e6b';
  hpFill.style.background=col;
  hpFill.style.width=(260*pf)+'px';
  hpVal.textContent=`${Math.round(playerHPDisplay)}/${HEART.hpMax}`;
  eqVal.textContent=equippedLabel();
}

/* ---------------- State ---------------- */
let time=0, turn=TURN.PLAYER, mode='main', waveCount=0;
let bullets=[], attack=null, attackSeq=null, attackIx=0, damagePopup=null, showArena=false;
let bossIndex=(typeof SAVE.bossIndex==='number')?SAVE.bossIndex:0;
let BOSS=null, IS_ADMIN=false;
let ADMIN_INVINCIBLE=false;

/* Progression */
let nextBossPendingIndex = null;      // next normal boss after equip
let lastAdminWinReturnIndex = null;   // where to return after admin boss

/* ---------------- Helpers & drawing ---------------- */
const rand=(a,b)=>Math.random()*(b-a)+a;
function glow(x,y,r,fill,a=0.25){ ctx.save(); ctx.globalAlpha=a; ctx.fillStyle=fill; ctx.beginPath(); ctx.arc(x,y,r,0,Math.PI*2); ctx.fill(); ctx.restore(); }

/* Improved heart */
function drawHeartImproved(x,y,base=HEART_COLOR){
  const t=time, pulse=1+0.06*Math.sin(t*6), aGlow=0.20+0.08*Math.sin(t*4);
  glow(x,y,24*pulse,base,aGlow); glow(x,y,12*pulse,base,0.12);
  ctx.save(); ctx.translate(x,y);
  const blink = HEART.i>0 ? 0.45+0.45*Math.sin(t*32) : 1.0;
  ctx.globalAlpha = blink;
  ctx.lineWidth=2; ctx.strokeStyle='#111'; ctx.fillStyle=base;
  ctx.beginPath();
  ctx.moveTo(0,6);
  ctx.bezierCurveTo(-10,-8, -22,-6, -22,6);
  ctx.bezierCurveTo(-22,18, -10,26, 0,36);
  ctx.bezierCurveTo(10,26, 22,18, 22,6);
  ctx.bezierCurveTo(22,-6, 10,-8, 0,6);
  ctx.closePath(); ctx.fill(); ctx.stroke();
  ctx.globalAlpha = 0.25*blink; ctx.fillStyle='#ffffff';
  ctx.beginPath(); ctx.ellipse(-8,-2,6,4,0,0,Math.PI*2); ctx.fill();
  ctx.restore();
}

/* Boss visuals */
function drawBase(x,y,colors,t){
  glow(x,y,70,colors.aura,0.28); glow(x,y,40,colors.aura2||colors.aura,0.16);
  ctx.fillStyle=colors.head; ctx.beginPath(); ctx.arc(x, y-34, 12, 0, Math.PI*2); ctx.fill();
  ctx.fillStyle='#222'; ctx.beginPath(); ctx.arc(x-4,y-38,1.6,0,Math.PI*2); ctx.fill(); ctx.beginPath(); ctx.arc(x+4,y-38,1.6,0,Math.PI*2); ctx.fill();
  const g=ctx.createLinearGradient(x,y-24,x,y+20); g.addColorStop(0,colors.body); g.addColorStop(1,'#00000022');
  ctx.fillStyle=g; ctx.fillRect(x-11, y-24, 22, 46);
  ctx.fillStyle=colors.accent; ctx.fillRect(x-24,y-18,12,30); ctx.fillRect(x+12,y-18,12,30);
  ctx.strokeStyle=colors.emblem||'#ffd166'; ctx.lineWidth=1.8; ctx.beginPath(); ctx.arc(x, y-12, 6+Math.sin(t*3)*0.8,0,Math.PI*2); ctx.stroke();
}
function dSolar(t){ drawBase(480,240+Math.sin(t*2.2)*2,{aura:'#ffe9a0',aura2:'#fff4c8',head:'#fff3c8',body:'#ffd166',accent:'#ffe69a',emblem:'#ffcc55'},t); }
function dEmber(t){ drawBase(480,240+Math.sin(t*2.2)*2,{aura:'#ffc7b8',aura2:'#ffd7c6',head:'#ffe1d6',body:'#ffa277',accent:'#ffc2a4',emblem:'#ffbca0'},t); }
function dAbyss(t){ drawBase(480,240+Math.sin(t*2.2)*2,{aura:'#c7c0ff',aura2:'#e0dbff',head:'#efeaff',body:'#a89bff',accent:'#d7cffc',emblem:'#c9c1ff'},t); }
function dFrost(t){ drawBase(480,240+Math.sin(t*2.2)*2,{aura:'#cfeaff',aura2:'#e3f4ff',head:'#f1f9ff',body:'#d0f0ff',accent:'#c5ecff',emblem:'#aee3ff'},t); }
function dStorm(t){ drawBase(480,240+Math.sin(t*2.2)*2,{aura:'#fffac4',aura2:'#fffddc',head:'#fffbd1',body:'#ffd455',accent:'#ffec8a',emblem:'#ffe066'},t); }
function dPixel(t){ drawBase(480,240+Math.sin(t*2.2)*2,{aura:'#bff0ff',aura2:'#d8f7ff',head:'#eaffff',body:'#a8ecff',accent:'#bff3ff',emblem:'#a8ecff'},t); }
function dObliv(t){ drawBase(480,236+Math.sin(t*2.4)*2,{aura:'#1a141c',aura2:'#241c28',head:'#2a2230',body:'#0b0a0d',accent:'#3b3244',emblem:'#ffd166'},t); }
function dCupcake(t){ drawBase(480,240+Math.sin(t*2.4)*2,{aura:'#ff9ad6',aura2:'#ffd1ec',head:'#ffe6f7',body:'#ff7acb',accent:'#ffc3f3',emblem:'#fff'},t); }

/* Spawn & phases */
function spawn(b){ b.t=0; bullets.push(b); return b; }
function spawnAimed(fx,fy,speed,dmg,col='#fff',r=3,lead=DIFF.lead){
  const vx0=(HEART.x-(HEART._px||HEART.x))/(HEART._pdt||1/60);
  const vy0=(HEART.y-(HEART._py||HEART.y))/(HEART._pdt||1/60);
  const dx=HEART.x-fx, dy=HEART.y-fy, L=Math.hypot(dx,dy)||1;
  const vx=(dx/L)*speed*DIFF.spd + vx0*lead, vy=(dy/L)*speed*DIFF.spd + vy0*lead;
  return spawn({x:fx,y:fy,vx,vy,r, col, dmg:Math.max(1,Math.floor(dmg*DIFF.dmg))});
}
function ring(C,spd,col,dmg,n=12){ for(let k=0;k<n;k++){ const a=k/n*Math.PI*2; spawn({x:C.x,y:C.y,vx:Math.cos(a)*spd*DIFF.spd,vy:Math.sin(a)*spd*DIFF.spd,r:3,col,dmg}); } }
function phase(dur,...parts){ return { t:0, enter(){this.t=0;parts.forEach(p=>p.enter&&p.enter());}, update(dt){this.t+=dt;parts.forEach(p=>p.update&&p.update(dt));}, done(){return this.t>=dur;} }; }

/* Patterns */
const pFan = (col='#fff',spd=250,dmg=5,rate=.22)=>(d=3)=>{let t=0,g=0;rate/=DIFF.rate;return{enter(){} ,update(dt){dt*=GLOBAL_SPEED;t+=dt;g+=dt;if(g>=rate){g=0;const base=(Math.random()*0.8-0.4);for(const a of [base-0.7,base,base+0.7])spawn({x:ARENA.x+ARENA.w/2,y:ARENA.y+18,vx:Math.cos(a)*spd*DIFF.spd,vy:Math.sin(a)*spd*DIFF.spd,r:3,col,dmg});}},done(){return t>=d;}}};
const pRing = (col='#fff',spd=240,dmg=6,rate=.5)=>(d=3)=>{let t=0,g=0;rate/=DIFF.rate;const C={x:ARENA.x+ARENA.w/2,y:ARENA.y+ARENA.h/2};return{enter(){},update(dt){dt*=GLOBAL_SPEED;t+=dt;g+=dt;if(g>=rate){g=0;ring(C,spd,col,dmg,12)}},done(){return t>=d;}}};
const pWall = (col='#fff',vx=260,dmg=5,rate=.36)=>(d=3)=>{let t=0,g=0;rate/=DIFF.rate;return{enter(){},update(dt){dt*=GLOBAL_SPEED;t+=dt;g+=dt;if(g>=rate){g=0;const left=Math.random()<0.5;for(let i=0;i<5;i++){const y=ARENA.y+20+i*30;spawn({x:left?ARENA.x-24:ARENA.x+ARENA.w+24,y,vx:(left?1:-1)*vx*DIFF.spd,vy:0,r:3,col,dmg});}}},done(){return t>=d;}}};
const pHoming = (col='#fff',spd=210,dmg=5,rate=.46,lead=0.6)=>(d=3)=>{let t=0,g=0;rate/=DIFF.rate;return{enter(){},update(dt){dt*=GLOBAL_SPEED;t+=dt;g+=dt;if(g>=rate){g=0;const x=ARENA.x+rand(0,ARENA.w);spawnAimed(x,ARENA.y-10,spd,dmg,col,4,DIFF.lead*lead);}},done(){return t>=d;}}};
const pRain = (col='#fff',vy=240,dmg=4,rate=.18)=>(d=3)=>{let t=0,g=0;rate/=DIFF.rate;return{enter(){},update(dt){dt*=GLOBAL_SPEED;t+=dt;g+=dt;if(g>=rate){g=0;const x=ARENA.x+rand(10,ARENA.w-10);spawn({x,y:ARENA.y-18,vx:rand(-60,60),vy:vy*DIFF.spd,r:3,col,dmg});}},done(){return t>=d;}}};
const pSpiral = (col='#fff',spd=245,dmg=5,rate=.22)=>(d=3)=>{let t=0,g=0;rate/=DIFF.rate;return{enter(){},update(dt){dt*=GLOBAL_SPEED;t+=dt;g+=dt;if(g>=rate){g=0;const a=t*2.1;spawn({x:ARENA.x+ARENA.w/2,y:ARENA.y+ARENA.h/2,vx:Math.cos(a)*spd*DIFF.spd,vy:Math.sin(a)*spd*DIFF.spd,r:3,col,dmg});}},done(){return t>=d;}}};
const pOrbitThenShoot=(col='#bfb2ff',rad=70,spd=300,dmg=6,rate=.5)=>(d=3)=>{let t=0,g=0;rate/=DIFF.rate;return{enter(){},update(dt){dt*=GLOBAL_SPEED;t+=dt;g+=dt;if(g>=rate){g=0;const n=8;for(let k=0;k<n;k++){const a=k/n*Math.PI*2;spawn({x:HEART.x+Math.cos(a)*60,y:HEART.y+Math.sin(a)*60,vx:0,vy:0,r:3,col,dmg,orbit:true,ang:a});}}for(const bb of bullets){if(bb.orbit){bb.ang+=dt*2.0;bb.x=HEART.x+Math.cos(bb.ang)*rad;bb.y=HEART.y+Math.sin(bb.ang)*rad;if(Math.random()<0.03){const dx=HEART.x-bb.x,dy=HEART.y-bb.y;const L=Math.hypot(dx,dy)||1;bb.vx=dx/L*spd*DIFF.spd;bb.vy=dy/L*spd*DIFF.spd;bb.orbit=false;}}}},done(){return t>=d;}}};
const pPullWell=(col='#c9b9ff',pull=0.38,ringRate=0.2,spd=280,dmg=7)=>(d=3)=>{let t=0;const C={x:ARENA.x+ARENA.w/2,y:ARENA.y+ARENA.h/2};return{enter(){},update(dt){dt*=GLOBAL_SPEED;t+=dt;const dx=C.x-HEART.x,dy=C.y-HEART.y;HEART.x+=dx*pull*dt;HEART.y+=dy*pull*dt;if(Math.random()<ringRate){const a=Math.random()*Math.PI*2;spawn({x:C.x,y:C.y,vx:Math.cos(a)*spd*DIFF.spd,vy:Math.sin(a)*spd*DIFF.spd,r:3,col,dmg});}},done(){return t>=d;}}};

/* ---------------- Boss roster (normal only) ---------------- */
const BOSSES = [
  { key:'solar', name:'Solar Fang', hpMax:360, draw:dSolar,
    intro:["The sun bows to no one.","Step into the flare, "+PLAYER_NAME+"."],
    lines:["Burn bright.","Hold.","Again."],
    mercyNeed:3, drop:'solar',
    actDefs:[
      {name:'Bow',say:"Respect accepted.",effect:s=>{s.mercy=(s.mercy||0)+1;}},
      {name:'Compliment',say:"Your courage glows.",effect:s=>{s.mercy=(s.mercy||0)+1;}},
      {name:'Focus',say:"Steady breath.",effect:s=>{HEART.i=Math.max(HEART.i,0.75);}},
      {name:'Taunt',say:"Heat rises.",effect:s=>{s.flags.boost=1.15;}}
    ],
    attacks:()=>[
      phase(3, pFan('#fff3b8',250,5,.22)(3)),
      phase(3, pRing('#ffd166',255,6,.50)(3)),
      phase(3, pWall('#ffe9a0',260,6,.36)(3)),
      phase(3, pSpiral('#ffd166',245,6,.22)(3)),
      phase(3, pRing('#fff1b6',240,6,.55)(3))
    ]
  },
  { key:'ember', name:'Ember Seraph', hpMax:340, draw:dEmber,
    intro:["Ash remembers flame.","Match my tempo."],
    lines:["Soft steps.","Patience.","You learn."],
    mercyNeed:3, drop:'ember',
    actDefs:[
      {name:'Listen',say:"Silence shared.",effect:s=>{s.mercy=(s.mercy||0)+1; s.flags.nextSlow=0.85;}},
      {name:'Apologize',say:"Forgiven.",effect:s=>{s.mercy=(s.mercy||0)+1;}},
      {name:'Hum',say:"On pitch.",effect:s=>{s.mercy=(s.mercy||0)+1;}},
      {name:'Smile',say:"Warmth spreads.",effect:s=>{HEART.hp=Math.min(HEART.hpMax,HEART.hp+6);}}
    ],
    attacks:()=>[
      phase(3.2, pRain('#ffb7a7',240,4,.16)(3.2)),
      phase(3, pHoming('#ffd3a0',210,5,.46,0.6)(3)),
      phase(3, pWall('#ffa277',270,5,.42)(3)),
      phase(3, pFan('#ffc4a3',240,5,.28)(3)),
      phase(3, pRing('#ffb286',235,5,.55)(3))
    ]
  },
  { key:'abyss', name:'Abyss Jester', hpMax:360, draw:dAbyss,
    intro:["Smile through the dark.","Look twice."],
    lines:["Ping.","Closer.","Heh."],
    mercyNeed:3, drop:'abyss',
    actDefs:[
      {name:'Wave',say:"Wave returned.",effect:s=>{s.mercy=(s.mercy||0)+1;}},
      {name:'Laugh',say:"Heh.",effect:s=>{s.mercy=(s.mercy||0)+1;}},
      {name:'Compliment',say:"Flattery accepted.",effect:s=>{s.mercy=(s.mercy||0)+1;}},
      {name:'Ignore',say:"Bold.",effect:s=>{s.flags.boost=1.06;}}
    ],
    attacks:()=>[
      phase(3, pWall('#b0a0ff',260,5,.28)(3)),
      phase(3, pRain('#c0b3ff',250,4,.20)(3)),
      phase(3, pHoming('#bfb3ff',225,6,.50,1.0)(3)),
      phase(3, pFan('#cfc6ff',235,5,.30)(3)),
      phase(3, pRing('#b9afff',245,6,.60)(3))
    ]
  },
  { key:'frost', name:'Frostbite Warden', hpMax:380, draw:dFrost,
    intro:["Cold clarifies.","Hold steady."],
    lines:["Still water.","Brace.","Now."],
    mercyNeed:3, drop:'frost',
    actDefs:[
      {name:'Shiver',say:"Accepted.",effect:s=>{s.mercy=(s.mercy||0)+1;}},
      {name:'Respect',say:"Noted.",effect:s=>{s.mercy=(s.mercy||0)+1; s.flags.nextSlow=0.85;}},
      {name:'Warmth',say:"Fingers thaw.",effect:s=>{HEART.hp=Math.min(HEART.hpMax,HEART.hp+5);}},
      {name:'Apologize',say:"Forgiven.",effect:s=>{s.mercy=(s.mercy||0)+1;}}
    ],
    attacks:()=>[
      phase(3, pRain('#d0f0ff',235,5,.26)(3)),
      phase(3, pFan('#e6f7ff',235,5,.34)(3)),
      phase(3, pRing('#d0f0ff',220,6,.70)(3)),
      phase(3, pWall('#c5ecff',280,5,.42)(3)),
      phase(3, pSpiral('#bfe7ff',245,5,.24)(3))
    ]
  },
  { key:'storm', name:'Storm Herald', hpMax:420, draw:dStorm,
    intro:["Thunder answers.","Stand in it."],
    lines:["Crack.","Flash.","Boom."],
    mercyNeed:4, drop:'storm',
    actDefs:[
      {name:'Stand Firm',say:"You brace the strike.",effect:s=>{HEART.i=Math.max(HEART.i,0.8);}},
      {name:'Compliment',say:"They nod once.",effect:s=>{s.mercy=(s.mercy||0)+1;}},
      {name:'Sync Breath',say:"Timing improves.",effect:s=>{s.flags.nextSlow=0.85;}},
      {name:'Taunt',say:"Sky angrier.",effect:s=>{s.flags.boost=1.25;}}
    ],
    attacks:()=>[
      phase(3, pWall('#ffe066',280,7,.22)(3)),
      phase(3, pRain('#ffea80',320,8,.32)(3)),
      phase(3, pSpiral('#fff59a',255,7,.22)(3)),
      phase(3, pRing('#ffe066',250,7,.44)(3)),
      phase(3, pFan('#fff59a',260,7,.24)(3))
    ]
  },
  { key:'pixel', name:'Pixel Phantom', hpMax:350, draw:dPixel,
    intro:["gl1tch... r3ady?","hold the frame."],
    lines:["tearing...","lag spike","packet lost"],
    mercyNeed:3, drop:null,
    actDefs:[
      {name:'Debug',say:"errors reduced.",effect:s=>{s.mercy=(s.mercy||0)+1; s.flags.nextSlow=0.85;}},
      {name:'Compliment',say:"shader praised.",effect:s=>{s.mercy=(s.mercy||0)+1;}},
      {name:'Reboot',say:"temp calm.",effect:s=>{HEART.i=Math.max(HEART.i,0.75);}},
      {name:'Ignore',say:"…",effect:s=>{}}
    ],
    attacks:()=>[
      phase(3, pWall('#a8ecff',270,5,.18)(3)),
      phase(3, pSpiral('#a8ecff',245,6,.22)(3)),
      phase(3, pHoming('#7fdcff',170,5,.46,0.5)(3)),
      phase(3, pRain('#9fe0ff',250,4,.28)(3)),
      phase(3, pRing('#a8ecff',235,6,.55)(3))
    ]
  }
];

/* ---------------- Admin bosses (panel-only) ---------------- */
const ADMIN_BOSSES = {
  oblivion: {
    key:'oblivion', name:'Oblivion Herald', hpMax:720, draw:dObliv,
    intro:["entropy remembers you.","endings echo.","only now exists."],
    lines:["closer","unmake","reverse","again"],
    mercyNeed:8, drop:'oblivLegend',
    actDefs:[
      {name:'Bow', say:"acknowledged.", effect:s=>{s.mercy=(s.mercy||0)+1;}},
      {name:'Resist', say:"defiance mapped.", effect:s=>{s.flags.nextSlow=0.85;}},
      {name:'Reflect', say:"brief light returns.", effect:s=>{HEART.i=Math.max(HEART.i,0.95);}},
      {name:'Accept', say:"peace is choice.", effect:s=>{s.mercy=(s.mercy||0)+1;}}
    ],
    attacks:()=>[
      phase(3, pFan('#fff59a',260,7,.20)(3)),
      phase(3, pRing('#ffd166',260,7,.50)(3)),
      phase(3, pRain('#ffea80',330,8,.30)(3)),
      phase(3, pOrbitThenShoot('#bfb2ff',72,305,7,.5)(3)),
      phase(3, pHoming('#ffd3a0',220,7,.40,0.8)(3)),
      phase(3, pWall('#c5ecff',300,7,.38)(3)),
      phase(3, pSpiral('#a8ecff',260,7,.22)(3)),
      phase(3, pPullWell('#c9b9ff',0.42,0.22,290,8)(3)),
      phase(3, pRing('#b9afff',260,8,.48)(3)),
      phase(3, pFan('#fff1b6',280,9,.18)(3))
    ]
  },
  cupcake: {
    key:'cupcake', name:'The Cupcake Incident', hpMax:800, draw:dCupcake,
    intro:["The frosting trembles.","Sprinkles rain down.","You regret everything."],
    lines:["Sweet doom.","Sugar crash.","Frosting storm.","Sprinkle rain."],
    mercyNeed:8, drop:'cupcakeLegend',
    actDefs:[
      {name:'Apologize',say:"Too late.",effect:s=>{s.flags.boost=1.25;}},
      {name:'Compliment',say:"Cupcake ignores you.",effect:s=>{}},
      {name:'Taste',say:"It burns sweet.",effect:s=>{HEART.hp=Math.max(1,HEART.hp-6);}},
      {name:'Dance',say:"Sprinkles swirl faster.",effect:s=>{s.flags.nextSlow=0.9;}}
    ],
    attacks:()=>[
      phase(3, pRain('#ffb7e6',270,6,.18)(3)),
      phase(3, pRing('#ff91e6',260,7,.50)(3)),
      phase(3, pFan('#ffc4f0',275,7,.22)(3)),
      phase(3, pWall('#ff7acb',300,8,.36)(3)),
      phase(3, pSpiral('#ff9ad6',265,8,.22)(3)),
      phase(3, pOrbitThenShoot('#ffc3f3',72,315,7,.5)(3)),
      phase(3, pPullWell('#ffb6f2',0.44,0.25,300,8)(3)),
      phase(3, pRain('#ff91e6',320,9,.20)(3)),
      phase(3, pRing('#ff7acb',285,9,.40)(3)),
      phase(3, pFan('#ffc3f3',290,10,.18)(3))
    ]
  }
};

/* ---------------- Admin UI logic ---------------- */
function showAdminView(name){
  adViewBoss.style.display = (name==='boss')?'block':'none';
  adViewPower.style.display = (name==='power')?'block':'none';
  adViewLore.style.display = (name==='lore')?'block':'none';
}
adTabs.forEach(btn=>btn.addEventListener('click',()=>showAdminView(btn.dataset.tab),{passive:true}));

function buildAdminLists(){
  adBoss.innerHTML='';
  BOSSES.forEach((b,i)=>{ const o=document.createElement('option'); o.value='main:'+i; o.textContent=`${i+1}. ${b.name}`; adBoss.appendChild(o); });
  for(const k of Object.keys(ADMIN_BOSSES)){ const o=document.createElement('option'); o.value='admin:'+k; o.textContent=ADMIN_BOSSES[k].name; adBoss.appendChild(o); }
  adBoss.value='main:'+bossIndex;
  adDiff.value=SAVE.difficulty||'Normal';
  adSpeed.value=(GLOBAL_SPEED||1).toFixed(2);
  adLoreBox.value = SAVE.lore || '';
}
function openAdmin(){ admin.style.display='flex'; buildAdminLists(); showAdminView('boss'); }
function closeAdmin(){ admin.style.display='none'; }

adClose.onclick=()=> closeAdmin();
adLoadBoss.onclick=()=>{ const v=adBoss.value; if(v.startsWith('admin:')) initBoss(v); else initBoss(parseInt(v.split(':')[1],10)||0); };
adEnd.onclick=()=>{ if(turn===TURN.ENEMY) endAttack(); };
adWin.onclick=()=>{ if(BOSS){ BOSS.hp=0; updateBossBar(); win(false); } };
adApplyDiff.onclick=()=>{ const d=adDiff.value; SAVE.difficulty=d; DIFF=DIFFS[d]||DIFFS.Normal; saveWrite(SAVE); toastMsg(`Difficulty: ${d}`); };
adApplySpeed.onclick=()=>{ const v=parseFloat(adSpeed.value)||1; GLOBAL_SPEED=Math.max(0.5,Math.min(2,v)); toastMsg(`Speed x${GLOBAL_SPEED.toFixed(2)}`); };

adHealFull.onclick=()=>{ HEART.hp=HEART.hpMax; toastMsg('Player healed'); };
adInvinc.onclick=()=>{ ADMIN_INVINCIBLE=!ADMIN_INVINCIBLE; toastMsg(`Invincibility ${ADMIN_INVINCIBLE?'ON':'OFF'}`); };
adKillBoss.onclick=()=>{ if(BOSS){ BOSS.hp=1; updateBossBar(); toastMsg('Boss HP set to 1'); } };
adGiveAll.onclick=()=>{ SAVE.weapons=[...new Set(Object.keys(WEAPONS))]; saveWrite(SAVE); toastMsg('All weapons granted'); };
adMaxMercy.onclick=()=>{ if(BOSS){ BOSS.mercy=BOSS.mercyNeed; toastMsg('Mercy set to max'); } };
adSkipWave.onclick=()=>{ if(turn===TURN.ENEMY && attack){ attack.t=999; toastMsg('Attack skipped'); } };
adClearBullets.onclick=()=>{ bullets.length=0; toastMsg('Bullets cleared'); };
adSaveLore.onclick=()=>{ SAVE.lore=adLoreBox.value||''; saveWrite(SAVE); toastMsg('Lore saved'); };

/* ---------------- Equip system ---------------- */
function buildEquipList(){
  equippedName.textContent = (WEAPONS[SAVE.currentWeapon]||WEAPONS.stick).name;
  equipList.innerHTML='';
  (SAVE.weapons||[]).forEach(id=>{
    const w=WEAPONS[id]; if(!w) return;
    const card=document.createElement('div'); card.className='itemCard';
    const left=document.createElement('div');
    const nm=document.createElement('div'); nm.className='itemName'; nm.textContent=w.name;
    const ds=document.createElement('div'); ds.className='itemDesc'; ds.textContent=`+${w.atk} ATK — ${w.desc}`;
    left.appendChild(nm); left.appendChild(ds);
    const right=document.createElement('div');
    const own=document.createElement('span'); own.className='badge'; own.textContent='Owned';
    const btn=document.createElement('button'); btn.className='btn3'; btn.textContent=(SAVE.currentWeapon===w.id)?'Equipped':'Equip';
    btn.onclick=()=>{ SAVE.currentWeapon=w.id; saveWrite(SAVE); updateHPUI(); buildEquipList(); toastMsg(`Equipped ${w.name}`); };
    right.appendChild(own); right.appendChild(btn);
    card.appendChild(left); card.appendChild(right);
    equipList.appendChild(card);
  });
}
function openEquip(){ buildEquipList(); equip.style.display='flex'; }
function closeEquip(){ equip.style.display='none'; }
equipClose.onclick=closeEquip;
btnUnequip.onclick=()=>{ SAVE.currentWeapon='stick'; saveWrite(SAVE); updateHPUI(); buildEquipList(); toastMsg('Unequipped'); };

/* After-win next boss handoff */
btnStart.onclick=()=>{
  closeEquip();
  if(nextBossPendingIndex!==null){
    const target = nextBossPendingIndex;
    nextBossPendingIndex = null;
    initBoss(target);
  } else {
    say('Ready.');
  }
};

/* Inline equip (like item menu) */
function equipInlineList(){
  const owned = SAVE.weapons || [];
  if(owned.length===0) return "No weapons.";
  return owned.map((id,i)=>{
    const w = WEAPONS[id] || WEAPONS.stick;
    const mark = (SAVE.currentWeapon===id) ? ' (equipped)' : '';
    return ` ${i+1}. ${w.name} +${w.atk} ATK${mark}`;
  }).join('\n');
}
function doEquipInline(i){
  const owned = SAVE.weapons || [];
  const id = owned[i];
  if(!id) { say('No such weapon.'); return; }
  SAVE.currentWeapon = id; saveWrite(SAVE);
  say(`Equipped ${WEAPONS[id].name} (+${WEAPONS[id].atk} ATK).`);
  endPlayerTurn();
}

/* ---------------- Boss flow ---------------- */
function setBossFromObj(obj,isAdmin=false){
  BOSS={ key:obj.key,name:obj.name,hpMax:obj.hpMax,hp:obj.hpMax,draw:obj.draw,
    intro:[...obj.intro],lines:[...obj.lines],mercyNeed:obj.mercyNeed,mercy:0,
    flags:{nextSlow:1,boost:1}, actDefs:obj.actDefs.map(x=>x), attacks:obj.attacks, drop:obj.drop||null
  };
  IS_ADMIN=isAdmin;
  attackSeq=BOSS.attacks(); attackIx=0; waveCount=0;
  bossName.textContent=BOSS.name; bossFill.style.width='100%'; bossVal.textContent=`${BOSS.hp}/${BOSS.hpMax}`;
  resetBars();
}
function initBoss(sel){
  if(typeof sel==='string' && sel.startsWith('admin:')){
    const key=sel.split(':')[1]; setBossFromObj(ADMIN_BOSSES[key], true);
  } else {
    const ix=(typeof sel==='number'?sel:bossIndex)|0; bossIndex=Math.max(0,Math.min(BOSSES.length-1,ix)); setBossFromObj(BOSSES[bossIndex], false);
  }
  HEART.hp=HEART.hpMax=Math.max(1,SAVE.hp||50); HEART.i=0; centerHeart();
  turn=TURN.PLAYER; mode='main'; showArena=false; arenaBox.style.display='none';
  const loreLine=(SAVE.lore && SAVE.lore.trim())?`\n— Lore —\n${SAVE.lore.trim()}`:'';
  say(((BOSS.intro||[]).join('\n'))+loreLine);
  saveWrite({...SAVE,bossIndex, hp:HEART.hpMax});
}
function updateBossBar(){ const frac=Math.max(0,BOSS.hp/BOSS.hpMax); bossFill.style.width=(440*frac)+'px'; bossVal.textContent=`${BOSS.hp}/${BOSS.hpMax}`; }

/* ---------------- Input & movement ---------------- */
const held=new Set();
addEventListener('keydown',e=>{
  // X exits overlays and menus
  if(e.key==='x'||e.key==='X'||e.key==='Escape'){
    if(admin.style.display==='flex'){ closeAdmin(); return; }
    if(equip.style.display==='flex'){ closeEquip(); return; }
    if(mode==='act'||mode==='item'||mode==='equip'){ mode='main'; say('Your turn.'); return; }
  }
  // movement allowed only during enemy turn
  if(['ArrowLeft','ArrowRight','ArrowUp','ArrowDown','a','A','d','D','w','W','s','S'].includes(e.key)){
    if(!(turn===TURN.ENEMY && mode==='main')) return;
  }
  held.add(e.key);
  // Open hidden admin triggers
  handleHiddenTriggers(e.key);
},{passive:true});
addEventListener('keyup',e=>held.delete(e.key),{passive:true});
function key(k){ return held.has(k)||held.has(k.toUpperCase()); }

function moveHeart(dt){
  if(turn!==TURN.ENEMY || mode!=='main') return;
  let dx=0,dy=0; if(key('ArrowLeft')||key('a'))dx-=1; if(key('ArrowRight')||key('d'))dx+=1; if(key('ArrowUp')||key('w'))dy-=1; if(key('ArrowDown')||key('s'))dy+=1;
  const L=Math.hypot(dx,dy)||1;
  HEART.x=Math.max(ARENA.x+HEART.r,Math.min(ARENA.x+ARENA.w-HEART.r, HEART.x+dx/L*HEART.sp*dt));
  HEART.y=Math.max(ARENA.y+HEART.r,Math.min(ARENA.y+ARENA.h-HEART.r, HEART.y+dy/L*HEART.sp*dt));
  HEART._pdt=dt; HEART._px=HEART.x; HEART._py=HEART.y;
}

/* ---------------- Bullets & collide ---------------- */
function updateBullets(dt){
  const s=(BOSS.flags.nextSlow||1)*GLOBAL_SPEED;
  for(const b of bullets){ b.t=(b.t||0)+dt; b.x+=b.vx*dt*s; b.y+=b.vy*dt*s; }
  const m=240; bullets=bullets.filter(b=> b.x>ARENA.x-m && b.x<ARENA.x+ARENA.w+m && b.y>ARENA.y-m && b.y<ARENA.y+ARENA.h+m );
}
function collide(){
  if(ADMIN_INVINCIBLE) return;
  if(HEART.i>0) return;
  for(const b of bullets){
    const dx=b.x-HEART.x, dy=b.y-HEART.y; const rr=(b.r||4)+HEART.r;
    if(dx*dx+dy*dy<=rr*rr){
      const dmg=Math.max(1,Math.floor((b.dmg||3)*(BOSS.flags.boost||1)));
      HEART.hp=Math.max(0, HEART.hp-dmg); HEART.i=0.85; // i-frames
      break;
    }
  }
}

/* ---------------- Turns ---------------- */
function startAttack(){
  bullets.length=0; showArena=true; arenaBox.style.display='block';
  hideSay(); uiBar.style.opacity='0'; uiBar.style.pointerEvents='none';
  attack=attackSeq[attackIx]; attackIx=(attackIx+1)%attackSeq.length; attack.enter&&attack.enter();
}
function endAttack(){
  showArena=false; arenaBox.style.display='none'; uiBar.style.opacity='1'; uiBar.style.pointerEvents='auto';
  BOSS.flags.nextSlow=1; BOSS.flags.boost=1;
  turn=TURN.PLAYER; mode='main'; waveCount++;
  say((BOSS.lines[Math.floor(Math.random()*BOSS.lines.length)]||'...')+'\n(Hint: Press E to EQUIP inline)');
  attack=null;
}
function bossHit(baseDmg){
  const w=equippedWeapon();
  const dealt=Math.max(1,Math.floor((baseDmg + (w.atk||0))/(BOSS.flags.boost||1)));
  BOSS.hp=Math.max(0,BOSS.hp-dealt);
  updateBossBar();
  damagePopup={x:480,y:200,t:0,text:String(dealt)};
}

/* ---------------- UI actions ---------------- */
uiBar.addEventListener('click', e=>{
  const btn=e.target.closest('.btn'); if(!btn) return; handleAction(btn.dataset.act);
});

addEventListener('keydown', e=>{
  if(turn!==TURN.PLAYER) return;

  if(mode==='main'){
    if(['z','Z','Enter',' '].includes(e.key)) handleAction('FIGHT');
    if(e.key==='a'||e.key==='A') handleAction('ACT');
    if(e.key==='i'||e.key==='I') handleAction('ITEM');
    if(e.key==='m'||e.key==='M') handleAction('MERCY');
    if(e.key==='e'||e.key==='E') handleAction('EQUIP'); // inline equip menu
  }else if(mode==='act'){
    if('1234'.includes(e.key)) doAct(parseInt(e.key,10)-1);
  }else if(mode==='item'){
    if('1234'.includes(e.key)){ const msg=useItem(parseInt(e.key,10)-1); say(msg); endPlayerTurn(); }
  }else if(mode==='equip'){
    const ownedCount = (SAVE.weapons||[]).length;
    if(/[1-9]/.test(e.key)){
      const ix = parseInt(e.key,10)-1;
      if(ix>=0 && ix<ownedCount) doEquipInline(ix);
    }
  }
},{passive:true});

function handleAction(act){
  if(turn!==TURN.PLAYER || mode!=='main'){ if(act==='MERCY') tryMercy(); return; }

  if(act==='FIGHT'){
    say(`${PLAYER_NAME} strikes!`);
    bossHit(24);
    endPlayerTurn();
    return;
  }

  if(act==='ACT'){
    mode='act';
    const list=BOSS.actDefs.map((a,i)=>` ${i+1}. ${a.name}`).join('\n');
    say(`ACT on ${BOSS.name}:\n${list}\n(Use 1-4, X to exit)`);
    return;
  }

  if(act==='ITEM'){
    mode='item';
    say(`ITEMS:\n${itemsList()}\nPick 1-4 (X to exit)`);
    return;
  }

  if(act==='MERCY'){
    tryMercy();
    return;
  }

  if(act==='EQUIP'){
    mode='equip';
    say(`EQUIP:\n${equipInlineList()}\nPick 1-${(SAVE.weapons||[]).length} (X to exit)`);
    return;
  }
}

function doAct(i){
  const a=BOSS.actDefs[i]; if(!a){ say('No such ACT.'); return; }
  a.effect(BOSS); say(a.say);
  if((BOSS.mercy||0)>=BOSS.mercyNeed) say(`${BOSS.name} seems more willing to listen.`);
  endPlayerTurn();
}
function endPlayerTurn(){ turn=TURN.TRANS; setTimeout(()=>{ if(turn!==TURN.TRANS) return; turn=TURN.ENEMY; uiBar.style.opacity='0'; uiBar.style.pointerEvents='none'; startAttack(); },140); }
function tryMercy(){
  if(waveCount>=5 && (BOSS.mercy||0)>=(BOSS.mercyNeed||99)) win(true);
  else say(`${BOSS.name} isn't ready to be spared.`);
}

/* ---------------- Items ---------------- */
let inventory=SAVE.inventory || [];
function itemsList(){ if(inventory.length===0) return "No items."; return inventory.map((it,i)=>` ${i+1}. ${it.name} (${it.count}) — ${it.desc}`).join('\n'); }
function useItem(i){
  const it=inventory[i]; if(!it||it.count<=0) return "Empty.";
  if(it.type==='heal'){
    HEART.hp=Math.min(HEART.hpMax, HEART.hp+(it.amount||10));
    it.count--; if(it.count<=0) inventory.splice(i,1);
    SAVE.inventory=inventory; saveWrite(SAVE);
    return `You used ${it.name}. +${it.amount} HP`;
  }
  return "Nothing happened.";
}

/* ---------------- Win/lose + progression ---------------- */
function lose(){ if(turn===TURN.LOSE) return; turn=TURN.LOSE; say('You fall. The hall dims.'); setTimeout(()=>initBoss(IS_ADMIN?'admin:oblivion':bossIndex),900); }

function win(spared){
  if(turn===TURN.WIN) return; turn=TURN.WIN;
  say(`${spared?'You spared':'You defeated'} ${BOSS.name}.`);

  // Drops
  if(IS_ADMIN) addWeaponByBossKey(BOSS.key,true);
  else if(BOSS.drop) addWeaponByBossKey(BOSS.key,false);

  // Decide next target
  if(IS_ADMIN){
    lastAdminWinReturnIndex = bossIndex; // go back to current normal boss
    nextBossPendingIndex = bossIndex;
  } else {
    const next = bossIndex + 1;
    if(next < BOSSES.length){
      nextBossPendingIndex = next;
    } else {
      nextBossPendingIndex = 0;
      say('Ending: You carried your choices.');
    }
  }

  // Open equip overlay after a beat; Start loads next
  setTimeout(()=>{ openEquip(); }, 450);
}

/* ---------------- Hidden Admin Triggers: 67×3 + words ---------------- */
const ADMIN_TRIG_WORDS=['skibidi','overdrive'];
const ADMIN_TRIG_MAXLEN=Math.max(...ADMIN_TRIG_WORDS.map(w=>w.length),7);
let secretBuf='', pairCount=0, secretCooldown=0, wordBuf='';
function handleHiddenTriggers(k){
  const key=String(k||'').toLowerCase();
  if(secretCooldown>0) secretCooldown--;
  if(key==='6'||key==='7'){
    if(secretCooldown<=0){
      secretBuf=(secretBuf+key).slice(-2);
      if(secretBuf==='67'){
        pairCount++; secretBuf=''; secretCooldown=10;
        if(pairCount>=3){ pairCount=0; wordBuf=''; openAdmin(); toastMsg('Admin opened'); }
      }
    }
  } else { secretBuf=''; pairCount=0; }
  if(/^[a-z]$/.test(key)){
    wordBuf=(wordBuf+key).slice(-ADMIN_TRIG_MAXLEN);
    for(const w of ADMIN_TRIG_WORDS){
      if(wordBuf.endsWith(w)){ wordBuf=''; secretBuf=''; pairCount=0; openAdmin(); toastMsg('Admin opened'); break; }
    }
  }
}

/* ---------------- Render + main loop ---------------- */
function render(){
  ctx.fillStyle='#08070a'; ctx.fillRect(0,0,960,720);
  ctx.fillStyle='#141018'; for(let i=0;i<64;i++){const x=(i*137)%960, y=(i*173)%720; ctx.fillRect(x,y,2,2);}

  if(BOSS && typeof BOSS.draw==='function') BOSS.draw(time);

  if(turn===TURN.ENEMY && showArena){
    ctx.strokeStyle='#ffffff'; ctx.lineWidth=3; ctx.strokeRect(ARENA.x,ARENA.y,ARENA.w,ARENA.h);
    for(const b of bullets){ ctx.fillStyle=b.col||'#fff'; ctx.beginPath(); ctx.arc(b.x,b.y,b.r||4,0,Math.PI*2); ctx.fill(); }
    drawHeartImproved(HEART.x,HEART.y,HEART_COLOR);
  }

  if(damagePopup){
    damagePopup.t+=0.016*GLOBAL_SPEED;
    const a=Math.max(0,1-damagePopup.t/0.9);
    ctx.save(); ctx.globalAlpha=a; ctx.fillStyle='#fff1b6'; ctx.font='16px monospace';
    ctx.fillText(damagePopup.text, damagePopup.x, 200-damagePopup.t*60);
    ctx.restore();
    if(damagePopup.t>0.9) damagePopup=null;
  }
}
let last=performance.now();
function loop(now){
  const dt=Math.min(0.033, Math.max(0,(now-last)/1000)); last=now; time+=dt;
  if(HEART.i>0){ HEART.i=Math.max(0, HEART.i-dt); }
  if(turn===TURN.ENEMY){
    moveHeart(dt);
    attack&&attack.update&&attack.update(dt);
    updateBullets(dt);
    collide();
    if(HEART.hp<=0) lose();
    if(attack&&attack.done&&attack.done()) endAttack();
  }
  updateBars(dt);
  render();
  requestAnimationFrame(loop);
}

/* ---------------- Start ---------------- */
ensureInventory();
updateBars(0.016);
buildAdminLists();
openEquip(); // pre-battle equip on load
initBoss((bossIndex>=0 && bossIndex<BOSSES.length)? bossIndex : 0);
requestAnimationFrame(loop);
cv.focus();
</script>
</body>
</html>

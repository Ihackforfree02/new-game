<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Undertale Gold â€” working baseline</title>
<style>
:root{--fg:#ffd166;--hp:#ff6b6b;--emerald:#7affb7;--ui:#0b0b0b;--line:#262626;--white:#fff}
html,body{height:100%;margin:0;background:#000;color:var(--fg);font-family:ui-monospace,monospace;image-rendering:pixelated;overflow:hidden}
#stage{position:fixed;left:50%;top:50%;transform-origin:top left}
#wrap{position:relative;width:960px;height:720px}
canvas{display:block;width:960px;height:720px;border:4px solid #0a0a0f;background:#070606}

/* HUD */
#bossHUD{position:absolute;left:20px;top:22px;display:flex;flex-direction:column;gap:6px;z-index:3}
#bossName{font-size:13px}
#bossHP{height:10px;width:360px;background:#141414;border:1px solid #383838;position:relative}
#bossHPFill{position:absolute;left:0;top:0;bottom:0;background:var(--hp);width:100%}
#bossHPVal{font-size:12px;margin-top:2px}
#playerHUD{position:absolute;right:20px;top:22px;display:flex;flex-direction:column;gap:6px;align-items:flex-end;z-index:3}
#playerNameLabel{font-size:13px;color:#9be7c0}
#pHP{height:10px;width:220px;background:#141414;border:1px solid #383838;position:relative}
#pHPFill{position:absolute;left:0;top:0;bottom:0;background:var(--emerald);width:100%}
#pHPVal{font-size:12px;margin-top:2px}

/* Arena */
#box{position:absolute;left:240px;top:420px;width:480px;height:180px;border:3px solid #fff;display:none;z-index:1}

/* Dialogue */
#bubble{position:absolute;left:50%;bottom:136px;transform:translateX(-50%);max-width:880px;min-height:84px;display:block;z-index:4}
.bub{background:var(--ui);border:2px solid #fff;padding:10px 14px}
#bubbleText{white-space:pre-line;line-height:1.45}

/* Bottom UI */
#uiBar{position:absolute;left:50%;bottom:8px;transform:translateX(-50%);width:920px;height:116px;background:var(--ui);border:2px solid var(--line);display:flex;align-items:center;justify-content:space-between;padding:0 18px;z-index:3}
.uiMenu{display:flex;gap:36px}
.uiBtn{display:flex;align-items:center;gap:10px;cursor:pointer}
.uiKey{width:20px;height:20px;border:2px solid #fff;display:flex;align-items:center;justify-content:center;font-weight:700}
.uiLabel{font-size:20px;letter-spacing:1px}
#uiCenter{font-size:14px}
</style>
</head>
<body>
<div id="stage"><div id="wrap">
  <!-- HUD -->
  <div id="bossHUD">
    <div id="bossName">Golden Duelist</div>
    <div id="bossHP"><div id="bossHPFill"></div></div>
    <div id="bossHPVal">000/000</div>
  </div>
  <div id="playerHUD">
    <div id="playerNameLabel">Traveler</div>
    <div id="pHP"><div id="pHPFill"></div></div>
    <div id="pHPVal">20/20</div>
  </div>

  <!-- Canvas + Arena -->
  <canvas id="cv" width="960" height="720" aria-label="Battlefield"></canvas>
  <div id="box" aria-hidden="true"></div>

  <!-- Dialogue -->
  <div id="bubble"><div class="bub"><div id="bubbleText"></div></div></div>

  <!-- Bottom UI -->
  <div id="uiBar">
    <div class="uiMenu" id="uiMenu">
      <div class="uiBtn" data-act="FIGHT"><div class="uiKey">Z</div><div class="uiLabel">FIGHT</div></div>
      <div class="uiBtn" data-act="ACT"><div class="uiKey">A</div><div class="uiLabel">ACT</div></div>
      <div class="uiBtn" data-act="ITEM"><div class="uiKey">I</div><div class="uiLabel">ITEM</div></div>
      <div class="uiBtn" data-act="MERCY"><div class="uiKey">M</div><div class="uiLabel">MERCY</div></div>
    </div>
    <div id="uiCenter">Your turn.</div>
  </div>
</div></div>

<script>
"use strict";

/* Responsive */
const stage=document.getElementById('stage');
function resizeStage(){const s=Math.min(innerWidth/960,innerHeight/720);stage.style.transform=`translate(-50%, -50%) scale(${s})`;}
addEventListener('resize',resizeStage); resizeStage();

/* Elements */
const cv=document.getElementById('cv'), ctx=cv.getContext('2d');
const boxEl=document.getElementById('box');
const bossNameEl=document.getElementById('bossName');
const bossHPFill=document.getElementById('bossHPFill'), bossHPVal=document.getElementById('bossHPVal');
const pHPFill=document.getElementById('pHPFill'), pHPVal=document.getElementById('pHPVal');
const bubble=document.getElementById('bubble'), bubbleText=document.getElementById('bubbleText');
const uiCenter=document.getElementById('uiCenter');

/* State */
const ARENA={x:240,y:420,w:480,h:180};
const HEART={x:ARENA.x+ARENA.w/2,y:ARENA.y+ARENA.h/2,r:4,sp:300,i:0,hp:20,hpMax:20,_px:0,_py:0,_pdt:1/60};
let time=0, paused=false, turn='player', showArena=false;
let attack=null, phaseT=0;
let bullets=[], scene={flinch:0,shake:0}; let damagePopup=null; let slashes=[];

const BOSS={name:'Golden Duelist', hpMax:300, hp:300, damage:7};
function bossBar(){bossHPFill.style.width=(360*Math.max(0,BOSS.hp/BOSS.hpMax))+'px'; bossHPVal.textContent=`${BOSS.hp}/${BOSS.hpMax}`; bossNameEl.textContent=BOSS.name;}
bossBar();
function updatePlayerHP(){pHPFill.style.width=(220*Math.max(0,HEART.hp/HEART.hpMax))+'px';pHPVal.textContent=`${HEART.hp}/${HEART.hpMax}`;}
updatePlayerHP();

/* Dialogue helpers */
let lastDialog='';
function showBubble(t){lastDialog=t; bubble.style.display='block'; bubbleText.textContent=t;}
function hideBubble(){bubble.style.display='none';}
function restoreBubble(){ if(lastDialog){ bubbleText.textContent=lastDialog; bubble.style.display='block'; } }

/* Heart */
function drawHeart(ctx,x,y,color='#ffd166',scale=0.8){
  ctx.save();ctx.translate(x,y);ctx.scale(scale,scale);
  const m=[[0,1,1,0,0,1,1,0],[1,1,1,1,1,1,1,1],[1,1,1,1,1,1,1,1],[0,1,1,1,1,1,1,0],[0,0,1,1,1,1,0,0],[0,0,0,1,1,0,0,0]];
  ctx.fillStyle=color;const s=3;
  for(let r=0;r<m.length;r++) for(let c=0;c<m[r].length;c++) if(m[r][c]) ctx.fillRect((c-4)*s,(r-3)*s,s,s);
  ctx.restore();
}

/* Simple boss sprite */
function drawDuelist(ctx,t,flinch=0){
  const x=480,y=258+Math.sin(t*6)*3;
  ctx.save();
  if(flinch>0){ctx.globalAlpha=0.6;ctx.fillStyle='#fff1b6';ctx.beginPath();ctx.arc(x,y,46,0,Math.PI*2);ctx.fill();ctx.globalAlpha=1;}
  ctx.shadowColor='#ffd166';ctx.shadowBlur=10;
  ctx.fillStyle='#b8902f';
  ctx.beginPath();ctx.moveTo(x-22,y+6);ctx.lineTo(x-50,y+28+Math.sin(t*2)*2);ctx.lineTo(x-12,y+40);ctx.closePath();ctx.fill();
  ctx.beginPath();ctx.moveTo(x+22,y+6);ctx.lineTo(x+50,y+28+Math.cos(t*2)*2);ctx.lineTo(x+12,y+40);ctx.closePath();ctx.fill();
  ctx.fillStyle='#e5bf4d';ctx.fillRect(x-5,y-8,10,40);ctx.fillRect(x-4,y+30,8,12);
  ctx.beginPath();ctx.ellipse(x,y+50,12,10,0,0,Math.PI*2);ctx.fill();
  ctx.beginPath();ctx.moveTo(x,y-34);ctx.lineTo(x-12,y-12);ctx.lineTo(x+12,y-12);ctx.closePath();ctx.fill();
  ctx.restore();
}

/* Attack (reliable) */
function makeAttack(duration=4){
  let t=0, g=0;
  return {
    enter(){t=0; g=0;},
    update(dt){
      t+=dt; g+=dt;
      if(g>0.15){ g=0;
        const y=ARENA.y+Math.random()*ARENA.h;
        const left=Math.random()<0.5;
        const x=left?ARENA.x-20:ARENA.x+ARENA.w+20;
        const dir=left?1:-1;
        bullets.push({x,y,vx:dir*360,vy:0,r:4,col:'#ffd166',t:0});
      }
    },
    done(){return t>=duration;}
  };
}

/* Flow */
function startAttack(){
  bullets.length=0; phaseT=0; showArena=true; boxEl.style.display='block';
  attack=makeAttack(4); attack.enter();
}
function finishAttack(){
  turn='player'; uiCenter.textContent='Your turn';
  showArena=false; boxEl.style.display='none';
  restoreBubble();
}
function bossHit(dmg){ BOSS.hp=Math.max(0,BOSS.hp-dmg); bossBar(); damagePopup={x:480,y:200,t:0,text:String(dmg)}; }

/* Init */
function initBattle(){
  HEART.hp=20; updatePlayerHP();
  HEART.x=ARENA.x+ARENA.w/2; HEART.y=ARENA.y+ARENA.h/2; HEART.i=0;
  turn='player'; uiCenter.textContent='Your turn'; showArena=false; boxEl.style.display='none';
  showBubble("The hall brightens as blades cross the air.\nA bow. A trial.");
}
initBattle();

/* Input */
const down=new Set();
addEventListener('keydown',e=>{
  down.add(e.key);
  if((e.key==='z'||e.key==='Z'||e.key==='Enter') && turn==='player'){
    showBubble('You strike.');
    bossHit(20);
    setTimeout(()=>{turn='enemy'; uiCenter.textContent='Enemy turn'; hideBubble(); startAttack();},220);
  }
});
addEventListener('keyup',e=>down.delete(e.key));
function key(k){return down.has(k)||down.has(k.toUpperCase());}

/* Loop */
let last=performance.now();
function loop(now){
  const dt=Math.min(0.033,(now-last)/1000); last=now;
  if(!paused){ update(dt); render(dt); }
  requestAnimationFrame(loop);
}
requestAnimationFrame(loop);

/* Update */
function update(dt){
  time+=dt;

  if(turn==='enemy'){
    phaseT+=dt;

    // movement
    let dx=0,dy=0;
    if(key('ArrowLeft')||key('a')) dx-=1;
    if(key('ArrowRight')||key('d')) dx+=1;
    if(key('ArrowUp')||key('w')) dy-=1;
    if(key('ArrowDown')||key('s')) dy+=1;
    const L=Math.hypot(dx,dy)||1;
    HEART.x=Math.max(ARENA.x+HEART.r, Math.min(ARENA.x+ARENA.w-HEART.r, HEART.x+dx/L*HEART.sp*dt));
    HEART.y=Math.max(ARENA.y+HEART.r, Math.min(ARENA.y+ARENA.h-HEART.r, HEART.y+dy/L*HEART.sp*dt));
    HEART._pdt=dt; HEART._px=HEART.x; HEART._py=HEART.y;
    HEART.i=Math.max(0,HEART.i-dt);

    // attack update
    attack && attack.update(dt);

    // bullets
    for(const b of bullets){ b.t+=dt; b.x+=b.vx*dt; b.y+=b.vy*dt; }
    bullets=bullets.filter(b=>b.x>ARENA.x-120 && b.x<ARENA.x+ARENA.w+120 && b.y>ARENA.y-120 && b.y<ARENA.y+ARENA.h+120);

    // collisions
    for(const b of bullets){
      const dx2=b.x-HEART.x, dy2=b.y-HEART.y, rr=(b.r||4)+HEART.r;
      if(dx2*dx2+dy2*dy2<=rr*rr && HEART.i<=0){ HEART.hp=Math.max(0,HEART.hp-7); updatePlayerHP(); HEART.i=0.85; }
    }

    // end phase
    if(attack && attack.done()){ finishAttack(); }

    // defeat
    if(HEART.hp<=0){
      turn='defeat'; showBubble('You fall. The hall dims.');
      setTimeout(()=>initBattle(),1000);
    }
  }

  // popup fade
  if(damagePopup){ damagePopup.t+=dt; if(damagePopup.t>0.9) damagePopup=null; }
}

/* Render */
function render(dt){
  // background
  ctx.fillStyle='#0b0907'; ctx.fillRect(0,0,960,720);
  ctx.fillStyle='#1a130f';
  for(let i=0;i<96;i++){const x=(i*97)%960, y=(i*151)%720; ctx.fillRect(x,y,2,2);}

  // boss sprite
  drawDuelist(ctx,time,scene.flinch);

  // arena on enemy turn
  if(turn==='enemy' && showArena){
    ctx.strokeStyle='#ffffff'; ctx.lineWidth=3; ctx.strokeRect(ARENA.x,ARENA.y,ARENA.w,ARENA.h);
    for(const b of bullets){ ctx.fillStyle=b.col||'#fff'; ctx.beginPath(); ctx.arc(b.x,b.y,b.r||4,0,Math.PI*2); ctx.fill(); }
    ctx.save(); if(HEART.i>0) ctx.globalAlpha=0.6+0.3*Math.sin(time*20);
    drawHeart(ctx,HEART.x-6,HEART.y-6,'#ffd166',0.8);
    ctx.restore();
  }

  // damage popup
  if(damagePopup){
    const a=Math.max(0,1-damagePopup.t/0.9);
    ctx.save(); ctx.globalAlpha=a; ctx.fillStyle='#fff1b6'; ctx.font='16px monospace';
    ctx.fillText(damagePopup.text, damagePopup.x, damagePopup.y - damagePopup.t*60);
    ctx.restore();
  }
}
</script>
</body>
</html>

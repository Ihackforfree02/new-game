<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"/>
<title>Undertale Gold — Routes + Admin + Unique Bosses</title>
<style>
:root{
  --fg:#ffd166; --hp:#ff6b6b; --emerald:#7affb7;
  --ui:#0b0b0b; --line:#262626;
  --bub-bg:#0b0b0b; --bub-border:#ffd166; --bub-fg:#ffd166;
}
html,body{height:100%;margin:0;background:#000;color:var(--fg);font-family:ui-monospace,monospace;image-rendering:pixelated;overflow:hidden}
#stage{position:fixed;left:50%;top:50%;transform-origin:top left}
#wrap{position:relative;width:960px;height:720px}
canvas{display:block;width:960px;height:720px;border:4px solid #0a0a0f;background:#070606}

/* HUD */
#bossHUD{position:absolute;left:20px;top:18px;display:flex;flex-direction:column;gap:6px;z-index:3}
#bossName{font-size:14px;letter-spacing:0.5px}
#bossHP{height:10px;width:440px;background:#141414;border:1px solid #383838;position:relative}
#bossHPFill{position:absolute;left:0;top:0;bottom:0;background:var(--hp);width:100%}
#bossHPVal{font-size:12px;margin-top:2px}
#playerHUD{position:absolute;right:20px;top:18px;display:flex;flex-direction:column;gap:6px;align-items:flex-end;z-index:3}
#playerNameLabel{font-size:14px;color:#9be7c0;letter-spacing:0.5px}
#pHP{height:10px;width:260px;background:#141414;border:1px solid #383838;position:relative}
#pHPFill{position:absolute;left:0;top:0;bottom:0;background:var(--emerald);width:100%}
#pHPVal{font-size:12px;margin-top:2px}

/* Arena */
#box{position:absolute;left:240px;top:420px;width:480px;height:180px;border:3px solid #fff;display:none;z-index:1}

/* Dialogue (gold on black) */
#bubble{position:absolute;left:50%;bottom:148px;transform:translateX(-50%);max-width:905px;min-height:124px;display:block;z-index:4}
.bub{background:var(--bub-bg);border:2px solid var(--bub-border);padding:16px 20px;color:var(--bub-fg)}
#bubbleText{white-space:pre-line;line-height:1.6;font-size:16px}
#submenuHint{font-size:12px;opacity:.85;margin-top:6px}

/* Action bar */
#uiBar{position:absolute;left:50%;bottom:8px;transform:translateX(-50%);width:920px;height:116px;background:var(--ui);border:2px solid var(--line);display:flex;align-items:center;justify-content:space-between;padding:0 18px;z-index:3;transition:opacity .18s ease, transform .18s ease}
#uiBar.hidden{opacity:0;pointer-events:none;transform:translate(-50%,6px)}
.uiMenu{display:flex;gap:36px}
.uiBtn{display:flex;align-items:center;gap:10px;cursor:pointer}
.uiKey{width:20px;height:20px;border:2px solid #fff;display:flex;align-items:center;justify-content:center;font-weight:700}
.uiLabel{font-size:20px;letter-spacing:1px}
#uiCenter{font-size:14px}

/* Tips + toast */
#tips{position:absolute;left:50%;top:84px;transform:translateX(-50%);font-size:12px;color:#c8c8c8;opacity:.85}
#toast{position:absolute;left:50%;top:120px;transform:translateX(-50%);background:#111;border:1px solid #fff;color:#ffd166;padding:6px 10px;font-size:12px;opacity:0;transition:opacity .25s}
#toast.show{opacity:1}

/* Admin panel */
#admin{position:absolute;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.65);z-index:8}
#adminPanel{background:#0e0e0e;border:2px solid #fff;padding:14px 16px;width:680px;color:#ffd166;max-width:95%}
.adRow{display:flex;align-items:center;justify-content:space-between;margin:8px 0;gap:10px;flex-wrap:wrap}
.adBtn{padding:6px 10px;border:1px solid #fff;background:transparent;color:#ffd166;cursor:pointer}
.adInput,.adSelect{background:#111;color:#ffd166;border:1px solid #333;padding:6px 8px}
.adInput{width:220px}
.adSelect{width:300px}
.adHelp{color:#bbb;font-size:12px}
</style>
</head>
<body>
<div id="stage"><div id="wrap">
  <div id="bossHUD">
    <div id="bossName">Doge Paladin</div>
    <div id="bossHP"><div id="bossHPFill"></div></div>
    <div id="bossHPVal">000/000</div>
  </div>
  <div id="playerHUD">
    <div id="playerNameLabel">Traveler</div>
    <div id="pHP"><div id="pHPFill"></div></div>
    <div id="pHPVal">50/50</div>
  </div>

  <canvas id="cv" width="960" height="720"></canvas>
  <div id="box"></div>

  <div id="bubble"><div class="bub">
    <div id="bubbleText"></div>
    <div id="submenuHint" style="display:none">Choose: 1-4 • Back: X/Backspace • Confirm: Z/Enter</div>
  </div></div>

  <div id="uiBar">
    <div class="uiMenu" id="uiMenu">
      <div class="uiBtn" data-act="FIGHT"><div class="uiKey">Z</div><div class="uiLabel">FIGHT</div></div>
      <div class="uiBtn" data-act="ACT"><div class="uiKey">A</div><div class="uiLabel">ACT</div></div>
      <div class="uiBtn" data-act="ITEM"><div class="uiKey">I</div><div class="uiLabel">ITEM</div></div>
      <div class="uiBtn" data-act="MERCY"><div class="uiKey">M</div><div class="uiLabel">MERCY</div></div>
    </div>
    <div id="uiCenter">Your turn.</div>
  </div>

  <div id="tips">Move: Arrow/WASD — Confirm: Z/Enter — Back: X/Backspace — Type “67” three times to open Admin</div>
  <div id="toast">Admin opened</div>

  <div id="admin">
    <div id="adminPanel">
      <div style="font-weight:700;margin-bottom:8px">Admin panel</div>
      <div class="adRow">
        <label>Username</label>
        <input id="adUser" class="adInput" placeholder="Your name"/>
        <button id="adUserSave" class="adBtn">Save name</button>
      </div>
      <div class="adRow">
        <label>Boss (admin-only ones marked)</label>
        <select id="adBoss" class="adSelect"></select>
      </div>
      <div class="adRow">
        <label>Player max HP</label>
        <input id="adHP" class="adInput" type="number" min="1" max="99" value="50"/>
        <button id="adHeal" class="adBtn">Heal to full</button>
      </div>
      <div class="adRow">
        <label>Progress</label>
        <button id="adSkip" class="adBtn">Skip to next</button>
        <button id="adReset" class="adBtn">Reset progress</button>
      </div>
      <div class="adRow" style="justify-content:flex-end">
        <button id="adClose" class="adBtn">Close</button>
      </div>
      <small class="adHelp">Open with “67” typed three times. Admin-only bosses won’t appear in normal progression.</small>
    </div>
  </div>
</div></div>

<script>
"use strict";

/* Responsive scaling */
const stage=document.getElementById('stage');
function resizeStage(){const s=Math.min(innerWidth/960,innerHeight/720);stage.style.transform=`translate(-50%, -50%) scale(${Math.max(0.2,s)})`;}
addEventListener('resize',resizeStage,{passive:true}); resizeStage();

/* Elements */
const cv=document.getElementById('cv'), ctx=cv.getContext('2d',{alpha:false});
const bossNameEl=document.getElementById('bossName'), bossHPFill=document.getElementById('bossHPFill'), bossHPVal=document.getElementById('bossHPVal');
const pHPFill=document.getElementById('pHPFill'), pHPVal=document.getElementById('pHPVal'), nameLabel=document.getElementById('playerNameLabel');
const bubble=document.getElementById('bubble'), bubbleText=document.getElementById('bubbleText'), submenuHint=document.getElementById('submenuHint');
const uiMenu=document.getElementById('uiMenu'), uiBar=document.getElementById('uiBar'), uiCenter=document.getElementById('uiCenter');
const boxEl=document.getElementById('box'); const toastEl=document.getElementById('toast');
const admin=document.getElementById('admin'); const adUser=document.getElementById('adUser'); const adUserSave=document.getElementById('adUserSave');
const adBoss=document.getElementById('adBoss'); const adHP=document.getElementById('adHP'); const adHeal=document.getElementById('adHeal');
const adSkip=document.getElementById('adSkip'); const adReset=document.getElementById('adReset'); const adClose=document.getElementById('adClose');

/* Save */
const SAVE_KEY='utg_routes_admin_final_v1';
function loadSave(){try{return JSON.parse(localStorage.getItem(SAVE_KEY))||{};}catch{return {};}}
function writeSave(d){try{localStorage.setItem(SAVE_KEY,JSON.stringify(d));}catch{}}
let SAVE=loadSave();

/* Arena/player */
const ARENA={x:240,y:420,w:480,h:180};
const HEART={x:ARENA.x+ARENA.w/2,y:ARENA.y+ARENA.h/2,r:4,sp:300,i:0,hp:Math.max(1,SAVE.hp||50),hpMax:Math.max(1,SAVE.hp||50),_px:0,_py:0,_pdt:1/60};
let username=(SAVE.username||'Traveler').slice(0,16); nameLabel.textContent=username;

/* State */
const TURN={PLAYER:'player',ENEMY:'enemy',VICTORY:'victory',DEFEAT:'defeat',TRANS:'transition'};
let time=0, turn=TURN.PLAYER, showArena=false, paused=false;
let attack=null, attackSeq=null, attackIx=0, bullets=[], damagePopup=null;
let mode='main'; // 'main' | 'act' | 'item'
let bossIndex=(typeof SAVE.bossIndex==='number')?SAVE.bossIndex:0;
let BOSS=null;

/* Routes */
const routeState={fight:SAVE.fight||0, act:SAVE.act||0, mercy:SAVE.mercy||0};
function routeLean(){ if(routeState.fight>=routeState.act+routeState.mercy+3) return 'genocide'; if(routeState.mercy+routeState.act>=routeState.fight+3) return 'pacifist'; return 'neutral'; }
function saveProgress(){ writeSave({bossIndex, hp:HEART.hpMax, username, fight:routeState.fight, act:routeState.act, mercy:routeState.mercy, inventory}); }

/* Inventory */
let inventory=Array.isArray(SAVE.inventory)?SAVE.inventory:[{id:'dew',name:'Dew Petal',desc:'+12 HP',type:'heal',amount:12,count:2}];
let tempBuff={atk:0};
function rewardForRoute(r){ if(r==='pacifist') return {id:'tea',name:'Calming Tea',desc:'+16 HP',type:'heal',amount:16,count:1}; if(r==='genocide') return {id:'rage',name:'Rage Shard',desc:'+4 ATK (this run)',type:'buff',atk:4,count:1}; return {id:'tonic',name:'Tonic',desc:'+14 HP',type:'heal',amount:14,count:1}; }
function giveItem(it){const f=inventory.find(x=>x.id===it.id); if(f) f.count+=it.count; else inventory.push(JSON.parse(JSON.stringify(it))); saveProgress(); }
function itemsList(){ if(inventory.length===0) return "No items."; return inventory.map((it,i)=>` ${i+1}. ${it.name} (${it.count}) — ${it.desc}`).join('\n'); }
function useItem(i){ const it=inventory[i]; if(!it||it.count<=0) return "Empty."; if(it.type==='heal'){ HEART.hp=Math.min(HEART.hpMax, HEART.hp+(it.amount||10)); updateHP(); it.count--; if(it.count<=0) inventory.splice(i,1); saveProgress(); return `You used ${it.name}. +${it.amount} HP`; } if(it.type==='buff'){ tempBuff.atk=(tempBuff.atk||0)+(it.atk||2); it.count--; if(it.count<=0) inventory.splice(i,1); saveProgress(); return `You used ${it.name}. ATK +${it.atk}`; } return "Nothing happened."; }

/* UI helpers */
function say(t,h=false){bubble.style.display='block'; bubbleText.textContent=t; submenuHint.style.display=h?'block':'none';}
function hideSay(){bubble.style.display='none'; submenuHint.style.display='none';}
function bossBar(){bossNameEl.textContent=BOSS.name; bossHPFill.style.width=(440*Math.max(0,BOSS.hp/BOSS.hpMax))+'px'; bossHPVal.textContent=`${BOSS.hp}/${BOSS.hpMax}`;}
function updateHP(){pHPFill.style.width=(260*Math.max(0,HEART.hp/HEART.hpMax))+'px'; pHPVal.textContent=`${HEART.hp}/${HEART.hpMax}`;}
function centerHeart(){HEART.x=ARENA.x+ARENA.w/2; HEART.y=ARENA.y+ARENA.h/2;}
function toast(msg){toastEl.textContent=msg; toastEl.classList.add('show'); setTimeout(()=>toastEl.classList.remove('show'),1000);}

/* Input */
const down=new Set();
addEventListener('keydown',e=>{
  const isMove=['ArrowLeft','ArrowRight','ArrowUp','ArrowDown','a','A','d','D','w','W','s','S'].includes(e.key);
  if(!(turn===TURN.ENEMY && mode==='main') && isMove) return;
  down.add(e.key);

  if((e.key==='x'||e.key==='X'||e.key==='Backspace') && (mode==='act'||mode==='item')){ mode='main'; say('Your turn.'); }

  if(mode==='act'||mode==='item'){
    if('1234'.includes(e.key)) handleSubmenuSelect(parseInt(e.key,10)-1);
    if(e.key==='Enter'||e.key==='z'||e.key==='Z') handleSubmenuSelect(0);
  }

  handleSecret67(e.key);
});
addEventListener('keyup',e=>down.delete(e.key));
function key(k){return down.has(k)||down.has(k.toUpperCase());}

/* Secret “67×3” -> admin */
let secretBuf='', pairCount=0, secretCooldown=0;
function handleSecret67(k){
  if(secretCooldown>0) return;
  if(k==='6'||k==='7'){
    secretBuf=(secretBuf+k).slice(-2);
    if(secretBuf==='67'){
      pairCount++; secretBuf=''; secretCooldown=10;
      if(pairCount>=3){ pairCount=0; openAdmin(); toast('Admin opened'); }
    }
  }else{ secretBuf=''; pairCount=0; }
}

/* Drawing helpers */
function bob(v=3){return Math.sin(time*2.6)*v;}
function wag(v=4){return Math.sin(time*6)*v;}
function blink(freq=4){return Math.sin(time*freq)>0.8;}
function glow(x,y,r,fill,a=0.22){ctx.save();ctx.globalAlpha=a;ctx.fillStyle=fill;ctx.beginPath();ctx.arc(x,y,r,0,Math.PI*2);ctx.fill();ctx.restore();}

/* Boss sprites */
function drawDoge(ctx,t){const x=480,y=250+bob(2),b=blink(4);glow(x,y,60,'#fff3b8',0.25);ctx.save();ctx.fillStyle='#e8c764';ctx.fillRect(x-20,y-6,40,26);ctx.strokeStyle='#fff6cf';ctx.lineWidth=2;ctx.strokeRect(x-20,y-6,40,26);ctx.fillStyle='#caa95a';ctx.beginPath();ctx.moveTo(x-22,y-6);ctx.lineTo(x-34,y-18+wag(2));ctx.lineTo(x-10,y-8);ctx.closePath();ctx.fill();ctx.beginPath();ctx.moveTo(x+22,y-6);ctx.lineTo(x+34,y-18-wag(2));ctx.lineTo(x+10,y-8);ctx.closePath();ctx.fill();ctx.fillStyle='#f6dfa2';ctx.beginPath();ctx.arc(x,y+6,16,0,Math.PI*2);ctx.fill();ctx.fillStyle='#2b1a0f';if(!b){ctx.fillRect(x-7,y,4,5);ctx.fillRect(x+3,y,4,5);}else{ctx.fillRect(x-7,y+2,4,1);ctx.fillRect(x+3,y+2,4,1);}ctx.restore();}
function drawCheems(ctx,t){const x=480,y=250+bob(2),b=blink(3.5);glow(x,y,62,'#ffd6ea',0.24);ctx.save();ctx.fillStyle='#f0a3c2';ctx.beginPath();ctx.moveTo(x-42,y+34);ctx.lineTo(x+42,y+34);ctx.lineTo(x+34,y+56);ctx.lineTo(x-34,y+56);ctx.closePath();ctx.fill();ctx.fillStyle='#ffe0f0';ctx.beginPath();ctx.moveTo(x,y-28);ctx.bezierCurveTo(x-38,y-20,x-36,y,x,y+6);ctx.bezierCurveTo(x+36,y,x+38,y-20,x,y-28);ctx.closePath();ctx.fill();ctx.fillStyle='#fff0f8';ctx.fillRect(x-8,y-14,16,2);ctx.fillStyle='#2b0f1a';if(!b){ctx.fillRect(x-10,y-12,5,6);ctx.fillRect(x+5,y-12,5,6);}else{ctx.fillRect(x-10,y-10,5,2);ctx.fillRect(x+5,y-10,5,2);}ctx.restore();}
function drawBell(ctx,t){const x=480,y=230+bob(2.6);glow(x,y,66,'#fff3b8',0.28);ctx.save();ctx.fillStyle='#ffe18a';ctx.beginPath();ctx.ellipse(x,y,14,22,0,0,Math.PI*2);ctx.fill();ctx.strokeStyle='#ffd166';ctx.lineWidth=6;ctx.beginPath();ctx.arc(x,y+18,34,Math.PI,0);ctx.stroke();ctx.restore();}
function drawBee(ctx,t){const x=480,y=245+bob(2.4),b=blink(5);glow(x,y,58,'#ffe87a',0.25);ctx.save();ctx.fillStyle='#ffeb80';ctx.beginPath();ctx.ellipse(x,y,22,16,0,0,Math.PI*2);ctx.fill();ctx.fillStyle='#202020';ctx.fillRect(x-22,y-4,44,4);ctx.fillRect(x-22,y+4,44,4);ctx.fillStyle='rgba(200,240,255,0.6)';ctx.beginPath();ctx.ellipse(x-12,y-18,10,6,0,0,Math.PI*2);ctx.fill();ctx.beginPath();ctx.ellipse(x+12,y-18,10,6,0,0,Math.PI*2);ctx.fill();ctx.fillStyle='#111';if(!b){ctx.fillRect(x-6,y-2,3,3);ctx.fillRect(x+3,y-2,3,3);}else{ctx.fillRect(x-6,0,3,1);ctx.fillRect(x+3,0,3,1);}ctx.restore();}
function drawShrek(ctx,t){const x=480,y=252+bob(2);glow(x,y,58,'#b5ffb0',0.22);ctx.save();ctx.fillStyle='#6aa84f';ctx.beginPath();ctx.arc(x,y,22,0,Math.PI*2);ctx.fill();ctx.fillStyle='#6aa84f';ctx.fillRect(x-26,y-6,8,8);ctx.fillRect(x+18,y-6,8,8);ctx.fillStyle='#222';ctx.fillRect(x-8,y-2,4,4);ctx.fillRect(x+4,y-2,4,4);ctx.restore();}
function drawTroll(ctx,t){const x=480,y=248+bob(2.4);glow(x,y,58,'#fff',0.18);ctx.save();ctx.fillStyle='#f2f2f2';ctx.fillRect(x-20,y-10,40,26);ctx.strokeStyle='#000';ctx.lineWidth=2;ctx.beginPath();ctx.arc(x,y+4,16,0,Math.PI);ctx.stroke();ctx.fillStyle='#000';ctx.fillRect(x-10,y-6,4,4);ctx.fillRect(x+6,y-6,4,4);ctx.restore();}
function drawNyan(ctx,t){const x=480,y=240+bob(3);glow(x,y,58,'#f39ac1',0.18);ctx.save();for(let i=0;i<6;i++){ctx.globalAlpha=0.2;ctx.fillStyle=['#f00','#f80','#ff0','#0f0','#0af','#80f'][i];ctx.fillRect(x-140-i*16, y-8+i*3, 120, 4);}ctx.globalAlpha=1;ctx.fillStyle='#fbd3a7';ctx.fillRect(x-22,y-10,44,28);ctx.fillStyle='#f39ac1';ctx.fillRect(x-20,y-8,40,24);ctx.fillStyle='#b0b9c6';ctx.fillRect(x+18,y-6,18,16);ctx.restore();}
function drawPepe(ctx,t){const x=480,y=248+bob(2);glow(x,y,54,'#bff7b5',0.2);ctx.save();ctx.fillStyle='#6bbf59';ctx.beginPath();ctx.arc(x,y,20,0,Math.PI*2);ctx.fill();ctx.fillStyle='#2a4d24';ctx.fillRect(x-10,y-4,5,5);ctx.fillRect(x+5,y-4,5,5);ctx.restore();}
function drawSkibidi(ctx,t){const x=480, y=245+bob(3);glow(x,y,62,'#ffb9b9',0.26);ctx.save();ctx.fillStyle='#241313';ctx.beginPath();ctx.ellipse(x,y+6,20,30,0,0,Math.PI*2);ctx.fill();ctx.fillStyle='#111';ctx.fillRect(x-18,y-36,36,22);ctx.fillStyle='#ff2d2d';ctx.fillRect(x-6,y-30,12,8);ctx.strokeStyle='#555';ctx.lineWidth=3;for(const s of [-1,1]){ctx.beginPath();ctx.moveTo(x+s*10,y+2);ctx.lineTo(x+s*(28+Math.sin(t*12+s)*2),y+22+Math.sin(t*16+s)*6);ctx.stroke();}ctx.strokeStyle='#ffd166';ctx.lineWidth=2;ctx.beginPath();ctx.arc(x,y-6,16,Math.PI*0.1,Math.PI-0.1,false);ctx.stroke();ctx.fillStyle='#ffd166';ctx.font='bold 14px monospace';ctx.fillText('67', x-8, y+2);ctx.restore();}
function drawOmega(ctx,t){const x=480,y=236+bob(2.4);glow(x,y,70,'#fff3b8',0.3);ctx.save();ctx.fillStyle='#222';ctx.beginPath();ctx.arc(x,y,24,0,Math.PI*2);ctx.fill();ctx.strokeStyle='#ffd166';ctx.lineWidth=3;ctx.beginPath();ctx.arc(x,y,30,0,Math.PI*2);ctx.stroke();ctx.restore();}

/* Heart */
function drawHeart(ctx,x,y,color='#ffd166',scale=0.8){ctx.save();ctx.translate(x,y);ctx.scale(scale,scale);const m=[[0,1,1,0,0,1,1,0],[1,1,1,1,1,1,1,1],[1,1,1,1,1,1,1,1],[0,1,1,1,1,1,1,0],[0,0,1,1,1,1,0,0],[0,0,0,1,1,0,0,0]];ctx.fillStyle=color;const s=3;for(let r=0;r<m.length;r++)for(let c=0;c<m[r].length;c++) if(m[r][c]) ctx.fillRect((c-4)*s,(r-3)*s,s,s);ctx.restore();}

/* Spawning */
function spawn(b){b.t=0; bullets.push(b); return b;}
function spawnAimed(fx,fy,speed,dmg,col='#fff',r=3,lead=0.08){
  const vx0=(HEART.x-(HEART._px||HEART.x))/(HEART._pdt||1/60), vy0=(HEART.y-(HEART._py||HEART.y))/(HEART._pdt||1/60);
  const dx=HEART.x-fx, dy=HEART.y-fy, L=Math.hypot(dx,dy)||1;
  const vx=(dx/L)*speed + vx0*lead, vy=(dy/L)*speed + vy0*lead;
  return spawn({x:fx,y:fy,vx,vy,r:Math.max(2,r),col,dmg:Math.max(1,Math.floor(dmg))});
}
function rand(a,b){return Math.random()*(b-a)+a;}

/* Pattern helpers (fast but fair) */
function patRing(dur=3.6,dmg=4,col='#fff3b8',spd=230,n=12){let t=0,g=0,rate=.48;const c={x:ARENA.x+ARENA.w/2,y:ARENA.y+ARENA.h/2};return{enter(){},update(dt){t+=dt;g+=dt;if(g>=rate){g=0;for(let k=0;k<n;k++){const a=(k/n)*Math.PI*2;spawn({x:c.x,y:c.y,vx:Math.cos(a)*spd,vy:Math.sin(a)*spd,r:3,col,dmg});}}},done(){return t>=dur;}};}
function patHoming(dur=3.2,dmg=4,col='#ffd0e8',spd=230){let t=0,g=0,rate=0.5;return{enter(){},update(dt){t+=dt;g+=dt;if(g>=rate){g=0;const x=ARENA.x+rand(0,ARENA.w),y=ARENA.y-10;spawnAimed(x,y,spd,dmg,col,4,0.08);} },done(){return t>=dur;}};}
function patCone(dur=3.2,dmg=3,col='#fff3b8',spd=210,count=5,spread=Math.PI/2.8){let t=0,g=0,rate=.18;const cx=ARENA.x+ARENA.w/2,y=ARENA.y+12;return{enter(){},update(dt){t+=dt;g+=dt;if(g>=rate){g=0;for(let k=0;k<count;k++){const a=(-spread)+k*(2*spread/(Math.max(1,count-1)));spawn({x:cx,y,vx:Math.cos(a)*spd,vy:Math.sin(a)*spd,r:3,col,dmg});}}},done(){return t>=dur;}};}
function patFalls(dur=3.4,dmg=3,col='#d1f7ff',spd=220){let t=0,g=0,rate=.22;return{enter(){},update(dt){t+=dt;g+=dt;if(g>=rate){g=0;const x=ARENA.x+rand(24,ARENA.w-24);spawn({x,y:ARENA.y-18,vx:0,vy:spd,r:3,col,dmg});}},done(){return t>=dur;}};}
function patSpiralAim(dur=3.6,dmg=4,col='#ffd166',spd=220,arms=3){let t=0,a0=Math.random()*Math.PI*2,rad=Math.max(ARENA.w,ARENA.h)*0.5;const rateR=(rad/(dur*1.4)), rateA=6.2;return{enter(){},update(dt){t+=dt;for(let i=0;i<arms;i++){const a=a0+t*rateA+i*(Math.PI*2/arms);const x=ARENA.x+ARENA.w/2+Math.cos(a)*rad;const y=ARENA.y+ARENA.h/2+Math.sin(a)*rad;spawnAimed(x,y,spd,dmg,col,3,0.08);}rad=Math.max(30,rad-rateR*dt);},done(){return t>=dur;}};}

/* Themed patterns */
function patDogeArcs(dur=3.4,dmg=4,spd=220){let t=0,g=0,rate=.42;const c={x:ARENA.x+ARENA.w/2,y:ARENA.y+ARENA.h/2};return{enter(){},update(dt){t+=dt;g+=dt;if(g>=rate){g=0;const s=rand(-0.2,0.2);for(const a of [-0.9+s,-0.5+s,0.5+s,0.9+s]) spawn({x:c.x,y:c.y,vx:Math.cos(a)*spd,vy:Math.sin(a)*spd,r:3,col:'#fff3b8',dmg});}},done(){return t>=dur;}};}
function patBeeZigZag(dur=3.6,dmg=3,col='#ffe87a',spd=240){let t=0,g=0,rate=.16,side=90;return{enter(){},update(dt){t+=dt;g+=dt;if(g>=rate){g=0;const top=Math.random()<0.5, x=ARENA.x+rand(20,ARENA.w-20);const b=spawn({x,y:top?ARENA.y-16:ARENA.y+ARENA.h+16,vx:0,vy:top?spd:-spd,r:3,col,dmg});b.swing=(Math.random()<0.5?-1:1)*side;}for(const b of bullets){if(b.swing){b.vx=b.swing*Math.sin((b.t||0)*6);}}},done(){return t>=dur;}};}
function patBeeStingers(dur=3.0,dmg=5,col='#ffd166',spd=320){let t=0,g=0,rate=.22;return{enter(){},update(dt){t+=dt;g+=dt;if(g>=rate){g=0;const left=Math.random()<0.5;const y=ARENA.y+rand(16,ARENA.h-16);const x=left?ARENA.x-24:ARENA.x+ARENA.w+24;spawn({x,y,vx:(left?1:-1)*spd,vy:0,r:4,col,dmg});}},done(){return t>=dur;}};}
function patHoneyDrip(dur=3.2,dmg=3,col='#ffea96',spd=210){let t=0,g=0,rate=.2;return{enter(){},update(dt){t+=dt;g+=dt;if(g>=rate){g=0;const cols=6, step=ARENA.w/(cols+1), i=1+Math.floor(Math.random()*cols);const x=ARENA.x+i*step+rand(-8,8);spawn({x,y:ARENA.y-18,vx:0,vy:spd,r:4,col,dmg});}},done(){return t>=dur;}};}
function patTrollArcs(dur=3.2,dmg=4,col='#fff',spd=230){let t=0,g=0,rate=.5;const c={x:ARENA.x+ARENA.w/2,y:ARENA.y+ARENA.h/2};return{enter(){},update(dt){t+=dt;g+=dt;if(g>=rate){g=0;const sh=rand(-0.2,0.2);for(const a of [-1.0+sh,-0.6+sh,0.6+sh,1.0+sh]) spawn({x:c.x,y:c.y,vx:Math.cos(a)*spd,vy:Math.sin(a)*spd,r:3,col,dmg});}},done(){return t>=dur;}};}
function patNyanSweep(dur=3.4,dmg=4,col='#cdeffd',spd=225){let t=0,g=0,rate=.24;return{enter(){},update(dt){t+=dt;g+=dt;if(g>=rate){g=0;const left=Math.random()<0.5, y=ARENA.y+rand(20,ARENA.h-20);spawn({x:left?ARENA.x-24:ARENA.x+ARENA.w+24,y, vx:(left?1:-1)*spd,vy:0,r:3,col,dmg});}},done(){return t>=dur;}};}
function patPepeCalm(dur=3.6,dmg=3,col='#bff7b5',spd=210){return patRing(dur,dmg,col,spd,10);}
function patGlitchSpiral(dur=3.4,dmg=5,col='#ff7a7a',spd=225){return patSpiralAim(dur,dmg,col,spd,3);}
function patHotRing(dur=3.2,dmg=5,col='#ff3b3b',spd=240){return patRing(dur,dmg,col,spd,12);}
/* Omega hard patterns (still fair) */
function patOmegaWall(dur=3.4,dmg=6,col='#fff3b8',spd=260){let t=0,g=0,rate=.28;return{enter(){},update(dt){t+=dt;g+=dt;if(g>=rate){g=0;const top=Math.random()<0.5;for(let i=0;i<6;i++){const x=ARENA.x+40+i*70;spawn({x,y:top?ARENA.y-16:ARENA.y+ARENA.h+16,vx:0,vy:top?spd:-spd,r:3,col,dmg});}}},done(){return t>=dur;}};}
function patOmegaAim(dur=3.2,dmg=6,col='#ffd166',spd=240){return patHoming(dur,dmg,col,spd);}

/* Boss roster (adminOnly marks secret) */
const BOSSES=[
  { key:'doge', name:'Doge Paladin', hpMax:320, draw:drawDoge,
    intro:["much honor","very duel"], lines:["such focus","wow","amaze stance","parry pls","many form"],
    mercyNeed:3,
    acts:[{name:'Compliment',effect:s=>{s.mercy=(s.mercy||0)+1;return"so kind. very wow.";}},
          {name:'Pet',effect:s=>{s.mercy=(s.mercy||0)+1;return"head pats accepted.";}},
          {name:'Bow',effect:s=>{s.mercy=(s.mercy||0)+1;return"respect returned.";}},
          {name:'Taunt',effect:s=>{return"rude. restraint holds.";}}],
    attacks:()=>[ {enter:()=>{},update:()=>{},done:()=>false}, // placeholder to allow ring start immediately
                  patDogeArcs(3.2,4,220), patRing(3.2,4,'#fff3b8',230,10), patHoming(3.0,4,'#fff3b8',230) ] },
  { key:'cheems', name:'Cheems Baker', hpMax:340, draw:drawCheems,
    intro:["bonk? bake.","sprinkle time."], lines:["cheems bake","yum… panic","frost ur fear","cherry go brr","nom nom"],
    mercyNeed:3,
    acts:[{name:'Taste Test',effect:s=>{s.mercy=(s.mercy||0)+1;return"approval granted. less sprinkles.";}},
          {name:'Compliment',effect:s=>{s.mercy=(s.mercy||0)+1;return"pink pride intensifies.";}},
          {name:'Joke',effect:s=>{s.mercy=(s.mercy||0)+1;return"hee hee. calm frosting.";}},
          {name:'Insult',effect:s=>{return"ouch. noted.";}}],
    attacks:()=>[ patCone(3.0,3,'#ffc6e0',205,5,Math.PI/3), patFalls(3.4,3,'#ffe3f2',215), patHoming(3.0,4,'#ffd0e8',230) ] },
  { key:'archon', name:'Bell Archon', hpMax:360, draw:drawBell,
    intro:["ding ding.","judgment comfy."], lines:["hold the note","resonate","no mald","center rings","gentle toll"],
    mercyNeed:2,
    acts:[{name:'Listen',effect:s=>{s.mercy=(s.mercy||0)+1;return"you hear the silence between.";}},
          {name:'Hum',effect:s=>{s.mercy=(s.mercy||0)+1;return"your pitch aligns.";}},
          {name:'Apologize',effect:s=>{s.mercy=(s.mercy||0)+1;return"forgiven. a little.";}},
          {name:'Mock',effect:s=>{return"discordant... but forgiven.";}}],
    attacks:()=>[ patRing(3.0,4,'#ffe799',235,12), patSpiralAim(3.4,4,'#ffd166',220,3), patHoming(3.0,4,'#fff3b8',230) ] },
  { key:'bee', name:'Baby Bee', hpMax:340, draw:drawBee,
    intro:["bzz... hello.","tiny but rapid."], lines:["bzz-bzz!","honey time.","sting operation.","follow me!","sweet and swift."],
    mercyNeed:3,
    acts:[{name:'Waggle',effect:s=>{s.mercy=(s.mercy||0)+1;return"you waggle a dance. bee approves.";}},
          {name:'Offer Honey',effect:s=>{s.mercy=(s.mercy||0)+2;return"bee sips happily.";}},
          {name:'Calm Buzz',effect:s=>{s.mercy=(s.mercy||0)+1;return"buzz softens.";}},
          {name:'Swat',effect:s=>{return"rude! bee pouts.";}}],
    attacks:()=>[ patBeeZigZag(3.2,3,'#ffe87a',240), patBeeStingers(3.0,5,'#ffd166',320), patHoneyDrip(3.2,3,'#ffea96',210) ] },
  { key:'shrek', name:'Swamp Lord Shrek', hpMax:360, draw:drawShrek,
    intro:["this is my swamp.","onions have layers."], lines:["get outta my swamp!","donkey?!","layer by layer.","mud heals.","roar."],
    mercyNeed:3,
    acts:[{name:'Compliment Ears',effect:s=>{s.mercy=(s.mercy||0)+1;return"he blushes, slightly.";}},{name:'Apologize',effect:s=>{s.mercy=(s.mercy||0)+1;return"...fine.";}},{name:'Joke',effect:s=>{s.mercy=(s.mercy||0)+1;return"hah! ok.";}},{name:'Insult Swamp',effect:s=>{return"bold of you.";} }],
    attacks:()=>[ patCone(3.0,3,'#b5ffb0',205,5,Math.PI/3), patFalls(3.2,3,'#c8f7c0',215), patHoming(3.0,4,'#bfffb0',230) ] },
  { key:'troll', name:'Trollface Jester', hpMax:340, draw:drawTroll,
    intro:["problem?","hehe."], lines:["u mad?","ez dodge",":^)","trololol","gotcha."],
    mercyNeed:3,
    acts:[{name:'Laugh',effect:s=>{s.mercy=(s.mercy||0)+1;return"he laughs back.";}},{name:'Compliment Grin',effect:s=>{s.mercy=(s.mercy||0)+1;return"so shiny.";}},{name:'Wave',effect:s=>{s.mercy=(s.mercy||0)+1;return"wave returned.";}},{name:'Taunt',effect:s=>{return"nice try.";} }],
    attacks:()=>[ patTrollArcs(3.2,4,'#fff',230), patHoming(3.0,4,'#f0f0f0',230), patRing(3.0,4,'#fff',230,8) ] },
  { key:'nyan', name:'Nyan Blade', hpMax:360, draw:drawNyan,
    intro:["nyan~","rainbow slash!"], lines:["nya!","sparkle cut","meow dodge","rainbow go","pop pop"],
    mercyNeed:3,
    acts:[{name:'Pet',effect:s=>{s.mercy=(s.mercy||0)+1;return"purr.";}},{name:'Compliment',effect:s=>{s.mercy=(s.mercy||0)+1;return"nya~";}},{name:'Sing',effect:s=>{s.mercy=(s.mercy||0)+1;return"duet time.";}},{name:'Insult',effect:s=>{return"hiss.";} }],
    attacks:()=>[ patCone(3.0,3,'#ffb6c1',205,5,Math.PI/3), patNyanSweep(3.2,4,'#cdeffd',225), patRing(3.2,4,'#fff',230,8) ] },
  { key:'pepe', name:'Pepe Sage', hpMax:380, draw:drawPepe,
    intro:["wisdom croaks.","breathe, child."], lines:["inhale… exhale","feel the pond","do not tilt","you can","ribbit."],
    mercyNeed:2,
    acts:[{name:'Listen',effect:s=>{s.mercy=(s.mercy||0)+1;return"silence shared.";}},
          {name:'Meditate',effect:s=>{s.mercy=(s.mercy||0)+1;return"calm spreads.";}},
          {name:'Nod',effect:s=>{s.mercy=(s.mercy||0)+1;return"understood.";}},
          {name:'Joke',effect:s=>{return"gentle smile.";} }],
    attacks:()=>[ patPepeCalm(3.2,3,'#bff7b5',210), patSpiralAim(3.2,4,'#a1e8af',215,3), patHoming(3.0,4,'#d7f5d0',225) ] },
  { key:'omega', name:'Omega Meme King', hpMax:520, draw:drawOmega,
    intro:["you reached the end.","prove your rhythm."], lines:["focus","commit","hold","flow","now"],
    mercyNeed:4,
    acts:[{name:'Focus',effect:s=>{s.mercy=(s.mercy||0)+1;return"the room steadies.";}},
          {name:'Resolve',effect:s=>{s.mercy=(s.mercy||0)+1;return"your core firms.";}},
          {name:'Breathe',effect:s=>{s.mercy=(s.mercy||0)+1;return"breath syncs.";}},
          {name:'Bow',effect:s=>{s.mercy=(s.mercy||0)+1;return"respect noted.";}}],
    attacks:()=>[ patOmegaWall(3.2,6,'#fff3b8',260), patOmegaAim(3.0,6,'#ffd166',240), patRing(3.2,5,'#fff3b8',240,14), patSpiralAim(3.4,5,'#ffd166',230,4) ] }
];

/* Admin-only secret */
const ADMIN_BOSSES=[
  { key:'skibidi', name:'67 Skibidi Demon (Admin)', hpMax:440, draw:drawSkibidi, adminOnly:true,
    intro:["the feed distorts.","the lens turns."], lines:["faster.","louder.","wrong note.","keep up.","again."],
    mercyNeed:4,
    acts:[{name:'Mute Feed',effect:s=>{s.mercy=(s.mercy||0)+1;return"signal dampened.";}},
          {name:'Pose',effect:s=>{s.mercy=(s.mercy||0)+1;return"it approves of the framing.";}},
          {name:'Wave',effect:s=>{s.mercy=(s.mercy||0)+1;return"acknowledged.";}},
          {name:'Boo',effect:s=>{return"distortion spikes.";}}],
    attacks:()=>[ patGlitchSpiral(3.2,5,'#ff7a7a',225), patHotRing(3.0,5,'#ff3b3b',240), patHoming(3.0,5,'#ffa0a0',235) ] }
];

/* Build admin list (progression bosses + admin-only) */
function buildAdminBossList(){
  adBoss.innerHTML='';
  BOSSES.forEach((b,i)=>{const o=document.createElement('option'); o.value='main:'+i; o.textContent=`${i+1}. ${b.name}`; adBoss.appendChild(o);});
  ADMIN_BOSSES.forEach((b,i)=>{const o=document.createElement('option'); o.value='admin:'+i; o.textContent=`[Admin] ${b.name}`; adBoss.appendChild(o);});
}

/* Flow */
function bossBar(){bossNameEl.textContent=BOSS.name; bossHPFill.style.width=(440*Math.max(0,BOSS.hp/BOSS.hpMax))+'px'; bossHPVal.textContent=`${BOSS.hp}/${BOSS.hpMax}`;}
function setBossFromObj(obj){ BOSS={ key:obj.key,name:obj.name,hpMax:obj.hpMax,hp:obj.hpMax,draw:obj.draw, intro:[...obj.intro],lines:[...obj.lines],mercyNeed:obj.mercyNeed,mercy:0, acts:obj.acts.map(a=>({name:a.name,effect:a.effect})), attacks:obj.attacks }; attackSeq=BOSS.attacks(); attackIx=0; bossBar(); saveProgress(); }
function setBoss(ix){ bossIndex=Math.max(0,Math.min(BOSSES.length-1, parseInt(ix,10)||0)); setBossFromObj(BOSSES[bossIndex]); }
function initBoss(sel){
  if(typeof sel==='string' && sel.startsWith('admin:')){ const idx=parseInt(sel.split(':')[1],10)||0; setBossFromObj(ADMIN_BOSSES[idx]); }
  else setBoss(typeof sel==='number'?sel:bossIndex);
  HEART.hp=HEART.hpMax=Math.max(1,SAVE.hp||50); tempBuff.atk=0; updateHP(); HEART.i=0; centerHeart();
  turn=TURN.PLAYER; mode='main'; showArena=false; boxEl.style.display='none'; uiBar.classList.remove('hidden');
  say((BOSS.intro||[]).join('\n'));
}

/* Movement (enemy turn only) */
function processMovement(dt){
  if(turn!==TURN.ENEMY || mode!=='main') return;
  let dx=0,dy=0; if(key('ArrowLeft')||key('a'))dx-=1; if(key('ArrowRight')||key('d'))dx+=1; if(key('ArrowUp')||key('w'))dy-=1; if(key('ArrowDown')||key('s'))dy+=1;
  const L=Math.hypot(dx,dy)||1;
  HEART.x=Math.max(ARENA.x+HEART.r,Math.min(ARENA.x+ARENA.w-HEART.r, HEART.x+dx/L*HEART.sp*dt));
  HEART.y=Math.max(ARENA.y+HEART.r,Math.min(ARENA.y+ARENA.h-HEART.r, HEART.y+dy/L*HEART.sp*dt));
  HEART._pdt=dt; HEART._px=HEART.x; HEART._py=HEART.y;
}

/* Bullets/collisions */
function updateBullets(dt){
  for(let i=0;i<bullets.length;i++){const b=bullets[i]; b.t=(b.t||0)+dt; b.x+=b.vx*dt; b.y+=b.vy*dt;}
  bullets=bullets.filter(b=>isFinite(b.x)&&isFinite(b.y)&&b.x>ARENA.x-200&&b.x<ARENA.x+ARENA.w+200&&b.y>ARENA.y-200&&b.y<ARENA.y+ARENA.h+220);
}
function collide(){
  if(HEART.i>0) return;
  for(const b of bullets){
    const dx=b.x-HEART.x, dy=b.y-HEART.y, rr=(b.r||4)+HEART.r;
    if(dx*dx+dy*dy<=rr*rr){ const dmg=Math.max(1,Math.floor(b.dmg||3)); HEART.hp=Math.max(0,HEART.hp-dmg); updateHP(); HEART.i=0.85; break; }
  }
}

/* Attack lifecycle */
function startAttack(){ bullets.length=0; showArena=true; boxEl.style.display='block'; attack=attackSeq[attackIx]; attackIx=(attackIx+1)%attackSeq.length; if(attack&&attack.enter) attack.enter(); }
function finishAttack(){ showArena=false; boxEl.style.display='none'; uiBar.classList.remove('hidden'); turn=TURN.PLAYER; mode='main'; say(BOSS.lines[(Math.floor(time*3))%(BOSS.lines.length||1)]||'...'); attack=null; }

/* Combat */
function bossHit(dmg){ BOSS.hp=Math.max(0,BOSS.hp-dmg); bossBar(); damagePopup={x:480,y:200,t:0,text:String(dmg)}; }
function playerFight(){ if(turn!==TURN.PLAYER||mode!=='main') return; const dmg=24+(tempBuff.atk||0); routeState.fight++; saveProgress(); say(`${username} strikes for ${dmg}.`); bossHit(dmg); endPlayerTurn(); }

/* ACT/MERCY/ITEM */
function openAct(){ if(turn!==TURN.PLAYER||mode!=='main') return; mode='act'; const opts=BOSS.acts.map((a,i)=>` ${i+1}. ${a.name}`).join('\n'); say(`ACT on ${BOSS.name}:\n${opts}`,true); }
function handleActChoice(i){ const a=BOSS.acts[i||0]; if(!a){ say('No such act.'); return; } const line=a.effect(BOSS); routeState.act++; saveProgress(); say(line); if((BOSS.mercy||0)>=BOSS.mercyNeed) say(`${BOSS.name} seems ready to be spared.`); mode='main'; endPlayerTurn(); }
function openMercy(){ if(BOSS.mercy>=BOSS.mercyNeed){ routeState.mercy++; saveProgress(); victory(true);} else say(`${BOSS.name} isn't ready to be spared.`); }
function openItem(){ if(turn!==TURN.PLAYER||mode!=='main') return; mode='item'; say(`ITEMS:\n${itemsList()}\n\nPick with 1-4`,true); }
function handleItemChoice(i){ const msg=useItem(i); say(msg); mode='main'; endPlayerTurn(); }

/* Turns */
function endPlayerTurn(){ if(turn!==TURN.PLAYER) return; turn=TURN.TRANS; setTimeout(()=>{ if(turn!==TURN.TRANS) return; turn=TURN.ENEMY; uiCenter.textContent='Enemy turn'; uiBar.classList.add('hidden'); hideSay(); startAttack(); },140); }
function defeat(){ if(turn===TURN.DEFEAT) return; turn=TURN.DEFEAT; say('You fall. The hall dims.'); setTimeout(()=>initBoss(bossIndex),900); }
function victory(spared=false){
  if(turn===TURN.VICTORY) return; turn=TURN.VICTORY;
  const r=routeLean(); const rw=rewardForRoute(spared?'pacifist':r); giveItem(rw);
  say(`${spared?'You spared':'You defeated'} ${BOSS.name}. (${r.toUpperCase()} leaning)\nGained: ${rw.name}`);
  setTimeout(()=>{ // normal progression excludes admin-only bosses
    const next = bossIndex+1;
    if(next < BOSSES.length){ initBoss(next); }
    else { say(r==='pacifist'?'Ending: Peace blooms.':'Ending: You carried your choices.'); setTimeout(()=>initBoss(0),1500); }
  },1000);
}

/* Admin */
function openAdmin(){ admin.style.display='flex'; buildAdminBossList(); adBoss.value='main:'+bossIndex; adUser.value=username; adHP.value=String(HEART.hpMax); }
function closeAdmin(){ admin.style.display='none'; saveProgress(); }
adUserSave.onclick=()=>{ username=(adUser.value||'Traveler').slice(0,16); nameLabel.textContent=username; saveProgress(); };
adHeal.onclick=()=>{ HEART.hp=HEART.hpMax; updateHP(); };
adSkip.onclick=()=>{ closeAdmin(); if(bossIndex+1<BOSSES.length) initBoss(bossIndex+1); else initBoss(0); };
adReset.onclick=()=>{ localStorage.removeItem(SAVE_KEY); SAVE={}; inventory=[{id:'dew',name:'Dew Petal',desc:'+12 HP',type:'heal',amount:12,count:2}]; username='Traveler'; nameLabel.textContent=username; closeAdmin(); initBoss(0); };
adClose.onclick=()=> closeAdmin();
adBoss.onchange=()=>{ const v=adBoss.value; closeAdmin(); if(v.startsWith('admin:')) initBoss(v); else initBoss(parseInt(v.split(':')[1],10)||0); };
adHP.onchange=()=>{ let v=parseInt(adHP.value,10)||50; v=Math.max(1,Math.min(99,v)); HEART.hpMax=v; HEART.hp=v; updateHP(); saveProgress(); };

/* UI clicks */
uiMenu.addEventListener('click',e=>{
  const btn=e.target.closest('.uiBtn'); if(!btn) return;
  const act=btn.dataset.act;
  if(turn!==TURN.PLAYER||mode!=='main'){ if(act==='MERCY') openMercy(); return; }
  if(act==='FIGHT') playerFight(); else if(act==='ACT') openAct(); else if(act==='ITEM') openItem(); else if(act==='MERCY') openMercy();
});

/* Keyboard shortcuts */
addEventListener('keydown',e=>{
  if(turn!==TURN.PLAYER) return;
  if(mode==='main'){
    if(e.key==='z'||e.key==='Z'||e.key==='Enter') playerFight();
    if(e.key==='a'||e.key==='A') openAct();
    if(e.key==='i'||e.key==='I') openItem();
    if(e.key==='m'||e.key==='M') openMercy();
  }
});

/* Loop */
let last=performance.now();
function loop(now){
  const dt=Math.min(0.033, Math.max(0,(now-last)/1000)); last=now;
  secretCooldown=Math.max(0, secretCooldown-1);
  if(!paused){ update(dt); render(dt); }
  requestAnimationFrame(loop);
}
requestAnimationFrame(loop);

/* Update/Render */
function update(dt){
  time+=dt; HEART.i=Math.max(0,HEART.i-dt);
  if(turn===TURN.ENEMY){
    processMovement(dt);
    if(attack&&attack.update) attack.update(dt);
    updateBullets(dt);
    collide();
    if(attack&&attack.done&&attack.done()) finishAttack();
    if(HEART.hp<=0) defeat();
  }
  if(turn!==TURN.VICTORY && turn!==TURN.DEFEAT && BOSS && BOSS.hp<=0) victory(false);
  if(damagePopup){ damagePopup.t+=dt; if(damagePopup.t>0.9) damagePopup=null; }
}
function render(dt){
  ctx.fillStyle='#08070a'; ctx.fillRect(0,0,960,720);
  ctx.fillStyle='#141018'; for(let i=0;i<96;i++){const x=(i*97)%960, y=(i*151)%720; ctx.fillRect(x,y,2,2);}
  if(BOSS && typeof BOSS.draw==='function') BOSS.draw(ctx,time,0);
  if(turn===TURN.ENEMY && showArena){
    ctx.strokeStyle='#ffffff'; ctx.lineWidth=3; ctx.strokeRect(ARENA.x,ARENA.y,ARENA.w,ARENA.h);
    for(const b of bullets){ ctx.fillStyle=b.col||'#fff'; ctx.beginPath(); ctx.arc(b.x,b.y,b.r||4,0,Math.PI*2); ctx.fill(); }
    ctx.save(); if(HEART.i>0) ctx.globalAlpha=0.6+0.3*Math.sin(time*20);
    drawHeart(ctx,HEART.x-6,HEART.y-6,'#ffd166',0.8);
    ctx.restore();
  }
  if(damagePopup){ const a=Math.max(0,1-damagePopup.t/0.9); ctx.save(); ctx.globalAlpha=a; ctx.fillStyle='#fff1b6'; ctx.font='16px monospace'; ctx.fillText(damagePopup.text,damagePopup.x,damagePopup.y-damagePopup.t*60); ctx.restore(); }
}

/* Start */
initBoss(bossIndex);
updateHP();
</script>
</body>
</html>
